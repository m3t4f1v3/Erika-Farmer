import { ShardState } from "./types.ts";
export async function connect(shard) {
    if (![ShardState.Identifying, ShardState.Resuming].includes(shard.state)) {
        shard.state = ShardState.Connecting;
    }
    shard.events.connecting?.(shard);
    const socket = new WebSocket(`${shard.gatewayConfig.url}/?v=${shard.gatewayConfig.version}&encoding=json`);
    shard.socket = socket;
    socket.onerror = (event) => console.log({ error: event });
    socket.onclose = (event) => shard.handleClose(event);
    socket.onmessage = (message) => shard.handleMessage(message);
    return new Promise((resolve) => {
        socket.onopen = () => {
            if (![ShardState.Identifying, ShardState.Resuming].includes(shard.state)) {
                shard.state = ShardState.Unidentified;
            }
            shard.events.connected?.(shard);
            resolve();
        };
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbm5lY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFTLFVBQVUsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUUvQyxNQUFNLENBQUMsS0FBSyxVQUFVLE9BQU8sQ0FBQyxLQUFZO0lBR3hDLElBQUksQ0FBQyxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDeEUsS0FBSyxDQUFDLEtBQUssR0FBRyxVQUFVLENBQUMsVUFBVSxDQUFDO0tBQ3JDO0lBQ0QsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUdqQyxNQUFNLE1BQU0sR0FBRyxJQUFJLFNBQVMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUMsR0FBRyxPQUFPLEtBQUssQ0FBQyxhQUFhLENBQUMsT0FBTyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQzNHLEtBQUssQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO0lBR3RCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUUxRCxNQUFNLENBQUMsT0FBTyxHQUFHLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRXJELE1BQU0sQ0FBQyxTQUFTLEdBQUcsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFN0QsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQzdCLE1BQU0sQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFO1lBR25CLElBQUksQ0FBQyxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQ3hFLEtBQUssQ0FBQyxLQUFLLEdBQUcsVUFBVSxDQUFDLFlBQVksQ0FBQzthQUN2QztZQUNELEtBQUssQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFaEMsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDLENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTaGFyZCwgU2hhcmRTdGF0ZSB9IGZyb20gXCIuL3R5cGVzLnRzXCI7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjb25uZWN0KHNoYXJkOiBTaGFyZCk6IFByb21pc2U8dm9pZD4ge1xuICAvLyBPbmx5IHNldCB0aGUgc2hhcmQgdG8gYENvbm5lY3RpbmdgIHN0YXRlLFxuICAvLyBpZiB0aGUgY29ubmVjdGlvbiByZXF1ZXN0IGRvZXMgbm90IGNvbWUgZnJvbSBhbiBpZGVudGlmeSBvciByZXN1bWUgYWN0aW9uLlxuICBpZiAoIVtTaGFyZFN0YXRlLklkZW50aWZ5aW5nLCBTaGFyZFN0YXRlLlJlc3VtaW5nXS5pbmNsdWRlcyhzaGFyZC5zdGF0ZSkpIHtcbiAgICBzaGFyZC5zdGF0ZSA9IFNoYXJkU3RhdGUuQ29ubmVjdGluZztcbiAgfVxuICBzaGFyZC5ldmVudHMuY29ubmVjdGluZz8uKHNoYXJkKTtcblxuICAvLyBFeHBsaWNpdGx5IHNldHRpbmcgdGhlIGVuY29kaW5nIHRvIGpzb24sIHNpbmNlIHdlIGRvIG5vdCBzdXBwb3J0IEVURi5cbiAgY29uc3Qgc29ja2V0ID0gbmV3IFdlYlNvY2tldChgJHtzaGFyZC5nYXRld2F5Q29uZmlnLnVybH0vP3Y9JHtzaGFyZC5nYXRld2F5Q29uZmlnLnZlcnNpb259JmVuY29kaW5nPWpzb25gKTtcbiAgc2hhcmQuc29ja2V0ID0gc29ja2V0O1xuXG4gIC8vIFRPRE86IHByb3BlciBldmVudCBoYW5kbGluZ1xuICBzb2NrZXQub25lcnJvciA9IChldmVudCkgPT4gY29uc29sZS5sb2coeyBlcnJvcjogZXZlbnQgfSk7XG5cbiAgc29ja2V0Lm9uY2xvc2UgPSAoZXZlbnQpID0+IHNoYXJkLmhhbmRsZUNsb3NlKGV2ZW50KTtcblxuICBzb2NrZXQub25tZXNzYWdlID0gKG1lc3NhZ2UpID0+IHNoYXJkLmhhbmRsZU1lc3NhZ2UobWVzc2FnZSk7XG5cbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgc29ja2V0Lm9ub3BlbiA9ICgpID0+IHtcbiAgICAgIC8vIE9ubHkgc2V0IHRoZSBzaGFyZCB0byBgVW5pZGVudGlmaWVkYCBzdGF0ZSxcbiAgICAgIC8vIGlmIHRoZSBjb25uZWN0aW9uIHJlcXVlc3QgZG9lcyBub3QgY29tZSBmcm9tIGFuIGlkZW50aWZ5IG9yIHJlc3VtZSBhY3Rpb24uXG4gICAgICBpZiAoIVtTaGFyZFN0YXRlLklkZW50aWZ5aW5nLCBTaGFyZFN0YXRlLlJlc3VtaW5nXS5pbmNsdWRlcyhzaGFyZC5zdGF0ZSkpIHtcbiAgICAgICAgc2hhcmQuc3RhdGUgPSBTaGFyZFN0YXRlLlVuaWRlbnRpZmllZDtcbiAgICAgIH1cbiAgICAgIHNoYXJkLmV2ZW50cy5jb25uZWN0ZWQ/LihzaGFyZCk7XG5cbiAgICAgIHJlc29sdmUoKTtcbiAgICB9O1xuICB9KTtcbn1cbiJdfQ==