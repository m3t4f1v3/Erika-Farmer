import { Collection } from "./deps.ts";
import { setupCacheRemovals } from "./src/setupCacheRemovals.ts";
import { addCacheCollections } from "./src/addCacheCollections.ts";
import { setupCacheEdits } from "./src/setupCacheEdits.ts";
export function enableCachePlugin(rawBot) {
    rawBot.enabledPlugins.add("CACHE");
    const bot = addCacheCollections(rawBot);
    const { guild, user, member, channel, message, presence, role } = bot.transformers;
    bot.transformers.guild = function (_, payload) {
        const result = guild(bot, payload);
        if (result) {
            bot.guilds.set(result.id, result);
            const channels = payload.guild.channels || [];
            channels.forEach((channel) => {
                bot.transformers.channel(bot, { channel, guildId: result.id });
            });
        }
        return result;
    };
    bot.transformers.user = function (...args) {
        const result = user(...args);
        if (result) {
            bot.users.set(result.id, result);
        }
        return result;
    };
    bot.transformers.member = function (...args) {
        const result = member(...args);
        if (result) {
            bot.members.set(bot.transformers.snowflake(`${result.id}${result.guildId}`), result);
        }
        return result;
    };
    bot.transformers.channel = function (...args) {
        const result = channel(...args);
        if (result) {
            bot.channels.set(result.id, result);
        }
        return result;
    };
    bot.transformers.message = function (_, payload) {
        const result = message(bot, payload);
        if (result) {
            bot.messages.set(result.id, result);
            const user = bot.transformers.user(bot, payload.author);
            bot.users.set(user.id, user);
            if (payload.guild_id && payload.member) {
                const guildId = bot.transformers.snowflake(payload.guild_id);
                bot.members.set(bot.transformers.snowflake(`${payload.author.id}${payload.guild_id}`), bot.transformers.member(bot, payload.member, guildId, user.id));
            }
        }
        return result;
    };
    bot.transformers.presence = function (...args) {
        const result = presence(...args);
        if (result) {
            bot.presences.set(result.user.id, result);
        }
        return result;
    };
    bot.transformers.role = function (...args) {
        const result = role(...args);
        if (result) {
            bot.guilds.get(result.guildId)?.roles.set(result.id, result);
        }
        return result;
    };
    const { GUILD_EMOJIS_UPDATE } = bot.handlers;
    bot.handlers.GUILD_EMOJIS_UPDATE = function (_, data, shardId) {
        const payload = data.d;
        const guild = bot.guilds.get(bot.transformers.snowflake(payload.guild_id));
        if (guild) {
            guild.emojis = new Collection(payload.emojis.map((e) => {
                const emoji = bot.transformers.emoji(bot, e);
                return [emoji.id, emoji];
            }));
        }
        GUILD_EMOJIS_UPDATE(bot, data, shardId);
    };
    setupCacheRemovals(bot);
    setupCacheEdits(bot);
    return bot;
}
export default enableCachePlugin;
export * from "./src/addCacheCollections.ts";
export * from "./src/dispatchRequirements.ts";
export * from "./src/setupCacheEdits.ts";
export * from "./src/setupCacheRemovals.ts";
export * from "./src/sweepers.ts";
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibW9kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBTyxVQUFVLEVBQTRCLE1BQU0sV0FBVyxDQUFDO0FBQ3RFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxtQkFBbUIsRUFBZ0IsTUFBTSw4QkFBOEIsQ0FBQztBQUNqRixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFHM0QsTUFBTSxVQUFVLGlCQUFpQixDQUFzQixNQUFTO0lBRTlELE1BQU0sQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBR25DLE1BQU0sR0FBRyxHQUFHLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBR3hDLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsR0FBRyxHQUFHLENBQUMsWUFBWSxDQUFDO0lBRW5GLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxHQUFHLFVBQVUsQ0FBQyxFQUFFLE9BQU87UUFFM0MsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUVuQyxJQUFJLE1BQU0sRUFBRTtZQUNWLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFFbEMsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxRQUFRLElBQUksRUFBRSxDQUFDO1lBRTlDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDM0IsR0FBRyxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMs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R0FBRyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztJQUMxQyxDQUFDLENBQUM7SUFFRixrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN4QixlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7SUFHckIsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDO0FBRUQsZUFBZSxpQkFBaUIsQ0FBQztBQUNqQyxjQUFjLDhCQUE4QixDQUFDO0FBQzdDLGNBQWMsK0JBQStCLENBQUM7QUFDOUMsY0FBYywwQkFBMEIsQ0FBQztBQUN6QyxjQUFjLDZCQUE2QixDQUFDO0FBQzVDLGNBQWMsbUJBQW1CLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCb3QsIENvbGxlY3Rpb24sIERpc2NvcmRHdWlsZEVtb2ppc1VwZGF0ZSB9IGZyb20gXCIuL2RlcHMudHNcIjtcbmltcG9ydCB7IHNldHVwQ2FjaGVSZW1vdmFscyB9IGZyb20gXCIuL3NyYy9zZXR1cENhY2hlUmVtb3ZhbHMudHNcIjtcbmltcG9ydCB7IGFkZENhY2hlQ29sbGVjdGlvbnMsIEJvdFdpdGhDYWNoZSB9IGZyb20gXCIuL3NyYy9hZGRDYWNoZUNvbGxlY3Rpb25zLnRzXCI7XG5pbXBvcnQgeyBzZXR1cENhY2hlRWRpdHMgfSBmcm9tIFwiLi9zcmMvc2V0dXBDYWNoZUVkaXRzLnRzXCI7XG5cbi8vIFBMVUdJTlMgTVVTVCBUQUtFIEEgQk9UIEFSR1VNRU5UIFdISUNIIFdJTEwgQkUgTU9ESUZJRURcbmV4cG9ydCBmdW5jdGlvbiBlbmFibGVDYWNoZVBsdWdpbjxCIGV4dGVuZHMgQm90ID0gQm90PihyYXdCb3Q6IEIpOiBCb3RXaXRoQ2FjaGU8Qj4ge1xuICAvLyBNQVJLIFRISVMgUExVR0lOIEJFSU5HIFVTRURcbiAgcmF3Qm90LmVuYWJsZWRQbHVnaW5zLmFkZChcIkNBQ0hFXCIpO1xuXG4gIC8vIENVU1RPTUlaQVRJT04gR09FUyBIRVJFXG4gIGNvbnN0IGJvdCA9IGFkZENhY2hlQ29sbGVjdGlvbnMocmF3Qm90KTtcblxuICAvLyBHZXQgdGhlIHVubW9kaWZpZWQgdHJhbnNmb3JtZXIuXG4gIGNvbnN0IHsgZ3VpbGQsIHVzZXIsIG1lbWJlciwgY2hhbm5lbCwgbWVzc2FnZSwgcHJlc2VuY2UsIHJvbGUgfSA9IGJvdC50cmFuc2Zvcm1lcnM7XG4gIC8vIE92ZXJyaWRlIHRoZSB0cmFuc2Zvcm1lclxuICBib3QudHJhbnNmb3JtZXJzLmd1aWxkID0gZnVuY3Rpb24gKF8sIHBheWxvYWQpIHtcbiAgICAvLyBSdW4gdGhlIHVubW9kaWZpZWQgdHJhbnNmb3JtZXJcbiAgICBjb25zdCByZXN1bHQgPSBndWlsZChib3QsIHBheWxvYWQpO1xuICAgIC8vIENhY2hlIHRoZSByZXN1bHRcbiAgICBpZiAocmVzdWx0KSB7XG4gICAgICBib3QuZ3VpbGRzLnNldChyZXN1bHQuaWQsIHJlc3VsdCk7XG5cbiAgICAgIGNvbnN0IGNoYW5uZWxzID0gcGF5bG9hZC5ndWlsZC5jaGFubmVscyB8fCBbXTtcblxuICAgICAgY2hhbm5lbHMuZm9yRWFjaCgoY2hhbm5lbCkgPT4ge1xuICAgICAgICBib3QudHJhbnNmb3JtZXJzLmNoYW5uZWwoYm90LCB7IGNoYW5uZWwsIGd1aWxkSWQ6IHJlc3VsdC5pZCB9KTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIFJldHVybiB0aGUgcmVzdWx0XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfTtcblxuICAvLyBPdmVycmlkZSB0aGUgdHJhbnNmb3JtZXJcbiAgYm90LnRyYW5zZm9ybWVycy51c2VyID0gZnVuY3Rpb24gKC4uLmFyZ3MpIHtcbiAgICAvLyBSdW4gdGhlIHVubW9kaWZpZWQgdHJhbnNmb3JtZXJcbiAgICBjb25zdCByZXN1bHQgPSB1c2VyKC4uLmFyZ3MpO1xuICAgIC8vIENhY2hlIHRoZSByZXN1bHRcbiAgICBpZiAocmVzdWx0KSB7XG4gICAgICBib3QudXNlcnMuc2V0KHJlc3VsdC5pZCwgcmVzdWx0KTtcbiAgICB9XG4gICAgLy8gUmV0dXJuIHRoZSByZXN1bHRcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuXG4gIC8vIE92ZXJyaWRlIHRoZSB0cmFuc2Zvcm1lclxuICBib3QudHJhbnNmb3JtZXJzLm1lbWJlciA9IGZ1bmN0aW9uICguLi5hcmdzKSB7XG4gICAgLy8gUnVuIHRoZSB1bm1vZGlmaWVkIHRyYW5zZm9ybWVyXG4gICAgY29uc3QgcmVzdWx0ID0gbWVtYmVyKC4uLmFyZ3MpO1xuICAgIC8vIENhY2hlIHRoZSByZXN1bHRcbiAgICBpZiAocmVzdWx0KSB7XG4gICAgICBib3QubWVtYmVycy5zZXQoXG4gICAgICAgIGJvdC50cmFuc2Zvcm1lcnMuc25vd2ZsYWtlKGAke3Jlc3VsdC5pZH0ke3Jlc3VsdC5ndWlsZElkfWApLFxuICAgICAgICByZXN1bHQsXG4gICAgICApO1xuICAgIH1cbiAgICAvLyBSZXR1cm4gdGhlIHJlc3VsdFxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgLy8gT3ZlcnJpZGUgdGhlIHRyYW5zZm9ybWVyXG4gIGJvdC50cmFuc2Zvcm1lcnMuY2hhbm5lbCA9IGZ1bmN0aW9uICguLi5hcmdzKSB7XG4gICAgLy8gUnVuIHRoZSB1bm1vZGlmaWVkIHRyYW5zZm9ybWVyXG4gICAgY29uc3QgcmVzdWx0ID0gY2hhbm5lbCguLi5hcmdzKTtcbiAgICAvLyBDYWNoZSB0aGUgcmVzdWx0XG4gICAgaWYgKHJlc3VsdCkge1xuICAgICAgYm90LmNoYW5uZWxzLnNldChyZXN1bHQuaWQsIHJlc3VsdCk7XG4gICAgfVxuICAgIC8vIFJldHVybiB0aGUgcmVzdWx0XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfTtcblxuICAvLyBPdmVycmlkZSB0aGUgdHJhbnNmb3JtZXJcbiAgYm90LnRyYW5zZm9ybWVycy5tZXNzYWdlID0gZnVuY3Rpb24gKF8sIHBheWxvYWQpIHtcbiAgICAvLyBSdW4gdGhlIHVubW9kaWZpZWQgdHJhbnNmb3JtZXJcbiAgICBjb25zdCByZXN1bHQgPSBtZXNzYWdlKGJvdCwgcGF5bG9hZCk7XG4gICAgLy8gQ2FjaGUgdGhlIHJlc3VsdFxuICAgIGlmIChyZXN1bHQpIHtcbiAgICAgIGJvdC5tZXNzYWdlcy5zZXQocmVzdWx0LmlkLCByZXN1bHQpO1xuICAgICAgLy8gQ0FDSEUgVEhFIFVTRVJcbiAgICAgIGNvbnN0IHVzZXIgPSBib3QudHJhbnNmb3JtZXJzLnVzZXIoYm90LCBwYXlsb2FkLmF1dGhvcik7XG4gICAgICBib3QudXNlcnMuc2V0KHVzZXIuaWQsIHVzZXIpO1xuXG4gICAgICBpZiAocGF5bG9hZC5ndWlsZF9pZCAmJiBwYXlsb2FkLm1lbWJlcikge1xuICAgICAgICBjb25zdCBndWlsZElkID0gYm90LnRyYW5zZm9ybWVycy5zbm93Zmxha2UocGF5bG9hZC5ndWlsZF9pZCk7XG4gICAgICAgIC8vIENBQ0hFIFRIRSBNRU1CRVJcbiAgICAgICAgYm90Lm1lbWJlcnMuc2V0KFxuICAgICAgICAgIGJvdC50cmFuc2Zvcm1lcnMuc25vd2ZsYWtlKGAke3BheWxvYWQuYXV0aG9yLmlkfSR7cGF5bG9hZC5ndWlsZF9pZH1gKSxcbiAgICAgICAgICBib3QudHJhbnNmb3JtZXJzLm1lbWJlcihib3QsIHBheWxvYWQubWVtYmVyLCBndWlsZElkLCB1c2VyLmlkKSxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBSZXR1cm4gdGhlIHJlc3VsdFxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgLy8gT3ZlcnJpZGUgdGhlIHRyYW5zZm9ybWVyXG4gIGJvdC50cmFuc2Zvcm1lcnMucHJlc2VuY2UgPSBmdW5jdGlvbiAoLi4uYXJncykge1xuICAgIC8vIFJ1biB0aGUgdW5tb2RpZmllZCB0cmFuc2Zvcm1lclxuICAgIGNvbnN0IHJlc3VsdCA9IHByZXNlbmNlKC4uLmFyZ3MpO1xuICAgIC8vIENhY2hlIHRoZSByZXN1bHRcbiAgICBpZiAocmVzdWx0KSB7XG4gICAgICBib3QucHJlc2VuY2VzLnNldChyZXN1bHQudXNlci5pZCwgcmVzdWx0KTtcbiAgICB9XG4gICAgLy8gUmV0dXJuIHRoZSByZXN1bHRcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuXG4gIC8vIE92ZXJyaWRlIHRoZSB0cmFuc2Zvcm1lclxuICBib3QudHJhbnNmb3JtZXJzLnJvbGUgPSBmdW5jdGlvbiAoLi4uYXJncykge1xuICAgIC8vIFJ1biB0aGUgdW5tb2RpZmllZCB0cmFuc2Zvcm1lclxuICAgIGNvbnN0IHJlc3VsdCA9IHJvbGUoLi4uYXJncyk7XG4gICAgLy8gQ2FjaGUgdGhlIHJlc3VsdFxuICAgIGlmIChyZXN1bHQpIHtcbiAgICAgIGJvdC5ndWlsZHMuZ2V0KHJlc3VsdC5ndWlsZElkKT8ucm9sZXMuc2V0KHJlc3VsdC5pZCwgcmVzdWx0KTtcbiAgICB9XG4gICAgLy8gUmV0dXJuIHRoZSByZXN1bHRcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuXG4gIGNvbnN0IHsgR1VJTERfRU1PSklTX1VQREFURSB9ID0gYm90LmhhbmRsZXJzO1xuICBib3QuaGFuZGxlcnMuR1VJTERfRU1PSklTX1VQREFURSA9IGZ1bmN0aW9uIChfLCBkYXRhLCBzaGFyZElkKSB7XG4gICAgY29uc3QgcGF5bG9hZCA9IGRhdGEuZCBhcyBEaXNjb3JkR3VpbGRFbW9qaXNVcGRhdGU7XG5cbiAgICBjb25zdCBndWlsZCA9IGJvdC5ndWlsZHMuZ2V0KGJvdC50cmFuc2Zvcm1lcnMuc25vd2ZsYWtlKHBheWxvYWQuZ3VpbGRfaWQpKTtcbiAgICBpZiAoZ3VpbGQpIHtcbiAgICAgIGd1aWxkLmVtb2ppcyA9IG5ldyBDb2xsZWN0aW9uKHBheWxvYWQuZW1vamlzLm1hcCgoZSkgPT4ge1xuICAgICAgICBjb25zdCBlbW9qaSA9IGJvdC50cmFuc2Zvcm1lcnMuZW1vamkoYm90LCBlKTtcbiAgICAgICAgcmV0dXJuIFtlbW9qaS5pZCEsIGVtb2ppXTtcbiAgICAgIH0pKTtcbiAgICB9XG5cbiAgICBHVUlMRF9FTU9KSVNfVVBEQVRFKGJvdCwgZGF0YSwgc2hhcmRJZCk7XG4gIH07XG5cbiAgc2V0dXBDYWNoZVJlbW92YWxzKGJvdCk7XG4gIHNldHVwQ2FjaGVFZGl0cyhib3QpO1xuXG4gIC8vIFBMVUdJTlMgTVVTVCBSRVRVUk4gVEhFIEJPVFxuICByZXR1cm4gYm90O1xufVxuXG5leHBvcnQgZGVmYXVsdCBlbmFibGVDYWNoZVBsdWdpbjtcbmV4cG9ydCAqIGZyb20gXCIuL3NyYy9hZGRDYWNoZUNvbGxlY3Rpb25zLnRzXCI7XG5leHBvcnQgKiBmcm9tIFwiLi9zcmMvZGlzcGF0Y2hSZXF1aXJlbWVudHMudHNcIjtcbmV4cG9ydCAqIGZyb20gXCIuL3NyYy9zZXR1cENhY2hlRWRpdHMudHNcIjtcbmV4cG9ydCAqIGZyb20gXCIuL3NyYy9zZXR1cENhY2hlUmVtb3ZhbHMudHNcIjtcbmV4cG9ydCAqIGZyb20gXCIuL3NyYy9zd2VlcGVycy50c1wiO1xuIl19