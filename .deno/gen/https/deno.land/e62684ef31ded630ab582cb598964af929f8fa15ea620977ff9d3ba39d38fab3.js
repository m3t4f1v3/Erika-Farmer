import { AllowedMentionsTypes, ChannelTypes } from "../../deps.ts";
import { validateComponents } from "../components.ts";
import { requireBotChannelPermissions } from "../permissions.ts";
export function sendMessage(bot) {
    const sendMessageOld = bot.helpers.sendMessage;
    bot.helpers.sendMessage = async function (channelId, content) {
        if (typeof content === "string") {
            throw new Error("TODO");
        }
        const channel = bot.channels.get(channelId);
        if (channel &&
            [
                ChannelTypes.GuildCategory,
                ChannelTypes.GuildStageVoice,
                ChannelTypes.GuildForum,
            ].includes(channel.type)) {
            throw new Error(`Can not send message to a channel of this type. Channel ID: ${channelId}`);
        }
        if (content.content &&
            !bot.utils.validateLength(content.content, { max: 2000 })) {
            throw new Error("The content should not exceed 2000 characters.");
        }
        if (content.allowedMentions) {
            if (content.allowedMentions.users?.length) {
                if (content.allowedMentions.parse?.includes(AllowedMentionsTypes.UserMentions)) {
                    content.allowedMentions.parse = content.allowedMentions.parse.filter((p) => p !== "users");
                }
                if (content.allowedMentions.users.length > 100) {
                    content.allowedMentions.users = content.allowedMentions.users.slice(0, 100);
                }
            }
            if (content.allowedMentions.roles?.length) {
                if (content.allowedMentions.parse?.includes(AllowedMentionsTypes.RoleMentions)) {
                    content.allowedMentions.parse = content.allowedMentions.parse.filter((p) => p !== "roles");
                }
                if (content.allowedMentions.roles.length > 100) {
                    content.allowedMentions.roles = content.allowedMentions.roles.slice(0, 100);
                }
            }
        }
        if (content.components) {
            validateComponents(bot, content.components);
        }
        if (channel) {
            const requiredPerms = [];
            if (channel.guildId) {
                requiredPerms.push("SEND_MESSAGES");
            }
            if (content.tts)
                requiredPerms.push("SEND_TTS_MESSAGES");
            if (content.messageReference)
                requiredPerms.push("READ_MESSAGE_HISTORY");
            if (requiredPerms.length) {
                requireBotChannelPermissions(bot, channel, requiredPerms);
            }
        }
        return await sendMessageOld(channelId, content);
    };
}
export function editMessage(bot) {
    const editMessageOld = bot.helpers.editMessage;
    bot.helpers.editMessage = function (channelId, messageId, content) {
        if (typeof content === "string") {
            throw new Error("TODO");
        }
        const message = bot.messages.get(messageId);
        if (message) {
            if (message.authorId !== bot.id) {
                content = { flags: content.flags };
                requireBotChannelPermissions(bot, channelId, ["MANAGE_MESSAGES"]);
            }
        }
        if (content.allowedMentions) {
            if (content.allowedMentions.users?.length) {
                if (content.allowedMentions.parse?.includes(AllowedMentionsTypes.UserMentions)) {
                    content.allowedMentions.parse = content.allowedMentions.parse.filter((p) => p !== "users");
                }
                if (content.allowedMentions.users.length > 100) {
                    content.allowedMentions.users = content.allowedMentions.users.slice(0, 100);
                }
            }
            if (content.allowedMentions.roles?.length) {
                if (content.allowedMentions.parse?.includes(AllowedMentionsTypes.RoleMentions)) {
                    content.allowedMentions.parse = content.allowedMentions.parse.filter((p) => p !== "roles");
                }
                if (content.allowedMentions.roles.length > 100) {
                    content.allowedMentions.roles = content.allowedMentions.roles.slice(0, 100);
                }
            }
        }
        content.embeds?.splice(10);
        if (content.content &&
            !bot.utils.validateLength(content.content, { max: 2000 })) {
            throw new Error("A message content can not contain more than 2000 characters.");
        }
        return editMessageOld(channelId, messageId, content);
    };
}
export function publishMessage(bot) {
    const publishMessageOld = bot.helpers.publishMessage;
    bot.helpers.publishMessage = function (channelId, messageId) {
        const message = bot.messages.get(messageId);
        requireBotChannelPermissions(bot, channelId, message?.authorId === bot.id ? ["SEND_MESSAGES"] : ["MANAGE_MESSAGES"]);
        return publishMessageOld(channelId, messageId);
    };
}
export default function setupCreateMessagePermChecks(bot) {
    sendMessage(bot);
    editMessage(bot);
    publishMessage(bot);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY3JlYXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxvQkFBb0IsRUFBZ0IsWUFBWSxFQUFxQixNQUFNLGVBQWUsQ0FBQztBQUNwRyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUVqRSxNQUFNLFVBQVUsV0FBVyxDQUFDLEdBQWlCO0lBQzNDLE1BQU0sY0FBYyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDO0lBRS9DLEdBQUcsQ0FBQyxPQUFPLENBQUMsV0FBVyxHQUFHLEtBQUssV0FDN0IsU0FBUyxFQUNULE9BQU87UUFFUCxJQUFJLE9BQU8sT0FBTyxLQUFLLFFBQVEsRUFBRTtZQUMvQixNQUFNLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3pCO1FBRUQsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDNUMsSUFDRSxPQUFPO1lBQ1A7Z0JBQ0UsWUFBWSxDQUFDLGFBQWE7Z0JBQzFCLFlBQVksQ0FBQyxlQUFlO2dCQUM1QixZQUFZLENBQUMsVUFBVTthQUN4QixDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQ3hCO1lBQ0EsTUFBTSxJQUFJLEtBQUssQ0FDYiwrREFBK0QsU0FBUyxFQUFFLENBQzNFLENBQUM7U0FDSDtRQUVELElBQ0UsT0FBTyxDQUFDLE9BQU87WUFDZixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFDekQ7WUFDQSxNQUFNLElBQUksS0FBSyxDQUFDLGdEQUFnRCxDQUFDLENBQUM7U0FDbkU7UUFFRCxJQUFJ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LFVBQVUsNEJBQTRCLENBQUMsR0FBaUI7SUFDcEUsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2pCLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNqQixjQUFjLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDdEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFsbG93ZWRNZW50aW9uc1R5cGVzLCBCb3RXaXRoQ2FjaGUsIENoYW5uZWxUeXBlcywgUGVybWlzc2lvblN0cmluZ3MgfSBmcm9tIFwiLi4vLi4vZGVwcy50c1wiO1xuaW1wb3J0IHsgdmFsaWRhdGVDb21wb25lbnRzIH0gZnJvbSBcIi4uL2NvbXBvbmVudHMudHNcIjtcbmltcG9ydCB7IHJlcXVpcmVCb3RDaGFubmVsUGVybWlzc2lvbnMgfSBmcm9tIFwiLi4vcGVybWlzc2lvbnMudHNcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIHNlbmRNZXNzYWdlKGJvdDogQm90V2l0aENhY2hlKSB7XG4gIGNvbnN0IHNlbmRNZXNzYWdlT2xkID0gYm90LmhlbHBlcnMuc2VuZE1lc3NhZ2U7XG5cbiAgYm90LmhlbHBlcnMuc2VuZE1lc3NhZ2UgPSBhc3luYyBmdW5jdGlvbiAoXG4gICAgY2hhbm5lbElkLFxuICAgIGNvbnRlbnQsXG4gICkge1xuICAgIGlmICh0eXBlb2YgY29udGVudCA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVE9ET1wiKTtcbiAgICB9XG5cbiAgICBjb25zdCBjaGFubmVsID0gYm90LmNoYW5uZWxzLmdldChjaGFubmVsSWQpO1xuICAgIGlmIChcbiAgICAgIGNoYW5uZWwgJiZcbiAgICAgIFtcbiAgICAgICAgQ2hhbm5lbFR5cGVzLkd1aWxkQ2F0ZWdvcnksXG4gICAgICAgIENoYW5uZWxUeXBlcy5HdWlsZFN0YWdlVm9pY2UsXG4gICAgICAgIENoYW5uZWxUeXBlcy5HdWlsZEZvcnVtLFxuICAgICAgXS5pbmNsdWRlcyhjaGFubmVsLnR5cGUpXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDYW4gbm90IHNlbmQgbWVzc2FnZSB0byBhIGNoYW5uZWwgb2YgdGhpcyB0eXBlLiBDaGFubmVsIElEOiAke2NoYW5uZWxJZH1gLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICBjb250ZW50LmNvbnRlbnQgJiZcbiAgICAgICFib3QudXRpbHMudmFsaWRhdGVMZW5ndGgoY29udGVudC5jb250ZW50LCB7IG1heDogMjAwMCB9KVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVGhlIGNvbnRlbnQgc2hvdWxkIG5vdCBleGNlZWQgMjAwMCBjaGFyYWN0ZXJzLlwiKTtcbiAgICB9XG5cbiAgICBpZiAoY29udGVudC5hbGxvd2VkTWVudGlvbnMpIHtcbiAgICAgIGlmIChjb250ZW50LmFsbG93ZWRNZW50aW9ucy51c2Vycz8ubGVuZ3RoKSB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBjb250ZW50LmFsbG93ZWRNZW50aW9ucy5wYXJzZT8uaW5jbHVkZXMoXG4gICAgICAgICAgICBBbGxvd2VkTWVudGlvbnNUeXBlcy5Vc2VyTWVudGlvbnMsXG4gICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICBjb250ZW50LmFsbG93ZWRNZW50aW9ucy5wYXJzZSA9IGNvbnRlbnQuYWxsb3dlZE1lbnRpb25zLnBhcnNlLmZpbHRlcigoXG4gICAgICAgICAgICBwLFxuICAgICAgICAgICkgPT4gcCAhPT0gXCJ1c2Vyc1wiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb250ZW50LmFsbG93ZWRNZW50aW9ucy51c2Vycy5sZW5ndGggPiAxMDApIHtcbiAgICAgICAgICBjb250ZW50LmFsbG93ZWRNZW50aW9ucy51c2VycyA9IGNvbnRlbnQuYWxsb3dlZE1lbnRpb25zLnVzZXJzLnNsaWNlKFxuICAgICAgICAgICAgMCxcbiAgICAgICAgICAgIDEwMCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChjb250ZW50LmFsbG93ZWRNZW50aW9ucy5yb2xlcz8ubGVuZ3RoKSB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBjb250ZW50LmFsbG93ZWRNZW50aW9ucy5wYXJzZT8uaW5jbHVkZXMoXG4gICAgICAgICAgICBBbGxvd2VkTWVudGlvbnNUeXBlcy5Sb2xlTWVudGlvbnMsXG4gICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICBjb250ZW50LmFsbG93ZWRNZW50aW9ucy5wYXJzZSA9IGNvbnRlbnQuYWxsb3dlZE1lbnRpb25zLnBhcnNlLmZpbHRlcigoXG4gICAgICAgICAgICBwLFxuICAgICAgICAgICkgPT4gcCAhPT0gXCJyb2xlc1wiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb250ZW50LmFsbG93ZWRNZW50aW9ucy5yb2xlcy5sZW5ndGggPiAxMDApIHtcbiAgICAgICAgICBjb250ZW50LmFsbG93ZWRNZW50aW9ucy5yb2xlcyA9IGNvbnRlbnQuYWxsb3dlZE1lbnRpb25zLnJvbGVzLnNsaWNlKFxuICAgICAgICAgICAgMCxcbiAgICAgICAgICAgIDEwMCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGNvbnRlbnQuY29tcG9uZW50cykge1xuICAgICAgdmFsaWRhdGVDb21wb25lbnRzKGJvdCwgY29udGVudC5jb21wb25lbnRzKTtcbiAgICB9XG5cbiAgICBpZiAoY2hhbm5lbCkge1xuICAgICAgY29uc3QgcmVxdWlyZWRQZXJtczogUGVybWlzc2lvblN0cmluZ3NbXSA9IFtdO1xuICAgICAgaWYgKGNoYW5uZWwuZ3VpbGRJZCkge1xuICAgICAgICByZXF1aXJlZFBlcm1zLnB1c2goXCJTRU5EX01FU1NBR0VTXCIpO1xuICAgICAgfVxuICAgICAgaWYgKGNvbnRlbnQudHRzKSByZXF1aXJlZFBlcm1zLnB1c2goXCJTRU5EX1RUU19NRVNTQUdFU1wiKTtcbiAgICAgIGlmIChjb250ZW50Lm1lc3NhZ2VSZWZlcmVuY2UpIHJlcXVpcmVkUGVybXMucHVzaChcIlJFQURfTUVTU0FHRV9ISVNUT1JZXCIpO1xuICAgICAgaWYgKHJlcXVpcmVkUGVybXMubGVuZ3RoKSB7XG4gICAgICAgIHJlcXVpcmVCb3RDaGFubmVsUGVybWlzc2lvbnMoYm90LCBjaGFubmVsLCByZXF1aXJlZFBlcm1zKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgc2VuZE1lc3NhZ2VPbGQoY2hhbm5lbElkLCBjb250ZW50KTtcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGVkaXRNZXNzYWdlKGJvdDogQm90V2l0aENhY2hlKSB7XG4gIGNvbnN0IGVkaXRNZXNzYWdlT2xkID0gYm90LmhlbHBlcnMuZWRpdE1lc3NhZ2U7XG5cbiAgYm90LmhlbHBlcnMuZWRpdE1lc3NhZ2UgPSBmdW5jdGlvbiAoXG4gICAgY2hhbm5lbElkLFxuICAgIG1lc3NhZ2VJZCxcbiAgICBjb250ZW50LFxuICApIHtcbiAgICBpZiAodHlwZW9mIGNvbnRlbnQgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlRPRE9cIik7XG4gICAgfVxuXG4gICAgY29uc3QgbWVzc2FnZSA9IGJvdC5tZXNzYWdlcy5nZXQobWVzc2FnZUlkKTtcbiAgICBpZiAobWVzc2FnZSkge1xuICAgICAgaWYgKG1lc3NhZ2UuYXV0aG9ySWQgIT09IGJvdC5pZCkge1xuICAgICAgICBjb250ZW50ID0geyBmbGFnczogY29udGVudC5mbGFncyB9O1xuICAgICAgICByZXF1aXJlQm90Q2hhbm5lbFBlcm1pc3Npb25zKGJvdCwgY2hhbm5lbElkLCBbXCJNQU5BR0VfTUVTU0FHRVNcIl0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChjb250ZW50LmFsbG93ZWRNZW50aW9ucykge1xuICAgICAgaWYgKGNvbnRlbnQuYWxsb3dlZE1lbnRpb25zLnVzZXJzPy5sZW5ndGgpIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIGNvbnRlbnQuYWxsb3dlZE1lbnRpb25zLnBhcnNlPy5pbmNsdWRlcyhcbiAgICAgICAgICAgIEFsbG93ZWRNZW50aW9uc1R5cGVzLlVzZXJNZW50aW9ucyxcbiAgICAgICAgICApXG4gICAgICAgICkge1xuICAgICAgICAgIGNvbnRlbnQuYWxsb3dlZE1lbnRpb25zLnBhcnNlID0gY29udGVudC5hbGxvd2VkTWVudGlvbnMucGFyc2UuZmlsdGVyKChcbiAgICAgICAgICAgIHAsXG4gICAgICAgICAgKSA9PiBwICE9PSBcInVzZXJzXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbnRlbnQuYWxsb3dlZE1lbnRpb25zLnVzZXJzLmxlbmd0aCA+IDEwMCkge1xuICAgICAgICAgIGNvbnRlbnQuYWxsb3dlZE1lbnRpb25zLnVzZXJzID0gY29udGVudC5hbGxvd2VkTWVudGlvbnMudXNlcnMuc2xpY2UoXG4gICAgICAgICAgICAwLFxuICAgICAgICAgICAgMTAwLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGNvbnRlbnQuYWxsb3dlZE1lbnRpb25zLnJvbGVzPy5sZW5ndGgpIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIGNvbnRlbnQuYWxsb3dlZE1lbnRpb25zLnBhcnNlPy5pbmNsdWRlcyhcbiAgICAgICAgICAgIEFsbG93ZWRNZW50aW9uc1R5cGVzLlJvbGVNZW50aW9ucyxcbiAgICAgICAgICApXG4gICAgICAgICkge1xuICAgICAgICAgIGNvbnRlbnQuYWxsb3dlZE1lbnRpb25zLnBhcnNlID0gY29udGVudC5hbGxvd2VkTWVudGlvbnMucGFyc2UuZmlsdGVyKChcbiAgICAgICAgICAgIHAsXG4gICAgICAgICAgKSA9PiBwICE9PSBcInJvbGVzXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbnRlbnQuYWxsb3dlZE1lbnRpb25zLnJvbGVzLmxlbmd0aCA+IDEwMCkge1xuICAgICAgICAgIGNvbnRlbnQuYWxsb3dlZE1lbnRpb25zLnJvbGVzID0gY29udGVudC5hbGxvd2VkTWVudGlvbnMucm9sZXMuc2xpY2UoXG4gICAgICAgICAgICAwLFxuICAgICAgICAgICAgMTAwLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb250ZW50LmVtYmVkcz8uc3BsaWNlKDEwKTtcblxuICAgIGlmIChcbiAgICAgIGNvbnRlbnQuY29udGVudCAmJlxuICAgICAgIWJvdC51dGlscy52YWxpZGF0ZUxlbmd0aChjb250ZW50LmNvbnRlbnQsIHsgbWF4OiAyMDAwIH0pXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIFwiQSBtZXNzYWdlIGNvbnRlbnQgY2FuIG5vdCBjb250YWluIG1vcmUgdGhhbiAyMDAwIGNoYXJhY3RlcnMuXCIsXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBlZGl0TWVzc2FnZU9sZChjaGFubmVsSWQsIG1lc3NhZ2VJZCwgY29udGVudCk7XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwdWJsaXNoTWVzc2FnZShib3Q6IEJvdFdpdGhDYWNoZSkge1xuICBjb25zdCBwdWJsaXNoTWVzc2FnZU9sZCA9IGJvdC5oZWxwZXJzLnB1Ymxpc2hNZXNzYWdlO1xuXG4gIGJvdC5oZWxwZXJzLnB1Ymxpc2hNZXNzYWdlID0gZnVuY3Rpb24gKFxuICAgIGNoYW5uZWxJZCxcbiAgICBtZXNzYWdlSWQsXG4gICkge1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBib3QubWVzc2FnZXMuZ2V0KG1lc3NhZ2VJZCk7XG5cbiAgICByZXF1aXJlQm90Q2hhbm5lbFBlcm1pc3Npb25zKFxuICAgICAgYm90LFxuICAgICAgY2hhbm5lbElkLFxuICAgICAgbWVzc2FnZT8uYXV0aG9ySWQgPT09IGJvdC5pZCA/IFtcIlNFTkRfTUVTU0FHRVNcIl0gOiBbXCJNQU5BR0VfTUVTU0FHRVNcIl0sXG4gICAgKTtcblxuICAgIHJldHVybiBwdWJsaXNoTWVzc2FnZU9sZChjaGFubmVsSWQsIG1lc3NhZ2VJZCk7XG4gIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHNldHVwQ3JlYXRlTWVzc2FnZVBlcm1DaGVja3MoYm90OiBCb3RXaXRoQ2FjaGUpIHtcbiAgc2VuZE1lc3NhZ2UoYm90KTtcbiAgZWRpdE1lc3NhZ2UoYm90KTtcbiAgcHVibGlzaE1lc3NhZ2UoYm90KTtcbn1cbiJdfQ==