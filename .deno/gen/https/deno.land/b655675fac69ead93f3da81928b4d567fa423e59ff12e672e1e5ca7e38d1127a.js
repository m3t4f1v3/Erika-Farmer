import { GatewayOpcodes } from "../../types/shared.ts";
import { createLeakyBucket } from "../../util/bucket.ts";
import { delay } from "../../util/utils.ts";
import { decompressWith } from "./deps.ts";
import { GATEWAY_RATE_LIMIT_RESET_INTERVAL, ShardState } from "./types.ts";
const decoder = new TextDecoder();
export async function handleMessage(shard, message) {
    message = message.data;
    if (shard.gatewayConfig.compress && message instanceof Blob) {
        message = decompressWith(new Uint8Array(await message.arrayBuffer()), 0, (slice) => decoder.decode(slice));
    }
    if (typeof message !== "string")
        return;
    const messageData = JSON.parse(message);
    switch (messageData.op) {
        case GatewayOpcodes.Heartbeat: {
            if (!shard.isOpen())
                return;
            shard.heart.lastBeat = Date.now();
            shard.socket?.send(JSON.stringify({
                op: GatewayOpcodes.Heartbeat,
                d: shard.previousSequenceNumber,
            }));
            shard.events.heartbeat?.(shard);
            break;
        }
        case GatewayOpcodes.Hello: {
            const interval = messageData.d.heartbeat_interval;
            shard.startHeartbeating(interval);
            if (shard.state !== ShardState.Resuming) {
                shard.bucket = createLeakyBucket({
                    max: shard.calculateSafeRequests(),
                    refillInterval: GATEWAY_RATE_LIMIT_RESET_INTERVAL,
                    refillAmount: shard.calculateSafeRequests(),
                    waiting: shard.bucket.waiting,
                });
            }
            shard.events.hello?.(shard);
            break;
        }
        case GatewayOpcodes.HeartbeatACK: {
            shard.heart.acknowledged = true;
            shard.heart.lastAck = Date.now();
            if (shard.heart.lastBeat) {
                shard.heart.rtt = shard.heart.lastAck - shard.heart.lastBeat;
            }
            shard.events.heartbeatAck?.(shard);
            break;
        }
        case GatewayOpcodes.Reconnect: {
            shard.events.requestedReconnect?.(shard);
            await shard.resume();
            break;
        }
        case GatewayOpcodes.InvalidSession: {
            const resumable = messageData.d;
            shard.events.invalidSession?.(shard, resumable);
            await delay(Math.floor((Math.random() * 4 + 1) * 1000));
            shard.resolves.get("INVALID_SESSION")?.(messageData);
            shard.resolves.delete("INVALID_SESSION");
            if (!resumable) {
                await shard.identify();
                break;
            }
            await shard.resume();
            break;
        }
    }
    if (messageData.t === "RESUMED") {
        shard.state = ShardState.Connected;
        shard.events.resumed?.(shard);
        shard.offlineSendQueue.map((resolve) => resolve());
        shard.resolves.get("RESUMED")?.(messageData);
        shard.resolves.delete("RESUMED");
    }
    else if (messageData.t === "READY") {
        const payload = messageData.d;
        shard.sessionId = payload.session_id;
        shard.state = ShardState.Connected;
        shard.offlineSendQueue.map((resolve) => resolve());
        shard.resolves.get("READY")?.(messageData);
        shard.resolves.delete("READY");
    }
    if (messageData.s !== null) {
        shard.previousSequenceNumber = messageData.s;
    }
    shard.events.message?.(shard, messageData);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFuZGxlTWVzc2FnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImhhbmRsZU1lc3NhZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM1QyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzNDLE9BQU8sRUFBRSxpQ0FBaUMsRUFBUyxVQUFVLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFFbEYsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztBQUVsQyxNQUFNLENBQUMsS0FBSyxVQUFVLGFBQWEsQ0FBQyxLQUFZLEVBQUUsT0FBMEI7SUFDMUUsT0FBTyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUM7SUFJdkIsSUFBSSxLQUFLLENBQUMsYUFBYSxDQUFDLFFBQVEsSUFBSSxPQUFPLFlBQVksSUFBSSxFQUFFO1FBQzNELE9BQU8sR0FBRyxjQUFjLENBQ3RCLElBQUksVUFBVSxDQUFDLE1BQU0sT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDLEVBQzNDLENBQUMsRUFDRCxDQUFDLEtBQWlCLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQzdDLENBQUM7S0FDSDtJQUdELElBQUksT0FBTyxPQUFPLEtBQUssUUFBUTtRQUFFLE9BQU87SUFFeEMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQTBCLENBQUM7SUFNakUsUUFBUSxXQUFXLENBQUMsRUFBRSxFQUFFO1FBQ3RCLEtBQUssY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRTdCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO2dCQUFFLE9BQU87WUFFNUIs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UGF5bG9hZCwgRGlzY29yZEhlbGxvLCBEaXNjb3JkUmVhZHkgfSBmcm9tIFwiLi4vLi4vdHlwZXMvZGlzY29yZC50c1wiO1xuaW1wb3J0IHsgR2F0ZXdheU9wY29kZXMgfSBmcm9tIFwiLi4vLi4vdHlwZXMvc2hhcmVkLnRzXCI7XG5pbXBvcnQgeyBjcmVhdGVMZWFreUJ1Y2tldCB9IGZyb20gXCIuLi8uLi91dGlsL2J1Y2tldC50c1wiO1xuaW1wb3J0IHsgZGVsYXkgfSBmcm9tIFwiLi4vLi4vdXRpbC91dGlscy50c1wiO1xuaW1wb3J0IHsgZGVjb21wcmVzc1dpdGggfSBmcm9tIFwiLi9kZXBzLnRzXCI7XG5pbXBvcnQgeyBHQVRFV0FZX1JBVEVfTElNSVRfUkVTRVRfSU5URVJWQUwsIFNoYXJkLCBTaGFyZFN0YXRlIH0gZnJvbSBcIi4vdHlwZXMudHNcIjtcblxuY29uc3QgZGVjb2RlciA9IG5ldyBUZXh0RGVjb2RlcigpO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaGFuZGxlTWVzc2FnZShzaGFyZDogU2hhcmQsIG1lc3NhZ2U6IE1lc3NhZ2VFdmVudDxhbnk+KTogUHJvbWlzZTx2b2lkPiB7XG4gIG1lc3NhZ2UgPSBtZXNzYWdlLmRhdGE7XG5cbiAgLy8gSWYgbWVzc2FnZSBjb21wcmVzc2lvbiBpcyBlbmFibGVkLFxuICAvLyBEaXNjb3JkIG1pZ2h0IHNlbmQgemxpYiBjb21wcmVzc2VkIHBheWxvYWRzLlxuICBpZiAoc2hhcmQuZ2F0ZXdheUNvbmZpZy5jb21wcmVzcyAmJiBtZXNzYWdlIGluc3RhbmNlb2YgQmxvYikge1xuICAgIG1lc3NhZ2UgPSBkZWNvbXByZXNzV2l0aChcbiAgICAgIG5ldyBVaW50OEFycmF5KGF3YWl0IG1lc3NhZ2UuYXJyYXlCdWZmZXIoKSksXG4gICAgICAwLFxuICAgICAgKHNsaWNlOiBVaW50OEFycmF5KSA9PiBkZWNvZGVyLmRlY29kZShzbGljZSksXG4gICAgKTtcbiAgfVxuXG4gIC8vIFNhZmVndWFyZCBpbmNhc2UgZGVjb21wcmVzc2lvbiBmYWlsZWQgdG8gbWFrZSBhIHN0cmluZy5cbiAgaWYgKHR5cGVvZiBtZXNzYWdlICE9PSBcInN0cmluZ1wiKSByZXR1cm47XG5cbiAgY29uc3QgbWVzc2FnZURhdGEgPSBKU09OLnBhcnNlKG1lc3NhZ2UpIGFzIERpc2NvcmRHYXRld2F5UGF5bG9hZDtcbiAgLy8gICBnYXRld2F5LmRlYnVnKFwiR1cgUkFXXCIsIHsgc2hhcmRJZCwgcGF5bG9hZDogbWVzc2FnZURhdGEgfSk7XG5cbiAgLy8gVE9ETzogcmVtb3ZlXG4gIC8vIGNvbnNvbGUubG9nKHsgbWVzc2FnZURhdGE6IGNlbnNvcihtZXNzYWdlRGF0YSkgfSk7XG5cbiAgc3dpdGNoIChtZXNzYWdlRGF0YS5vcCkge1xuICAgIGNhc2UgR2F0ZXdheU9wY29kZXMuSGVhcnRiZWF0OiB7XG4gICAgICAvLyBUT0RPOiBjYW4gdGhpcyBhY3R1YWxseSBoYXBwZW5cbiAgICAgIGlmICghc2hhcmQuaXNPcGVuKCkpIHJldHVybjtcblxuICAgICAgc2hhcmQuaGVhcnQubGFzdEJlYXQgPSBEYXRlLm5vdygpO1xuICAgICAgLy8gRGlzY29yZCByYW5kb21seSBzZW5kcyB0aGlzIHJlcXVpcmluZyBhbiBpbW1lZGlhdGUgaGVhcnRiZWF0IGJhY2suXG4gICAgICAvLyBVc2luZyBhIGRpcmVjdCBzb2NrZXQuc2VuZCBjYWxsIGhlcmUgYmVjYXVzZSBoZWFydGJlYXQgcmVxdWVzdHMgYXJlIHJlc2VydmVkIGJ5IHVzLlxuICAgICAgc2hhcmQuc29ja2V0Py5zZW5kKFxuICAgICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgb3A6IEdhdGV3YXlPcGNvZGVzLkhlYXJ0YmVhdCxcbiAgICAgICAgICBkOiBzaGFyZC5wcmV2aW91c1NlcXVlbmNlTnVtYmVyLFxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgICBzaGFyZC5ldmVudHMuaGVhcnRiZWF0Py4oc2hhcmQpO1xuXG4gICAgICBicmVhaztcbiAgICB9XG4gICAgY2FzZSBHYXRld2F5T3Bjb2Rlcy5IZWxsbzoge1xuICAgICAgY29uc3QgaW50ZXJ2YWwgPSAobWVzc2FnZURhdGEuZCBhcyBEaXNjb3JkSGVsbG8pLmhlYXJ0YmVhdF9pbnRlcnZhbDtcblxuICAgICAgc2hhcmQuc3RhcnRIZWFydGJlYXRpbmcoaW50ZXJ2YWwpO1xuXG4gICAgICBpZiAoc2hhcmQuc3RhdGUgIT09IFNoYXJkU3RhdGUuUmVzdW1pbmcpIHtcbiAgICAgICAgLy8gSEVMTE8gaGFzIGJlZW4gc2VuZCBvbiBhIG5vbiByZXN1bWUgYWN0aW9uLlxuICAgICAgICAvLyBUaGlzIG1lYW5zIHRoYXQgdGhlIHNoYXJkIHN0YXJ0cyBhIG5ldyBzZXNzaW9uLFxuICAgICAgICAvLyB0aGVyZWZvcmUgdGhlIHJhdGUgbGltaXQgaW50ZXJ2YWwgaGFzIGJlZW4gcmVzZXQgdG9vLlxuICAgICAgICBzaGFyZC5idWNrZXQgPSBjcmVhdGVMZWFreUJ1Y2tldCh7XG4gICAgICAgICAgbWF4OiBzaGFyZC5jYWxjdWxhdGVTYWZlUmVxdWVzdHMoKSxcbiAgICAgICAgICByZWZpbGxJbnRlcnZhbDogR0FURVdBWV9SQVRFX0xJTUlUX1JFU0VUX0lOVEVSVkFMLFxuICAgICAgICAgIHJlZmlsbEFtb3VudDogc2hhcmQuY2FsY3VsYXRlU2FmZVJlcXVlc3RzKCksXG4gICAgICAgICAgLy8gV2FpdGluZyBhY3F1aXJlcyBzaG91bGQgbm90IGJlIGxvc3Qgb24gYSByZS1pZGVudGlmeS5cbiAgICAgICAgICB3YWl0aW5nOiBzaGFyZC5idWNrZXQud2FpdGluZyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHNoYXJkLmV2ZW50cy5oZWxsbz8uKHNoYXJkKTtcblxuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGNhc2UgR2F0ZXdheU9wY29kZXMuSGVhcnRiZWF0QUNLOiB7XG4gICAgICBzaGFyZC5oZWFydC5hY2tub3dsZWRnZWQgPSB0cnVlO1xuICAgICAgc2hhcmQuaGVhcnQubGFzdEFjayA9IERhdGUubm93KCk7XG4gICAgICAvLyBNYW51YWxseSBjYWxjdWxhdGluZyB0aGUgcm91bmQgdHJpcCB0aW1lIGZvciB1c2VycyB3aG8gbmVlZCBpdC5cbiAgICAgIGlmIChzaGFyZC5oZWFydC5sYXN0QmVhdCkge1xuICAgICAgICBzaGFyZC5oZWFydC5ydHQgPSBzaGFyZC5oZWFydC5sYXN0QWNrIC0gc2hhcmQuaGVhcnQubGFzdEJlYXQ7XG4gICAgICB9XG5cbiAgICAgIHNoYXJkLmV2ZW50cy5oZWFydGJlYXRBY2s/LihzaGFyZCk7XG5cbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBjYXNlIEdhdGV3YXlPcGNvZGVzLlJlY29ubmVjdDoge1xuICAgICAgLy8gICBnYXRld2F5LmRlYnVnKFwiR1cgUkVDT05ORUNUXCIsIHsgc2hhcmRJZCB9KTtcblxuICAgICAgc2hhcmQuZXZlbnRzLnJlcXVlc3RlZFJlY29ubmVjdD8uKHNoYXJkKTtcblxuICAgICAgYXdhaXQgc2hhcmQucmVzdW1lKCk7XG5cbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBjYXNlIEdhdGV3YXlPcGNvZGVzLkludmFsaWRTZXNzaW9uOiB7XG4gICAgICAvLyAgIGdhdGV3YXkuZGVidWcoXCJHVyBJTlZBTElEX1NFU1NJT05cIiwgeyBzaGFyZElkLCBwYXlsb2FkOiBtZXNzYWdlRGF0YSB9KTtcbiAgICAgIGNvbnN0IHJlc3VtYWJsZSA9IG1lc3NhZ2VEYXRhLmQgYXMgYm9vbGVhbjtcblxuICAgICAgc2hhcmQuZXZlbnRzLmludmFsaWRTZXNzaW9uPy4oc2hhcmQsIHJlc3VtYWJsZSk7XG5cbiAgICAgIC8vIFdlIG5lZWQgdG8gd2FpdCBmb3IgYSByYW5kb20gYW1vdW50IG9mIHRpbWUgYmV0d2VlbiAxIGFuZCA1XG4gICAgICAvLyBSZWZlcmVuY2U6IGh0dHBzOi8vZGlzY29yZC5jb20vZGV2ZWxvcGVycy9kb2NzL3RvcGljcy9nYXRld2F5I3Jlc3VtaW5nXG4gICAgICBhd2FpdCBkZWxheShNYXRoLmZsb29yKChNYXRoLnJhbmRvbSgpICogNCArIDEpICogMTAwMCkpO1xuXG4gICAgICBzaGFyZC5yZXNvbHZlcy5nZXQoXCJJTlZBTElEX1NFU1NJT05cIik/LihtZXNzYWdlRGF0YSk7XG4gICAgICBzaGFyZC5yZXNvbHZlcy5kZWxldGUoXCJJTlZBTElEX1NFU1NJT05cIik7XG5cbiAgICAgIC8vIFdoZW4gcmVzdW1hYmxlIGlzIGZhbHNlIHdlIG5lZWQgdG8gcmUtaWRlbnRpZnlcbiAgICAgIGlmICghcmVzdW1hYmxlKSB7XG4gICAgICAgIGF3YWl0IHNoYXJkLmlkZW50aWZ5KCk7XG5cbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIC8vIFRoZSBzZXNzaW9uIGlzIGludmFsaWQgYnV0IGFwcGFyZW50bHkgaXQgaXMgcmVzdW1hYmxlXG4gICAgICBhd2FpdCBzaGFyZC5yZXN1bWUoKTtcblxuICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgaWYgKG1lc3NhZ2VEYXRhLnQgPT09IFwiUkVTVU1FRFwiKSB7XG4gICAgLy8gZ2F0ZXdheS5kZWJ1ZyhcIkdXIFJFU1VNRURcIiwgeyBzaGFyZElkIH0pO1xuXG4gICAgc2hhcmQuc3RhdGUgPSBTaGFyZFN0YXRlLkNvbm5lY3RlZDtcbiAgICBzaGFyZC5ldmVudHMucmVzdW1lZD8uKHNoYXJkKTtcblxuICAgIC8vIENvbnRpbnVlIHRoZSByZXF1ZXN0cyB3aGljaCBoYXZlIGJlZW4gcXVldWVkIHNpbmNlIHRoZSBzaGFyZCB3ZW50IG9mZmxpbmUuXG4gICAgc2hhcmQub2ZmbGluZVNlbmRRdWV1ZS5tYXAoKHJlc29sdmUpID0+IHJlc29sdmUoKSk7XG5cbiAgICBzaGFyZC5yZXNvbHZlcy5nZXQoXCJSRVNVTUVEXCIpPy4obWVzc2FnZURhdGEpO1xuICAgIHNoYXJkLnJlc29sdmVzLmRlbGV0ZShcIlJFU1VNRURcIik7XG4gIH0gLy8gSW1wb3J0YW50IGZvciBmdXR1cmUgcmVzdW1lcy5cbiAgZWxzZSBpZiAobWVzc2FnZURhdGEudCA9PT0gXCJSRUFEWVwiKSB7XG4gICAgY29uc3QgcGF5bG9hZCA9IG1lc3NhZ2VEYXRhLmQgYXMgRGlzY29yZFJlYWR5O1xuXG4gICAgc2hhcmQuc2Vzc2lvbklkID0gcGF5bG9hZC5zZXNzaW9uX2lkO1xuICAgIHNoYXJkLnN0YXRlID0gU2hhcmRTdGF0ZS5Db25uZWN0ZWQ7XG5cbiAgICAvLyBDb250aW51ZSB0aGUgcmVxdWVzdHMgd2hpY2ggaGF2ZSBiZWVuIHF1ZXVlZCBzaW5jZSB0aGUgc2hhcmQgd2VudCBvZmZsaW5lLlxuICAgIC8vIEltcG9ydGFudCB3aGVuIHRoaXMgaXMgYSByZS1pZGVudGlmeVxuICAgIHNoYXJkLm9mZmxpbmVTZW5kUXVldWUubWFwKChyZXNvbHZlKSA9PiByZXNvbHZlKCkpO1xuXG4gICAgc2hhcmQucmVzb2x2ZXMuZ2V0KFwiUkVBRFlcIik/LihtZXNzYWdlRGF0YSk7XG4gICAgc2hhcmQucmVzb2x2ZXMuZGVsZXRlKFwiUkVBRFlcIik7XG4gIH1cblxuICAvLyBVcGRhdGUgdGhlIHNlcXVlbmNlIG51bWJlciBpZiBpdCBpcyBwcmVzZW50XG4gIC8vIGBzYCBjYW4gYmUgZWl0aGVyIGBudWxsYCBvciBhIGBudW1iZXJgLlxuICAvLyBJbiBvcmRlciB0byBwcmV2ZW50IHVwZGF0ZSBtaXNzZXMgd2hlbiBgc2AgaXMgYDBgIHdlIGNoZWNrIGFnYWluc3QgbnVsbC5cbiAgaWYgKG1lc3NhZ2VEYXRhLnMgIT09IG51bGwpIHtcbiAgICBzaGFyZC5wcmV2aW91c1NlcXVlbmNlTnVtYmVyID0gbWVzc2FnZURhdGEucztcbiAgfVxuXG4gIC8vIFRoZSBuZWNlc3NhcnkgaGFuZGxpbmcgcmVxdWlyZWQgZm9yIHRoZSBTaGFyZHMgY29ubmVjdGlvbiBoYXMgYmVlbiBmaW5pc2hlZC5cbiAgLy8gTm93IHRoZSBldmVudCBjYW4gYmUgc2FmZWx5IGZvcndhcmRlZC5cbiAgc2hhcmQuZXZlbnRzLm1lc3NhZ2U/LihzaGFyZCwgbWVzc2FnZURhdGEpO1xufVxuIl19