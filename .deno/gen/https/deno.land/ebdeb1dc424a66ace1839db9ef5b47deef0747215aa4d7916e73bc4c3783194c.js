import { Collection, } from "../deps.ts";
export function setupCacheRemovals(bot) {
    const { CHANNEL_DELETE, GUILD_BAN_ADD, GUILD_DELETE, GUILD_EMOJIS_UPDATE, GUILD_MEMBER_REMOVE, GUILD_ROLE_DELETE, MESSAGE_DELETE_BULK, } = bot.handlers;
    bot.handlers.GUILD_DELETE = function (_, data, shardId) {
        const payload = data.d;
        const id = bot.transformers.snowflake(payload.id);
        bot.guilds.delete(id);
        bot.channels.forEach((channel) => {
            if (channel.guildId === id)
                bot.channels.delete(channel.id);
        });
        bot.members.forEach((member) => {
            if (member.guildId === id)
                bot.members.delete(member.id);
        });
        bot.messages.forEach((message) => {
            if (message.guildId === id)
                bot.messages.delete(message.id);
        });
        GUILD_DELETE(bot, data, shardId);
    };
    bot.handlers.CHANNEL_DELETE = function (_, data, shardId) {
        const payload = data.d;
        CHANNEL_DELETE(bot, data, shardId);
        const id = bot.transformers.snowflake(payload.id);
        bot.channels.delete(id);
        bot.messages.forEach((message) => {
            if (message.channelId === id)
                bot.messages.delete(message.id);
        });
    };
    bot.handlers.GUILD_MEMBER_REMOVE = function (_, data, shardId) {
        const payload = data.d;
        bot.members.delete(bot.transformers.snowflake(payload.user.id));
        GUILD_MEMBER_REMOVE(bot, data, shardId);
    };
    bot.handlers.GUILD_BAN_ADD = function (_, data, shardId) {
        const payload = data.d;
        bot.members.delete(bot.transformers.snowflake(payload.user.id));
        GUILD_BAN_ADD(bot, data, shardId);
    };
    bot.handlers.GUILD_EMOJIS_UPDATE = function (_, data, shardId) {
        const payload = data.d;
        const guild = bot.guilds.get(bot.transformers.snowflake(payload.guild_id));
        if (guild) {
            guild.emojis = new Collection(payload.emojis.map((e) => {
                const emoji = bot.transformers.emoji(bot, e);
                return [emoji.id, emoji];
            }));
        }
        GUILD_EMOJIS_UPDATE(bot, data, shardId);
    };
    bot.handlers.MESSAGE_DELETE = function (_, data) {
        const payload = data.d;
        const id = bot.transformers.snowflake(payload.id);
        const message = bot.messages.get(id);
        bot.events.messageDelete(bot, {
            id,
            channelId: bot.transformers.snowflake(payload.channel_id),
            guildId: payload.guild_id ? bot.transformers.snowflake(payload.guild_id) : undefined,
        }, message);
        bot.messages.delete(id);
    };
    bot.handlers.MESSAGE_DELETE_BULK = function (_, data, shardId) {
        const payload = data.d;
        payload.ids.forEach((id) => bot.messages.delete(bot.transformers.snowflake(id)));
        MESSAGE_DELETE_BULK(bot, data, shardId);
    };
    bot.handlers.GUILD_ROLE_DELETE = function (_, data, shardId) {
        const payload = data.d;
        const guild = bot.guilds.get(bot.transformers.snowflake(payload.guild_id));
        const id = bot.transformers.snowflake(payload.role_id);
        if (guild) {
            guild.roles.delete(id);
            bot.members.forEach((member) => {
                if (member.guildId !== guild.id)
                    return;
                if (!member.roles.includes(id))
                    return;
                member.roles = member.roles.filter((roleId) => roleId !== id);
            });
        }
        GUILD_ROLE_DELETE(bot, data, shardId);
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dXBDYWNoZVJlbW92YWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2V0dXBDYWNoZVJlbW92YWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFFTCxVQUFVLEdBU1gsTUFBTSxZQUFZLENBQUM7QUFFcEIsTUFBTSxVQUFVLGtCQUFrQixDQUFnQixHQUFvQjtJQUNwRSxNQUFNLEVBQ0osY0FBYyxFQUNkLGFBQWEsRUFDYixZQUFZLEVBQ1osbUJBQW1CLEVBQ25CLG1CQUFtQixFQUNuQixpQkFBaUIsRUFDakIsbUJBQW1CLEdBQ3BCLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQztJQUVqQixHQUFHLENBQUMsUUFBUSxDQUFDLFlBQVksR0FBRyxVQUFVLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTztRQUNwRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBNEIsQ0FBQztRQUNsRCxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFbEQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDdEIsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUMvQixJQUFJLE9BQU8sQ0FBQyxPQUFPLEtBQUssRUFBRTtnQkFBRSxHQUFHLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDOUQsQ0FBQyxDQUFDLENBQUM7UUFDSCxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQzdCLElBQUksTUFBTSxDQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMzRCxDQUFDLENBQUMsQ0FBQztRQUNILEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDL0IsSUFBSSxPQUFPLENBQUMsT0FBTyxLQUFLLEVBQUU7Z0JBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzlELENBQUMsQ0FBQyxDQUFDO1FBQ0gsWUFBWSxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDbkMsQ0FBQyxDQUFDO0lBRUYsR0FBRyxDQUFDLFFBQVEsQ0FBQyxjQUFjLEdBQUcsVUFBVSxDQUFDLEVBQUUsSUFBSSxFQUFFLE9BQU87UUFDdEQsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQW1CLENBQUM7UUFFekMsY0FBYyxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFbkMsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3hCLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDL0IsSUFBSSxPQUFPLENBQUMsU0FBUyxLQUFLLEVBQUU7Z0JBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2hFLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDO0lBRUYsR0FBRyxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsR0FBRyxVQUFVLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTztRQUMzRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBNkIsQ0FBQztRQUNuRCxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDaEUsbUJBQW1CLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztJQUMxQyxDQUFDLENBQUM7SUFFRixHQUFHLENBQUMsUUFBUSxDQUFDLGFBQWEsR0FBRyxVQUFVLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTztRQUNyRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBNkIsQ0FBQztRQUNuRCxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDaEUsYUFBYSxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDcEMsQ0FBQyxDQUFDO0lBRUYsR0FBRyxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsR0FBRyxVQUFVLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTztRQUMzRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBNkIsQ0FBQztRQUNuRCxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUUzRSxJQUFJLEtBQUssRUFBRTtZQUNULEtBQUssQ0FBQyxNQUFPLEdBQUcsSUFBSSxVQUFVLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtnQkFDdEQsTUFBTSxLQUFLLEdBQVUsR0FBRyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNwRCxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM1QixDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ0w7UUFFRCxtQkFBbUIsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzFDLENBQUMsQ0FBQztJQUVGLEdBQUcsQ0FBQyxRQUFRLENBQUMsY0FBYyxHQUFHLFVBQVUsQ0FBQyxFQUFFLElBQUk7UUFDN0MsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQXlCLENBQUM7UUFDL0MsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELE1BQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3JDLEdBQUcsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRTtZQUM1QixFQUFFO1lBQ0YsU0FBUyxFQUFFLEdBQUcsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUM7WUFDekQsT0FBTyxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUztTQUNyRixFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ1osR0FBRyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDMUIsQ0FBQyxDQUFDO0lBRUYsR0FBRyxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsR0FBRyxVQUFVLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTztRQUMzRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBNkIsQ0FBQztRQUNuRCxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pGLG1CQUFtQixDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDMUMsQ0FBQyxDQUFDO0lBRUYsR0FBRyxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsR0FBRyxVQUFVLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTztRQUN6RCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBMkIsQ0FBQztRQUNqRCxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FDMUIsR0FBRyxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUM3QyxDQUFDO1FBQ0YsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXZELElBQUksS0FBSyxFQUFFO1lBQ1QsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdkIsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRTtnQkFFN0IsSUFBSSxNQUFNLENBQUMsT0FBTyxLQUFLLEtBQUssQ0FBQyxFQUFFO29CQUFFLE9BQU87Z0JBRXhDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7b0JBQUUsT0FBTztnQkFFdkMsTUFBTSxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsTUFBTSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ2hFLENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFFRCxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3hDLENBQUMsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IEVtb2ppLCBHdWlsZCB9IGZyb20gXCIuLi9kZXBzLnRzXCI7XG5pbXBvcnQgdHlwZSB7IEJvdFdpdGhDYWNoZSB9IGZyb20gXCIuL2FkZENhY2hlQ29sbGVjdGlvbnMudHNcIjtcbmltcG9ydCB7XG4gIEJvdCxcbiAgQ29sbGVjdGlvbixcbiAgRGlzY29yZENoYW5uZWwsXG4gIERpc2NvcmRHdWlsZEJhbkFkZFJlbW92ZSxcbiAgRGlzY29yZEd1aWxkRW1vamlzVXBkYXRlLFxuICBEaXNjb3JkR3VpbGRNZW1iZXJSZW1vdmUsXG4gIERpc2NvcmRHdWlsZFJvbGVEZWxldGUsXG4gIERpc2NvcmRNZXNzYWdlRGVsZXRlLFxuICBEaXNjb3JkTWVzc2FnZURlbGV0ZUJ1bGssXG4gIERpc2NvcmRVbmF2YWlsYWJsZUd1aWxkLFxufSBmcm9tIFwiLi4vZGVwcy50c1wiO1xuXG5leHBvcnQgZnVuY3Rpb24gc2V0dXBDYWNoZVJlbW92YWxzPEIgZXh0ZW5kcyBCb3Q+KGJvdDogQm90V2l0aENhY2hlPEI+KSB7XG4gIGNvbnN0IHtcbiAgICBDSEFOTkVMX0RFTEVURSxcbiAgICBHVUlMRF9CQU5fQURELFxuICAgIEdVSUxEX0RFTEVURSxcbiAgICBHVUlMRF9FTU9KSVNfVVBEQVRFLFxuICAgIEdVSUxEX01FTUJFUl9SRU1PVkUsXG4gICAgR1VJTERfUk9MRV9ERUxFVEUsXG4gICAgTUVTU0FHRV9ERUxFVEVfQlVMSyxcbiAgfSA9IGJvdC5oYW5kbGVycztcblxuICBib3QuaGFuZGxlcnMuR1VJTERfREVMRVRFID0gZnVuY3Rpb24gKF8sIGRhdGEsIHNoYXJkSWQpIHtcbiAgICBjb25zdCBwYXlsb2FkID0gZGF0YS5kIGFzIERpc2NvcmRVbmF2YWlsYWJsZUd1aWxkO1xuICAgIGNvbnN0IGlkID0gYm90LnRyYW5zZm9ybWVycy5zbm93Zmxha2UocGF5bG9hZC5pZCk7XG5cbiAgICBib3QuZ3VpbGRzLmRlbGV0ZShpZCk7XG4gICAgYm90LmNoYW5uZWxzLmZvckVhY2goKGNoYW5uZWwpID0+IHtcbiAgICAgIGlmIChjaGFubmVsLmd1aWxkSWQgPT09IGlkKSBib3QuY2hhbm5lbHMuZGVsZXRlKGNoYW5uZWwuaWQpO1xuICAgIH0pO1xuICAgIGJvdC5tZW1iZXJzLmZvckVhY2goKG1lbWJlcikgPT4ge1xuICAgICAgaWYgKG1lbWJlci5ndWlsZElkID09PSBpZCkgYm90Lm1lbWJlcnMuZGVsZXRlKG1lbWJlci5pZCk7XG4gICAgfSk7XG4gICAgYm90Lm1lc3NhZ2VzLmZvckVhY2goKG1lc3NhZ2UpID0+IHtcbiAgICAgIGlmIChtZXNzYWdlLmd1aWxkSWQgPT09IGlkKSBib3QubWVzc2FnZXMuZGVsZXRlKG1lc3NhZ2UuaWQpO1xuICAgIH0pO1xuICAgIEdVSUxEX0RFTEVURShib3QsIGRhdGEsIHNoYXJkSWQpO1xuICB9O1xuXG4gIGJvdC5oYW5kbGVycy5DSEFOTkVMX0RFTEVURSA9IGZ1bmN0aW9uIChfLCBkYXRhLCBzaGFyZElkKSB7XG4gICAgY29uc3QgcGF5bG9hZCA9IGRhdGEuZCBhcyBEaXNjb3JkQ2hhbm5lbDtcbiAgICAvLyBIQU5ETEVSIEJFRk9SRSBERUxFVElORywgQkVDQVVTRSBIQU5ETEVSIFJVTlMgVFJBTlNGT1JNRVIgV0hJQ0ggUkVBQ0hFU1xuICAgIENIQU5ORUxfREVMRVRFKGJvdCwgZGF0YSwgc2hhcmRJZCk7XG5cbiAgICBjb25zdCBpZCA9IGJvdC50cmFuc2Zvcm1lcnMuc25vd2ZsYWtlKHBheWxvYWQuaWQpO1xuICAgIGJvdC5jaGFubmVscy5kZWxldGUoaWQpO1xuICAgIGJvdC5tZXNzYWdlcy5mb3JFYWNoKChtZXNzYWdlKSA9PiB7XG4gICAgICBpZiAobWVzc2FnZS5jaGFubmVsSWQgPT09IGlkKSBib3QubWVzc2FnZXMuZGVsZXRlKG1lc3NhZ2UuaWQpO1xuICAgIH0pO1xuICB9O1xuXG4gIGJvdC5oYW5kbGVycy5HVUlMRF9NRU1CRVJfUkVNT1ZFID0gZnVuY3Rpb24gKF8sIGRhdGEsIHNoYXJkSWQpIHtcbiAgICBjb25zdCBwYXlsb2FkID0gZGF0YS5kIGFzIERpc2NvcmRHdWlsZE1lbWJlclJlbW92ZTtcbiAgICBib3QubWVtYmVycy5kZWxldGUoYm90LnRyYW5zZm9ybWVycy5zbm93Zmxha2UocGF5bG9hZC51c2VyLmlkKSk7XG4gICAgR1VJTERfTUVNQkVSX1JFTU9WRShib3QsIGRhdGEsIHNoYXJkSWQpO1xuICB9O1xuXG4gIGJvdC5oYW5kbGVycy5HVUlMRF9CQU5fQUREID0gZnVuY3Rpb24gKF8sIGRhdGEsIHNoYXJkSWQpIHtcbiAgICBjb25zdCBwYXlsb2FkID0gZGF0YS5kIGFzIERpc2NvcmRHdWlsZEJhbkFkZFJlbW92ZTtcbiAgICBib3QubWVtYmVycy5kZWxldGUoYm90LnRyYW5zZm9ybWVycy5zbm93Zmxha2UocGF5bG9hZC51c2VyLmlkKSk7XG4gICAgR1VJTERfQkFOX0FERChib3QsIGRhdGEsIHNoYXJkSWQpO1xuICB9O1xuXG4gIGJvdC5oYW5kbGVycy5HVUlMRF9FTU9KSVNfVVBEQVRFID0gZnVuY3Rpb24gKF8sIGRhdGEsIHNoYXJkSWQpIHtcbiAgICBjb25zdCBwYXlsb2FkID0gZGF0YS5kIGFzIERpc2NvcmRHdWlsZEVtb2ppc1VwZGF0ZTtcbiAgICBjb25zdCBndWlsZCA9IGJvdC5ndWlsZHMuZ2V0KGJvdC50cmFuc2Zvcm1lcnMuc25vd2ZsYWtlKHBheWxvYWQuZ3VpbGRfaWQpKTtcblxuICAgIGlmIChndWlsZCkge1xuICAgICAgZ3VpbGQuZW1vamlzISA9IG5ldyBDb2xsZWN0aW9uKHBheWxvYWQuZW1vamlzLm1hcCgoZSkgPT4ge1xuICAgICAgICBjb25zdCBlbW9qaTogRW1vamkgPSBib3QudHJhbnNmb3JtZXJzLmVtb2ppKGJvdCwgZSk7XG4gICAgICAgIHJldHVybiBbZW1vamkuaWQhLCBlbW9qaV07XG4gICAgICB9KSk7XG4gICAgfVxuXG4gICAgR1VJTERfRU1PSklTX1VQREFURShib3QsIGRhdGEsIHNoYXJkSWQpO1xuICB9O1xuXG4gIGJvdC5oYW5kbGVycy5NRVNTQUdFX0RFTEVURSA9IGZ1bmN0aW9uIChfLCBkYXRhKSB7XG4gICAgY29uc3QgcGF5bG9hZCA9IGRhdGEuZCBhcyBEaXNjb3JkTWVzc2FnZURlbGV0ZTtcbiAgICBjb25zdCBpZCA9IGJvdC50cmFuc2Zvcm1lcnMuc25vd2ZsYWtlKHBheWxvYWQuaWQpO1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBib3QubWVzc2FnZXMuZ2V0KGlkKTtcbiAgICBib3QuZXZlbnRzLm1lc3NhZ2VEZWxldGUoYm90LCB7XG4gICAgICBpZCxcbiAgICAgIGNoYW5uZWxJZDogYm90LnRyYW5zZm9ybWVycy5zbm93Zmxha2UocGF5bG9hZC5jaGFubmVsX2lkKSxcbiAgICAgIGd1aWxkSWQ6IHBheWxvYWQuZ3VpbGRfaWQgPyBib3QudHJhbnNmb3JtZXJzLnNub3dmbGFrZShwYXlsb2FkLmd1aWxkX2lkKSA6IHVuZGVmaW5lZCxcbiAgICB9LCBtZXNzYWdlKTtcbiAgICBib3QubWVzc2FnZXMuZGVsZXRlKGlkKTtcbiAgfTtcblxuICBib3QuaGFuZGxlcnMuTUVTU0FHRV9ERUxFVEVfQlVMSyA9IGZ1bmN0aW9uIChfLCBkYXRhLCBzaGFyZElkKSB7XG4gICAgY29uc3QgcGF5bG9hZCA9IGRhdGEuZCBhcyBEaXNjb3JkTWVzc2FnZURlbGV0ZUJ1bGs7XG4gICAgcGF5bG9hZC5pZHMuZm9yRWFjaCgoaWQpID0+IGJvdC5tZXNzYWdlcy5kZWxldGUoYm90LnRyYW5zZm9ybWVycy5zbm93Zmxha2UoaWQpKSk7XG4gICAgTUVTU0FHRV9ERUxFVEVfQlVMSyhib3QsIGRhdGEsIHNoYXJkSWQpO1xuICB9O1xuXG4gIGJvdC5oYW5kbGVycy5HVUlMRF9ST0xFX0RFTEVURSA9IGZ1bmN0aW9uIChfLCBkYXRhLCBzaGFyZElkKSB7XG4gICAgY29uc3QgcGF5bG9hZCA9IGRhdGEuZCBhcyBEaXNjb3JkR3VpbGRSb2xlRGVsZXRlO1xuICAgIGNvbnN0IGd1aWxkID0gYm90Lmd1aWxkcy5nZXQoXG4gICAgICBib3QudHJhbnNmb3JtZXJzLnNub3dmbGFrZShwYXlsb2FkLmd1aWxkX2lkKSxcbiAgICApO1xuICAgIGNvbnN0IGlkID0gYm90LnRyYW5zZm9ybWVycy5zbm93Zmxha2UocGF5bG9hZC5yb2xlX2lkKTtcblxuICAgIGlmIChndWlsZCkge1xuICAgICAgZ3VpbGQucm9sZXMuZGVsZXRlKGlkKTtcbiAgICAgIGJvdC5tZW1iZXJzLmZvckVhY2goKG1lbWJlcikgPT4ge1xuICAgICAgICAvLyBTS0lQIE1FTUJFUlMgSU4gT1RIRVIgR1VJTERTXG4gICAgICAgIGlmIChtZW1iZXIuZ3VpbGRJZCAhPT0gZ3VpbGQuaWQpIHJldHVybjtcbiAgICAgICAgLy8gU0tJUCBNRU1CRVJTIFdITyBET04nVCBIQVZFIFJPTEVcbiAgICAgICAgaWYgKCFtZW1iZXIucm9sZXMuaW5jbHVkZXMoaWQpKSByZXR1cm47XG4gICAgICAgIC8vIEVESVQgVEhFIE1FTUJFUlMgUk9MRVNcbiAgICAgICAgbWVtYmVyLnJvbGVzID0gbWVtYmVyLnJvbGVzLmZpbHRlcigocm9sZUlkKSA9PiByb2xlSWQgIT09IGlkKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIEdVSUxEX1JPTEVfREVMRVRFKGJvdCwgZGF0YSwgc2hhcmRJZCk7XG4gIH07XG59XG4iXX0=