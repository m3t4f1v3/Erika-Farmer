import { CHANNEL_MENTION_REGEX } from "../util/constants.ts";
import { MemberToggles } from "./toggles/member.ts";
export function transformMessage(bot, payload) {
    const guildId = payload.guild_id ? bot.transformers.snowflake(payload.guild_id) : undefined;
    const userId = bot.transformers.snowflake(payload.author.id);
    const message = {
        content: payload.content || "",
        isBot: payload.author.bot || false,
        tag: `${payload.author.username}#${payload.author.discriminator}`,
        timestamp: Date.parse(payload.timestamp),
        editedTimestamp: payload.edited_timestamp ? Date.parse(payload.edited_timestamp) : undefined,
        bitfield: (payload.tts ? 1n : 0n) | (payload.mention_everyone ? 2n : 0n) | (payload.pinned ? 4n : 0n),
        attachments: payload.attachments?.map((attachment) => bot.transformers.attachment(bot, attachment)),
        embeds: payload.embeds?.map((embed) => bot.transformers.embed(bot, embed)),
        reactions: payload.reactions?.map((reaction) => ({
            me: reaction.me,
            count: reaction.count,
            emoji: bot.transformers.emoji(bot, reaction.emoji),
        })),
        type: payload.type,
        activity: payload.activity
            ? {
                type: payload.activity.type,
                partyId: payload.activity.party_id,
            }
            : undefined,
        application: payload.application,
        flags: payload.flags,
        interaction: payload.interaction
            ? {
                id: bot.transformers.snowflake(payload.interaction.id),
                type: payload.interaction.type,
                name: payload.interaction.name,
                user: bot.transformers.user(bot, payload.interaction.user),
                member: payload.interaction.member
                    ? {
                        id: userId,
                        guildId,
                        nick: payload.interaction.member.nick ?? undefined,
                        roles: payload.interaction.member.roles?.map((id) => bot.transformers.snowflake(id)),
                        joinedAt: payload.interaction.member.joined_at
                            ? Date.parse(payload.interaction.member.joined_at)
                            : undefined,
                        premiumSince: payload.interaction.member.premium_since
                            ? Date.parse(payload.interaction.member.premium_since)
                            : undefined,
                        toggles: new MemberToggles(payload.interaction.member),
                        avatar: payload.interaction.member.avatar
                            ? bot.utils.iconHashToBigInt(payload.interaction.member.avatar)
                            : undefined,
                        permissions: payload.interaction.member.permissions
                            ? bot.transformers.snowflake(payload.interaction.member.permissions)
                            : undefined,
                        communicationDisabledUntil: payload.interaction.member.communication_disabled_until
                            ? Date.parse(payload.interaction.member.communication_disabled_until)
                            : undefined,
                    }
                    : undefined,
            }
            : undefined,
        thread: payload.thread ? bot.transformers.channel(bot, { channel: payload.thread, guildId }) : undefined,
        components: payload.components?.map((component) => bot.transformers.component(bot, component)),
        stickerItems: payload.sticker_items?.map((sticker) => ({
            id: bot.transformers.snowflake(sticker.id),
            name: sticker.name,
            formatType: sticker.format_type,
        })),
        id: bot.transformers.snowflake(payload.id),
        guildId,
        channelId: bot.transformers.snowflake(payload.channel_id),
        webhookId: payload.webhook_id ? bot.transformers.snowflake(payload.webhook_id) : undefined,
        authorId: userId,
        applicationId: payload.application_id ? bot.transformers.snowflake(payload.application_id) : undefined,
        messageReference: payload.message_reference
            ? {
                messageId: payload.message_reference.message_id
                    ? bot.transformers.snowflake(payload.message_reference.message_id)
                    : undefined,
                channelId: payload.message_reference.channel_id
                    ? bot.transformers.snowflake(payload.message_reference.channel_id)
                    : undefined,
                guildId: payload.message_reference.guild_id
                    ? bot.transformers.snowflake(payload.message_reference.guild_id)
                    : undefined,
            }
            : undefined,
        mentionedUserIds: payload.mentions ? payload.mentions.map((m) => bot.transformers.snowflake(m.id)) : [],
        mentionedRoleIds: payload.mention_roles ? payload.mention_roles.map((id) => bot.transformers.snowflake(id)) : [],
        mentionedChannelIds: [
            ...(payload.mention_channels ?? []).map((m) => bot.transformers.snowflake(m.id)),
            ...(payload.content?.match(CHANNEL_MENTION_REGEX) || []).map((text) => bot.transformers.snowflake(text.substring(2, text.length - 1))),
        ],
        member: payload.member && guildId ? bot.transformers.member(bot, payload.member, guildId, userId) : undefined,
    };
    return message;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1lc3NhZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDN0QsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBR3BELE1BQU0sVUFBVSxnQkFBZ0IsQ0FBQyxHQUFRLEVBQUUsT0FBdUI7SUFDaEUsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7SUFDNUYsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUU3RCxNQUFNLE9BQU8sR0FBRztRQUVkLE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTyxJQUFJLEVBQUU7UUFDOUIsS0FBSyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxJQUFJLEtBQUs7UUFDbEMsR0FBRyxFQUFFLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUU7UUFDakUsU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztRQUN4QyxlQUFlLEVBQUUsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTO1FBQzVGLFFBQVEsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMs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Q0FBQyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUztLQUM5RyxDQUFDO0lBRUYsT0FBTyxPQUFzQyxDQUFDO0FBQ2hELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCb3QgfSBmcm9tIFwiLi4vYm90LnRzXCI7XG5pbXBvcnQgeyBEaXNjb3JkTWVzc2FnZSB9IGZyb20gXCIuLi90eXBlcy9kaXNjb3JkLnRzXCI7XG5pbXBvcnQgeyBDSEFOTkVMX01FTlRJT05fUkVHRVggfSBmcm9tIFwiLi4vdXRpbC9jb25zdGFudHMudHNcIjtcbmltcG9ydCB7IE1lbWJlclRvZ2dsZXMgfSBmcm9tIFwiLi90b2dnbGVzL21lbWJlci50c1wiO1xuaW1wb3J0IHsgT3B0aW9uYWxpemUgfSBmcm9tIFwiLi4vdHlwZXMvc2hhcmVkLnRzXCI7XG5cbmV4cG9ydCBmdW5jdGlvbiB0cmFuc2Zvcm1NZXNzYWdlKGJvdDogQm90LCBwYXlsb2FkOiBEaXNjb3JkTWVzc2FnZSkge1xuICBjb25zdCBndWlsZElkID0gcGF5bG9hZC5ndWlsZF9pZCA/IGJvdC50cmFuc2Zvcm1lcnMuc25vd2ZsYWtlKHBheWxvYWQuZ3VpbGRfaWQpIDogdW5kZWZpbmVkO1xuICBjb25zdCB1c2VySWQgPSBib3QudHJhbnNmb3JtZXJzLnNub3dmbGFrZShwYXlsb2FkLmF1dGhvci5pZCk7XG5cbiAgY29uc3QgbWVzc2FnZSA9IHtcbiAgICAvLyBVTlRSQU5TRk9STUVEIFNUVUZGIEhFUkVcbiAgICBjb250ZW50OiBwYXlsb2FkLmNvbnRlbnQgfHwgXCJcIixcbiAgICBpc0JvdDogcGF5bG9hZC5hdXRob3IuYm90IHx8IGZhbHNlLFxuICAgIHRhZzogYCR7cGF5bG9hZC5hdXRob3IudXNlcm5hbWV9IyR7cGF5bG9hZC5hdXRob3IuZGlzY3JpbWluYXRvcn1gLFxuICAgIHRpbWVzdGFtcDogRGF0ZS5wYXJzZShwYXlsb2FkLnRpbWVzdGFtcCksXG4gICAgZWRpdGVkVGltZXN0YW1wOiBwYXlsb2FkLmVkaXRlZF90aW1lc3RhbXAgPyBEYXRlLnBhcnNlKHBheWxvYWQuZWRpdGVkX3RpbWVzdGFtcCkgOiB1bmRlZmluZWQsXG4gICAgYml0ZmllbGQ6IChwYXlsb2FkLnR0cyA/IDFuIDogMG4pIHwgKHBheWxvYWQubWVudGlvbl9ldmVyeW9uZSA/IDJuIDogMG4pIHwgKHBheWxvYWQucGlubmVkID8gNG4gOiAwbiksXG4gICAgYXR0YWNobWVudHM6IHBheWxvYWQuYXR0YWNobWVudHM/Lm1hcCgoYXR0YWNobWVudCkgPT4gYm90LnRyYW5zZm9ybWVycy5hdHRhY2htZW50KGJvdCwgYXR0YWNobWVudCkpLFxuICAgIGVtYmVkczogcGF5bG9hZC5lbWJlZHM/Lm1hcCgoZW1iZWQpID0+IGJvdC50cmFuc2Zvcm1lcnMuZW1iZWQoYm90LCBlbWJlZCkpLFxuICAgIHJlYWN0aW9uczogcGF5bG9hZC5yZWFjdGlvbnM/Lm1hcCgocmVhY3Rpb24pID0+ICh7XG4gICAgICBtZTogcmVhY3Rpb24ubWUsXG4gICAgICBjb3VudDogcmVhY3Rpb24uY291bnQsXG4gICAgICBlbW9qaTogYm90LnRyYW5zZm9ybWVycy5lbW9qaShib3QsIHJlYWN0aW9uLmVtb2ppKSxcbiAgICB9KSksXG4gICAgdHlwZTogcGF5bG9hZC50eXBlLFxuICAgIGFjdGl2aXR5OiBwYXlsb2FkLmFjdGl2aXR5XG4gICAgICA/IHtcbiAgICAgICAgdHlwZTogcGF5bG9hZC5hY3Rpdml0eS50eXBlLFxuICAgICAgICBwYXJ0eUlkOiBwYXlsb2FkLmFjdGl2aXR5LnBhcnR5X2lkLFxuICAgICAgfVxuICAgICAgOiB1bmRlZmluZWQsXG4gICAgYXBwbGljYXRpb246IHBheWxvYWQuYXBwbGljYXRpb24sXG4gICAgZmxhZ3M6IHBheWxvYWQuZmxhZ3MsXG4gICAgaW50ZXJhY3Rpb246IHBheWxvYWQuaW50ZXJhY3Rpb25cbiAgICAgID8ge1xuICAgICAgICBpZDogYm90LnRyYW5zZm9ybWVycy5zbm93Zmxha2UocGF5bG9hZC5pbnRlcmFjdGlvbi5pZCksXG4gICAgICAgIHR5cGU6IHBheWxvYWQuaW50ZXJhY3Rpb24udHlwZSxcbiAgICAgICAgbmFtZTogcGF5bG9hZC5pbnRlcmFjdGlvbi5uYW1lLFxuICAgICAgICB1c2VyOiBib3QudHJhbnNmb3JtZXJzLnVzZXIoYm90LCBwYXlsb2FkLmludGVyYWN0aW9uLnVzZXIpLFxuICAgICAgICBtZW1iZXI6IHBheWxvYWQuaW50ZXJhY3Rpb24ubWVtYmVyXG4gICAgICAgICAgPyB7XG4gICAgICAgICAgICBpZDogdXNlcklkLFxuICAgICAgICAgICAgZ3VpbGRJZCxcbiAgICAgICAgICAgIG5pY2s6IHBheWxvYWQuaW50ZXJhY3Rpb24ubWVtYmVyLm5pY2sgPz8gdW5kZWZpbmVkLFxuICAgICAgICAgICAgcm9sZXM6IHBheWxvYWQuaW50ZXJhY3Rpb24ubWVtYmVyLnJvbGVzPy5tYXAoKGlkKSA9PiBib3QudHJhbnNmb3JtZXJzLnNub3dmbGFrZShpZCkpLFxuICAgICAgICAgICAgam9pbmVkQXQ6IHBheWxvYWQuaW50ZXJhY3Rpb24ubWVtYmVyLmpvaW5lZF9hdFxuICAgICAgICAgICAgICA/IERhdGUucGFyc2UocGF5bG9hZC5pbnRlcmFjdGlvbi5tZW1iZXIuam9pbmVkX2F0KVxuICAgICAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIHByZW1pdW1TaW5jZTogcGF5bG9hZC5pbnRlcmFjdGlvbi5tZW1iZXIucHJlbWl1bV9zaW5jZVxuICAgICAgICAgICAgICA/IERhdGUucGFyc2UocGF5bG9hZC5pbnRlcmFjdGlvbi5tZW1iZXIucHJlbWl1bV9zaW5jZSlcbiAgICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICB0b2dnbGVzOiBuZXcgTWVtYmVyVG9nZ2xlcyhwYXlsb2FkLmludGVyYWN0aW9uLm1lbWJlciksXG4gICAgICAgICAgICBhdmF0YXI6IHBheWxvYWQuaW50ZXJhY3Rpb24ubWVtYmVyLmF2YXRhclxuICAgICAgICAgICAgICA/IGJvdC51dGlscy5pY29uSGFzaFRvQmlnSW50KHBheWxvYWQuaW50ZXJhY3Rpb24ubWVtYmVyLmF2YXRhcilcbiAgICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICBwZXJtaXNzaW9uczogcGF5bG9hZC5pbnRlcmFjdGlvbi5tZW1iZXIucGVybWlzc2lvbnNcbiAgICAgICAgICAgICAgPyBib3QudHJhbnNmb3JtZXJzLnNub3dmbGFrZShwYXlsb2FkLmludGVyYWN0aW9uLm1lbWJlci5wZXJtaXNzaW9ucylcbiAgICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgICAgICBjb21tdW5pY2F0aW9uRGlzYWJsZWRVbnRpbDogcGF5bG9hZC5pbnRlcmFjdGlvbi5tZW1iZXIuY29tbXVuaWNhdGlvbl9kaXNhYmxlZF91bnRpbFxuICAgICAgICAgICAgICA/IERhdGUucGFyc2UocGF5bG9hZC5pbnRlcmFjdGlvbi5tZW1iZXIuY29tbXVuaWNhdGlvbl9kaXNhYmxlZF91bnRpbClcbiAgICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgICAgfVxuICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgfVxuICAgICAgOiB1bmRlZmluZWQsXG4gICAgdGhyZWFkOiBwYXlsb2FkLnRocmVhZCA/IGJvdC50cmFuc2Zvcm1lcnMuY2hhbm5lbChib3QsIHsgY2hhbm5lbDogcGF5bG9hZC50aHJlYWQsIGd1aWxkSWQgfSkgOiB1bmRlZmluZWQsXG4gICAgY29tcG9uZW50czogcGF5bG9hZC5jb21wb25lbnRzPy5tYXAoKGNvbXBvbmVudCkgPT4gYm90LnRyYW5zZm9ybWVycy5jb21wb25lbnQoYm90LCBjb21wb25lbnQpKSxcbiAgICBzdGlja2VySXRlbXM6IHBheWxvYWQuc3RpY2tlcl9pdGVtcz8ubWFwKChzdGlja2VyKSA9PiAoe1xuICAgICAgaWQ6IGJvdC50cmFuc2Zvcm1lcnMuc25vd2ZsYWtlKHN0aWNrZXIuaWQpLFxuICAgICAgbmFtZTogc3RpY2tlci5uYW1lLFxuICAgICAgZm9ybWF0VHlwZTogc3RpY2tlci5mb3JtYXRfdHlwZSxcbiAgICB9KSksXG5cbiAgICAvLyBUUkFOU0ZPUk1FRCBTVFVGRiBCRUxPV1xuICAgIGlkOiBib3QudHJhbnNmb3JtZXJzLnNub3dmbGFrZShwYXlsb2FkLmlkKSxcbiAgICBndWlsZElkLFxuICAgIGNoYW5uZWxJZDogYm90LnRyYW5zZm9ybWVycy5zbm93Zmxha2UocGF5bG9hZC5jaGFubmVsX2lkKSxcbiAgICB3ZWJob29rSWQ6IHBheWxvYWQud2ViaG9va19pZCA/IGJvdC50cmFuc2Zvcm1lcnMuc25vd2ZsYWtlKHBheWxvYWQud2ViaG9va19pZCkgOiB1bmRlZmluZWQsXG4gICAgYXV0aG9ySWQ6IHVzZXJJZCxcbiAgICBhcHBsaWNhdGlvbklkOiBwYXlsb2FkLmFwcGxpY2F0aW9uX2lkID8gYm90LnRyYW5zZm9ybWVycy5zbm93Zmxha2UocGF5bG9hZC5hcHBsaWNhdGlvbl9pZCkgOiB1bmRlZmluZWQsXG4gICAgbWVzc2FnZVJlZmVyZW5jZTogcGF5bG9hZC5tZXNzYWdlX3JlZmVyZW5jZVxuICAgICAgPyB7XG4gICAgICAgIG1lc3NhZ2VJZDogcGF5bG9hZC5tZXNzYWdlX3JlZmVyZW5jZS5tZXNzYWdlX2lkXG4gICAgICAgICAgPyBib3QudHJhbnNmb3JtZXJzLnNub3dmbGFrZShwYXlsb2FkLm1lc3NhZ2VfcmVmZXJlbmNlLm1lc3NhZ2VfaWQpXG4gICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIGNoYW5uZWxJZDogcGF5bG9hZC5tZXNzYWdlX3JlZmVyZW5jZS5jaGFubmVsX2lkXG4gICAgICAgICAgPyBib3QudHJhbnNmb3JtZXJzLnNub3dmbGFrZShwYXlsb2FkLm1lc3NhZ2VfcmVmZXJlbmNlLmNoYW5uZWxfaWQpXG4gICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIGd1aWxkSWQ6IHBheWxvYWQubWVzc2FnZV9yZWZlcmVuY2UuZ3VpbGRfaWRcbiAgICAgICAgICA/IGJvdC50cmFuc2Zvcm1lcnMuc25vd2ZsYWtlKHBheWxvYWQubWVzc2FnZV9yZWZlcmVuY2UuZ3VpbGRfaWQpXG4gICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICB9XG4gICAgICA6IHVuZGVmaW5lZCxcbiAgICBtZW50aW9uZWRVc2VySWRzOiBwYXlsb2FkLm1lbnRpb25zID8gcGF5bG9hZC5tZW50aW9ucy5tYXAoKG0pID0+IGJvdC50cmFuc2Zvcm1lcnMuc25vd2ZsYWtlKG0uaWQpKSA6IFtdLFxuICAgIG1lbnRpb25lZFJvbGVJZHM6IHBheWxvYWQubWVudGlvbl9yb2xlcyA/IHBheWxvYWQubWVudGlvbl9yb2xlcy5tYXAoKGlkKSA9PiBib3QudHJhbnNmb3JtZXJzLnNub3dmbGFrZShpZCkpIDogW10sXG4gICAgbWVudGlvbmVkQ2hhbm5lbElkczogW1xuICAgICAgLy8gS2VlcCBhbnkgaWRzIHRodCBkaXNjb3JkIHNlbmRzXG4gICAgICAuLi4ocGF5bG9hZC5tZW50aW9uX2NoYW5uZWxzID8/IFtdKS5tYXAoKG0pID0+IGJvdC50cmFuc2Zvcm1lcnMuc25vd2ZsYWtlKG0uaWQpKSxcbiAgICAgIC8vIEFkZCBhbnkgb3RoZXIgaWRzIHRoYXQgY2FuIGJlIHZhbGlkYXRlZCBpbiBhIGNoYW5uZWwgbWVudGlvbiBmb3JtYXRcbiAgICAgIC4uLihwYXlsb2FkLmNvbnRlbnQ/Lm1hdGNoKENIQU5ORUxfTUVOVElPTl9SRUdFWCkgfHwgW10pLm1hcCgodGV4dCkgPT5cbiAgICAgICAgLy8gY29udmVydHMgdGhlIDwjMTIzPiBpbnRvIDEyM1xuICAgICAgICBib3QudHJhbnNmb3JtZXJzLnNub3dmbGFrZSh0ZXh0LnN1YnN0cmluZygyLCB0ZXh0Lmxlbmd0aCAtIDEpKVxuICAgICAgKSxcbiAgICBdLFxuICAgIG1lbWJlcjogcGF5bG9hZC5tZW1iZXIgJiYgZ3VpbGRJZCA/IGJvdC50cmFuc2Zvcm1lcnMubWVtYmVyKGJvdCwgcGF5bG9hZC5tZW1iZXIsIGd1aWxkSWQsIHVzZXJJZCkgOiB1bmRlZmluZWQsXG4gIH07XG5cbiAgcmV0dXJuIG1lc3NhZ2UgYXMgT3B0aW9uYWxpemU8dHlwZW9mIG1lc3NhZ2U+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1lc3NhZ2UgZXh0ZW5kcyBSZXR1cm5UeXBlPHR5cGVvZiB0cmFuc2Zvcm1NZXNzYWdlPiB7fVxuIl19