import { BitwisePermissionFlags, Errors, separateOverwrites, } from "../deps.ts";
export function calculateBasePermissions(bot, guildOrId, memberOrId) {
    const guild = typeof guildOrId === "bigint" ? bot.guilds.get(guildOrId) : guildOrId;
    const member = typeof memberOrId === "bigint" ? bot.members.get(memberOrId) : memberOrId;
    if (!guild || !member)
        return 8n;
    let permissions = 0n;
    permissions |= [...member.roles, guild.id]
        .map((id) => guild.roles.get(id)?.permissions)
        .filter((perm) => perm)
        .reduce((bits, perms) => {
        bits |= perms;
        return bits;
    }, 0n) || 0n;
    if (guild.ownerId === member.id)
        permissions |= 8n;
    return permissions;
}
export function calculateChannelOverwrites(bot, channelOrId, memberOrId) {
    const channel = typeof channelOrId === "bigint" ? bot.channels.get(channelOrId) : channelOrId;
    if (!channel?.guildId)
        return 8n;
    const member = typeof memberOrId === "bigint" ? bot.members.get(memberOrId) : memberOrId;
    if (!channel || !member)
        return 8n;
    let permissions = calculateBasePermissions(bot, channel.guildId, member);
    const overwriteEveryone = channel.permissionOverwrites?.find((overwrite) => {
        const [_, id] = separateOverwrites(overwrite);
        return id === channel.guildId;
    });
    if (overwriteEveryone) {
        const [_type, _id, allow, deny] = separateOverwrites(overwriteEveryone);
        permissions &= ~deny;
        permissions |= allow;
    }
    const overwrites = channel.permissionOverwrites;
    let allow = 0n;
    let deny = 0n;
    const memberRoles = member.roles || [];
    for (const overwrite of overwrites || []) {
        const [_type, id, allowBits, denyBits] = separateOverwrites(overwrite);
        if (!memberRoles.includes(id))
            continue;
        deny |= denyBits;
        allow |= allowBits;
    }
    permissions &= ~deny;
    permissions |= allow;
    const overwriteMember = overwrites?.find((overwrite) => {
        const [_, id] = separateOverwrites(overwrite);
        return id === member.id;
    });
    if (overwriteMember) {
        const [_type, _id, allowBits, denyBits] = separateOverwrites(overwriteMember);
        permissions &= ~denyBits;
        permissions |= allowBits;
    }
    return permissions;
}
export function validatePermissions(permissionBits, permissions) {
    if (permissionBits & 8n)
        return true;
    return permissions.every((permission) => permissionBits & BigInt(BitwisePermissionFlags[permission]));
}
export function hasGuildPermissions(bot, guild, member, permissions) {
    const basePermissions = calculateBasePermissions(bot, guild, member);
    return validatePermissions(basePermissions, permissions);
}
export function botHasGuildPermissions(bot, guild, permissions) {
    return hasGuildPermissions(bot, guild, bot.id, permissions);
}
export function hasChannelPermissions(bot, channel, member, permissions) {
    const channelOverwrites = calculateChannelOverwrites(bot, channel, member);
    return validatePermissions(channelOverwrites, permissions);
}
export function botHasChannelPermissions(bot, channel, permissions) {
    return hasChannelPermissions(bot, channel, bot.id, permissions);
}
export function missingPermissions(permissionBits, permissions) {
    if (permissionBits & 8n)
        return [];
    return permissions.filter((permission) => !(permissionBits & BigInt(BitwisePermissionFlags[permission])));
}
export function getMissingGuildPermissions(bot, guild, member, permissions) {
    const permissionBits = calculateBasePermissions(bot, guild, member);
    return missingPermissions(permissionBits, permissions);
}
export function getMissingChannelPermissions(bot, channel, member, permissions) {
    const permissionBits = calculateChannelOverwrites(bot, channel, member);
    return missingPermissions(permissionBits, permissions);
}
export function requireGuildPermissions(bot, guild, member, permissions) {
    const missing = getMissingGuildPermissions(bot, guild, member, permissions);
    if (missing.length) {
        throw new Error(`Missing Permissions: ${missing.join(" & ")}`);
    }
}
export function requireBotGuildPermissions(bot, guild, permissions) {
    return requireGuildPermissions(bot, guild, bot.id, permissions);
}
export function requireChannelPermissions(bot, channel, member, permissions) {
    const missing = getMissingChannelPermissions(bot, channel, member, permissions);
    if (missing.length) {
        throw new Error(`Missing Permissions: ${missing.join(" & ")}`);
    }
}
export function requireBotChannelPermissions(bot, channel, permissions) {
    return requireChannelPermissions(bot, channel, bot.id, permissions);
}
export function calculatePermissions(permissionBits) {
    return Object.keys(BitwisePermissionFlags).filter((permission) => {
        if (Number(permission))
            return false;
        return permissionBits &
            BigInt(BitwisePermissionFlags[permission]);
    });
}
export function calculateBits(permissions) {
    return permissions
        .reduce((bits, perm) => {
        bits |= BigInt(BitwisePermissionFlags[perm]);
        return bits;
    }, 0n)
        .toString();
}
export function requireOverwritePermissions(bot, guildOrId, overwrites) {
    let requiredPerms = new Set(["MANAGE_CHANNELS"]);
    overwrites?.forEach((overwrite) => {
        if (overwrite.allow) {
            overwrite.allow.forEach(requiredPerms.add, requiredPerms);
        }
        if (overwrite.deny) {
            overwrite.deny.forEach(requiredPerms.add, requiredPerms);
        }
    });
    if (requiredPerms.has("MANAGE_ROLES")) {
        requiredPerms = new Set(["ADMINISTRATOR"]);
    }
    requireGuildPermissions(bot, guildOrId, bot.id, [
        ...requiredPerms,
    ]);
}
export function highestRole(bot, guildOrId, memberOrId) {
    const guild = typeof guildOrId === "bigint" ? bot.guilds.get(guildOrId) : guildOrId;
    if (!guild)
        throw new Error(Errors.GUILD_NOT_FOUND);
    const memberRoles = (typeof memberOrId === "bigint" ? bot.members.get(memberOrId) : memberOrId)
        ?.roles;
    if (!memberRoles)
        return guild.roles.get(guild.id);
    let memberHighestRole;
    for (const roleId of memberRoles) {
        const role = guild.roles.get(roleId);
        if (!role)
            continue;
        if (!memberHighestRole ||
            memberHighestRole.position < role.position ||
            memberHighestRole.position === role.position) {
            memberHighestRole = role;
        }
    }
    return memberHighestRole;
}
export function higherRolePosition(bot, guildOrId, roleId, otherRoleId) {
    const guild = typeof guildOrId === "bigint" ? bot.guilds.get(guildOrId) : guildOrId;
    if (!guild)
        return true;
    const role = guild.roles.get(roleId);
    const otherRole = guild.roles.get(otherRoleId);
    if (!role || !otherRole)
        throw new Error(Errors.ROLE_NOT_FOUND);
    if (role.position === otherRole.position) {
        return role.id < otherRole.id;
    }
    return role.position > otherRole.position;
}
export function isHigherPosition(bot, guildOrId, memberId, compareRoleId) {
    const guild = typeof guildOrId === "bigint" ? bot.guilds.get(guildOrId) : guildOrId;
    if (!guild || guild.ownerId === memberId)
        return true;
    const memberHighestRole = highestRole(bot, guild, memberId);
    return higherRolePosition(bot, guild.id, memberHighestRole.id, compareRoleId);
}
export function channelOverwriteHasPermission(guildId, id, overwrites, permissions) {
    const overwrite = overwrites.find((perm) => {
        const [_, bitID] = separateOverwrites(perm);
        return id === bitID;
    }) ||
        overwrites.find((perm) => {
            const [_, bitID] = separateOverwrites(perm);
            return bitID === guildId;
        });
    if (!overwrite)
        return false;
    return permissions.every((perm) => {
        const [_type, _id, allowBits, denyBits] = separateOverwrites(overwrite);
        if (BigInt(denyBits) & BigInt(BitwisePermissionFlags[perm])) {
            return false;
        }
        if (BigInt(allowBits) & BigInt(BitwisePermissionFlags[perm])) {
            return true;
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwZXJtaXNzaW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsc0JBQXNCLEVBR3RCLE1BQU0sRUFNTixrQkFBa0IsR0FDbkIsTUFBTSxZQUFZLENBQUM7QUFHcEIsTUFBTSxVQUFVLHdCQUF3QixDQUN0QyxHQUFpQixFQUNqQixTQUF5QixFQUN6QixVQUEyQjtJQUUzQixNQUFNLEtBQUssR0FBRyxPQUFPLFNBQVMsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7SUFDcEYsTUFBTSxNQUFNLEdBQUcsT0FBTyxVQUFVLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDO0lBRXpGLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxNQUFNO1FBQUUsT0FBTyxFQUFFLENBQUM7SUFFakMsSUFBSSxXQUFXLEdBQUcsRUFBRSxDQUFDO0lBRXJCLFdBQVcsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsRUFBRSxDQUFDO1NBQ3ZDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsV0FBVyxDQUFDO1NBRTdDLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDO1NBQ3RCLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRTtRQUN0QixJQUFLLElBQUksS0FBTSxDQUFDO1FBQ2hCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLEVBQUUs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Q2YsRUFBVSxFQUNWLFVBQW9CLEVBQ3BCLFdBQWdDO0lBRWhDLE1BQU0sU0FBUyxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtRQUN6QyxNQUFNLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVDLE9BQU8sRUFBRSxLQUFLLEtBQUssQ0FBQztJQUN0QixDQUFDLENBQUM7UUFDQSxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDdkIsTUFBTSxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsR0FBRyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM1QyxPQUFPLEtBQUssS0FBSyxPQUFPLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQUM7SUFFTCxJQUFJLENBQUMsU0FBUztRQUFFLE9BQU8sS0FBSyxDQUFDO0lBRTdCLE9BQU8sV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1FBQ2hDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxRQUFRLENBQUMsR0FBRyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN4RSxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxNQUFNLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRTtZQUMzRCxPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsTUFBTSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUU7WUFDNUQsT0FBTyxJQUFJLENBQUM7U0FDYjtJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEJpdHdpc2VQZXJtaXNzaW9uRmxhZ3MsXG4gIEJvdFdpdGhDYWNoZSxcbiAgQ2hhbm5lbCxcbiAgRXJyb3JzLFxuICBHdWlsZCxcbiAgTWVtYmVyLFxuICBPdmVyd3JpdGVSZWFkYWJsZSxcbiAgUGVybWlzc2lvblN0cmluZ3MsXG4gIFJvbGUsXG4gIHNlcGFyYXRlT3ZlcndyaXRlcyxcbn0gZnJvbSBcIi4uL2RlcHMudHNcIjtcblxuLyoqIENhbGN1bGF0ZXMgdGhlIHBlcm1pc3Npb25zIHRoaXMgbWVtYmVyIGhhcyBpbiB0aGUgZ2l2ZW4gZ3VpbGQgKi9cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVCYXNlUGVybWlzc2lvbnMoXG4gIGJvdDogQm90V2l0aENhY2hlLFxuICBndWlsZE9ySWQ6IGJpZ2ludCB8IEd1aWxkLFxuICBtZW1iZXJPcklkOiBiaWdpbnQgfCBNZW1iZXIsXG4pIHtcbiAgY29uc3QgZ3VpbGQgPSB0eXBlb2YgZ3VpbGRPcklkID09PSBcImJpZ2ludFwiID8gYm90Lmd1aWxkcy5nZXQoZ3VpbGRPcklkKSA6IGd1aWxkT3JJZDtcbiAgY29uc3QgbWVtYmVyID0gdHlwZW9mIG1lbWJlck9ySWQgPT09IFwiYmlnaW50XCIgPyBib3QubWVtYmVycy5nZXQobWVtYmVyT3JJZCkgOiBtZW1iZXJPcklkO1xuXG4gIGlmICghZ3VpbGQgfHwgIW1lbWJlcikgcmV0dXJuIDhuO1xuXG4gIGxldCBwZXJtaXNzaW9ucyA9IDBuO1xuICAvLyBDYWxjdWxhdGUgdGhlIHJvbGUgcGVybWlzc2lvbnMgYml0cywgQGV2ZXJ5b25lIHJvbGUgaXMgbm90IGluIG1lbWJlclJvbGVJZHMgc28gd2UgbmVlZCB0byBwYXNzIGd1aWxkSWQgbWFudWFsbHlcbiAgcGVybWlzc2lvbnMgfD0gWy4uLm1lbWJlci5yb2xlcywgZ3VpbGQuaWRdXG4gICAgLm1hcCgoaWQpID0+IGd1aWxkLnJvbGVzLmdldChpZCk/LnBlcm1pc3Npb25zKVxuICAgIC8vIFJlbW92ZXMgYW55IGVkZ2UgY2FzZSB1bmRlZmluZWRcbiAgICAuZmlsdGVyKChwZXJtKSA9PiBwZXJtKVxuICAgIC5yZWR1Y2UoKGJpdHMsIHBlcm1zKSA9PiB7XG4gICAgICBiaXRzISB8PSBwZXJtcyE7XG4gICAgICByZXR1cm4gYml0cztcbiAgICB9LCAwbikgfHwgMG47XG5cbiAgLy8gSWYgdGhlIG1lbWJlcklkIGlzIGVxdWFsIHRvIHRoZSBndWlsZCBvd25lcklkIGhlIGF1dG9tYXRpY2FsbHkgaGFzIGV2ZXJ5IHBlcm1pc3Npb24gc28gd2UgYWRkIEFETUlOSVNUUkFUT1IgcGVybWlzc2lvblxuICBpZiAoZ3VpbGQub3duZXJJZCA9PT0gbWVtYmVyLmlkKSBwZXJtaXNzaW9ucyB8PSA4bjtcbiAgLy8gUmV0dXJuIHRoZSBtZW1iZXJzIHBlcm1pc3Npb24gYml0cyBhcyBhIHN0cmluZ1xuICByZXR1cm4gcGVybWlzc2lvbnM7XG59XG5cbi8qKiBDYWxjdWxhdGVzIHRoZSBwZXJtaXNzaW9ucyB0aGlzIG1lbWJlciBoYXMgZm9yIHRoZSBnaXZlbiBDaGFubmVsICovXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlQ2hhbm5lbE92ZXJ3cml0ZXMoXG4gIGJvdDogQm90V2l0aENhY2hlLFxuICBjaGFubmVsT3JJZDogYmlnaW50IHwgQ2hhbm5lbCxcbiAgbWVtYmVyT3JJZDogYmlnaW50IHwgTWVtYmVyLFxuKSB7XG4gIGNvbnN0IGNoYW5uZWwgPSB0eXBlb2YgY2hhbm5lbE9ySWQgPT09IFwiYmlnaW50XCIgPyBib3QuY2hhbm5lbHMuZ2V0KGNoYW5uZWxPcklkKSA6IGNoYW5uZWxPcklkO1xuXG4gIC8vIFRoaXMgaXMgYSBETSBjaGFubmVsIHNvIHJldHVybiBBRE1JTklTVFJBVE9SIHBlcm1pc3Npb25cbiAgaWYgKCFjaGFubmVsPy5ndWlsZElkKSByZXR1cm4gOG47XG5cbiAgY29uc3QgbWVtYmVyID0gdHlwZW9mIG1lbWJlck9ySWQgPT09IFwiYmlnaW50XCIgPyBib3QubWVtYmVycy5nZXQobWVtYmVyT3JJZCkgOiBtZW1iZXJPcklkO1xuXG4gIGlmICghY2hhbm5lbCB8fCAhbWVtYmVyKSByZXR1cm4gOG47XG5cbiAgLy8gR2V0IGFsbCB0aGUgcm9sZSBwZXJtaXNzaW9ucyB0aGlzIG1lbWJlciBhbHJlYWR5IGhhc1xuICBsZXQgcGVybWlzc2lvbnMgPSBjYWxjdWxhdGVCYXNlUGVybWlzc2lvbnMoXG4gICAgYm90LFxuICAgIGNoYW5uZWwuZ3VpbGRJZCxcbiAgICBtZW1iZXIsXG4gICk7XG5cbiAgLy8gRmlyc3QgY2FsY3VsYXRlIEBldmVyeW9uZSBvdmVyd3JpdGVzIHNpbmNlIHRoZXNlIGhhdmUgdGhlIGxvd2VzdCBwcmlvcml0eVxuICBjb25zdCBvdmVyd3JpdGVFdmVyeW9uZSA9IGNoYW5uZWwucGVybWlzc2lvbk92ZXJ3cml0ZXM/LmZpbmQoKG92ZXJ3cml0ZSkgPT4ge1xuICAgIGNvbnN0IFtfLCBpZF0gPSBzZXBhcmF0ZU92ZXJ3cml0ZXMob3ZlcndyaXRlKTtcbiAgICByZXR1cm4gaWQgPT09IGNoYW5uZWwuZ3VpbGRJZDtcbiAgfSk7XG4gIGlmIChvdmVyd3JpdGVFdmVyeW9uZSkge1xuICAgIGNvbnN0IFtfdHlwZSwgX2lkLCBhbGxvdywgZGVueV0gPSBzZXBhcmF0ZU92ZXJ3cml0ZXMob3ZlcndyaXRlRXZlcnlvbmUpO1xuICAgIC8vIEZpcnN0IHJlbW92ZSBkZW5pZWQgcGVybWlzc2lvbnMgc2luY2UgZGVuaWVkIDwgYWxsb3dlZFxuICAgIHBlcm1pc3Npb25zICY9IH5kZW55O1xuICAgIHBlcm1pc3Npb25zIHw9IGFsbG93O1xuICB9XG5cbiAgY29uc3Qgb3ZlcndyaXRlcyA9IGNoYW5uZWwucGVybWlzc2lvbk92ZXJ3cml0ZXM7XG5cbiAgLy8gSW4gb3JkZXIgdG8gY2FsY3VsYXRlIHRoZSByb2xlIHBlcm1pc3Npb25zIGNvcnJlY3RseSB3ZSBuZWVkIHRvIHRlbXBvcmFyaWx5IHNhdmUgdGhlIGFsbG93ZWQgYW5kIGRlbmllZCBwZXJtaXNzaW9uc1xuICBsZXQgYWxsb3cgPSAwbjtcbiAgbGV0IGRlbnkgPSAwbjtcbiAgY29uc3QgbWVtYmVyUm9sZXMgPSBtZW1iZXIucm9sZXMgfHwgW107XG4gIC8vIFNlY29uZCBjYWxjdWxhdGUgbWVtYmVycyByb2xlIG92ZXJ3cml0ZXMgc2luY2UgdGhlc2UgaGF2ZSBtaWRkbGUgcHJpb3JpdHlcbiAgZm9yIChjb25zdCBvdmVyd3JpdGUgb2Ygb3ZlcndyaXRlcyB8fCBbXSkge1xuICAgIGNvbnN0IFtfdHlwZSwgaWQsIGFsbG93Qml0cywgZGVueUJpdHNdID0gc2VwYXJhdGVPdmVyd3JpdGVzKG92ZXJ3cml0ZSk7XG5cbiAgICBpZiAoIW1lbWJlclJvbGVzLmluY2x1ZGVzKGlkKSkgY29udGludWU7XG5cbiAgICBkZW55IHw9IGRlbnlCaXRzO1xuICAgIGFsbG93IHw9IGFsbG93Qml0cztcbiAgfVxuICAvLyBBZnRlciByb2xlIG92ZXJ3cml0ZSBjYWxjdWxhdGUgc2F2ZSBhbGxvd2VkIHBlcm1pc3Npb25zIGZpcnN0IHdlIHJlbW92ZSBkZW5pZWQgcGVybWlzc2lvbnMgc2luY2UgXCJkZW5pZWQgPCBhbGxvd2VkXCJcbiAgcGVybWlzc2lvbnMgJj0gfmRlbnk7XG4gIHBlcm1pc3Npb25zIHw9IGFsbG93O1xuXG4gIC8vIFRoaXJkIGNhbGN1bGF0ZSBtZW1iZXIgc3BlY2lmaWMgb3ZlcndyaXRlcyBzaW5jZSB0aGVzZSBoYXZlIHRoZSBoaWdoZXN0IHByaW9yaXR5XG4gIGNvbnN0IG92ZXJ3cml0ZU1lbWJlciA9IG92ZXJ3cml0ZXM/LmZpbmQoKG92ZXJ3cml0ZSkgPT4ge1xuICAgIGNvbnN0IFtfLCBpZF0gPSBzZXBhcmF0ZU92ZXJ3cml0ZXMob3ZlcndyaXRlKTtcbiAgICByZXR1cm4gaWQgPT09IG1lbWJlci5pZDtcbiAgfSk7XG4gIGlmIChvdmVyd3JpdGVNZW1iZXIpIHtcbiAgICBjb25zdCBbX3R5cGUsIF9pZCwgYWxsb3dCaXRzLCBkZW55Qml0c10gPSBzZXBhcmF0ZU92ZXJ3cml0ZXMoXG4gICAgICBvdmVyd3JpdGVNZW1iZXIsXG4gICAgKTtcblxuICAgIHBlcm1pc3Npb25zICY9IH5kZW55Qml0cztcbiAgICBwZXJtaXNzaW9ucyB8PSBhbGxvd0JpdHM7XG4gIH1cblxuICByZXR1cm4gcGVybWlzc2lvbnM7XG59XG5cbi8qKiBDaGVja3MgaWYgdGhlIGdpdmVuIHBlcm1pc3Npb24gYml0cyBhcmUgbWF0Y2hpbmcgdGhlIGdpdmVuIHBlcm1pc3Npb25zLiBgQURNSU5JU1RSQVRPUmAgYWx3YXlzIHJldHVybnMgYHRydWVgICovXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVQZXJtaXNzaW9ucyhcbiAgcGVybWlzc2lvbkJpdHM6IGJpZ2ludCxcbiAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25TdHJpbmdzW10sXG4pIHtcbiAgaWYgKHBlcm1pc3Npb25CaXRzICYgOG4pIHJldHVybiB0cnVlO1xuXG4gIHJldHVybiBwZXJtaXNzaW9ucy5ldmVyeShcbiAgICAocGVybWlzc2lvbikgPT5cbiAgICAgIC8vIENoZWNrIGlmIHBlcm1pc3Npb24gaXMgaW4gcGVybWlzc2lvbkJpdHNcbiAgICAgIHBlcm1pc3Npb25CaXRzICYgQmlnSW50KEJpdHdpc2VQZXJtaXNzaW9uRmxhZ3NbcGVybWlzc2lvbl0pLFxuICApO1xufVxuXG4vKiogQ2hlY2tzIGlmIHRoZSBnaXZlbiBtZW1iZXIgaGFzIHRoZXNlIHBlcm1pc3Npb25zIGluIHRoZSBnaXZlbiBndWlsZCAqL1xuZXhwb3J0IGZ1bmN0aW9uIGhhc0d1aWxkUGVybWlzc2lvbnMoXG4gIGJvdDogQm90V2l0aENhY2hlLFxuICBndWlsZDogYmlnaW50IHwgR3VpbGQsXG4gIG1lbWJlcjogYmlnaW50IHwgTWVtYmVyLFxuICBwZXJtaXNzaW9uczogUGVybWlzc2lvblN0cmluZ3NbXSxcbikge1xuICAvLyBGaXJzdCB3ZSBuZWVkIHRoZSByb2xlIHBlcm1pc3Npb24gYml0cyB0aGlzIG1lbWJlciBoYXNcbiAgY29uc3QgYmFzZVBlcm1pc3Npb25zID0gY2FsY3VsYXRlQmFzZVBlcm1pc3Npb25zKFxuICAgIGJvdCxcbiAgICBndWlsZCxcbiAgICBtZW1iZXIsXG4gICk7XG4gIC8vIFNlY29uZCB1c2UgdGhlIHZhbGlkYXRlUGVybWlzc2lvbnMgZnVuY3Rpb24gdG8gY2hlY2sgaWYgdGhlIG1lbWJlciBoYXMgZXZlcnkgcGVybWlzc2lvblxuICByZXR1cm4gdmFsaWRhdGVQZXJtaXNzaW9ucyhiYXNlUGVybWlzc2lvbnMsIHBlcm1pc3Npb25zKTtcbn1cblxuLyoqIENoZWNrcyBpZiB0aGUgYm90IGhhcyB0aGVzZSBwZXJtaXNzaW9ucyBpbiB0aGUgZ2l2ZW4gZ3VpbGQgKi9cbmV4cG9ydCBmdW5jdGlvbiBib3RIYXNHdWlsZFBlcm1pc3Npb25zKFxuICBib3Q6IEJvdFdpdGhDYWNoZSxcbiAgZ3VpbGQ6IGJpZ2ludCB8IEd1aWxkLFxuICBwZXJtaXNzaW9uczogUGVybWlzc2lvblN0cmluZ3NbXSxcbikge1xuICAvLyBTaW5jZSBCb3QgaXMgYSBub3JtYWwgbWVtYmVyIHdlIGNhbiB1c2UgdGhlIGhhc1JvbGVQZXJtaXNzaW9ucygpIGZ1bmN0aW9uXG4gIHJldHVybiBoYXNHdWlsZFBlcm1pc3Npb25zKGJvdCwgZ3VpbGQsIGJvdC5pZCwgcGVybWlzc2lvbnMpO1xufVxuXG4vKiogQ2hlY2tzIGlmIHRoZSBnaXZlbiBtZW1iZXIgaGFzIHRoZXNlIHBlcm1pc3Npb25zIGZvciB0aGUgZ2l2ZW4gY2hhbm5lbCAqL1xuZXhwb3J0IGZ1bmN0aW9uIGhhc0NoYW5uZWxQZXJtaXNzaW9ucyhcbiAgYm90OiBCb3RXaXRoQ2FjaGUsXG4gIGNoYW5uZWw6IGJpZ2ludCB8IENoYW5uZWwsXG4gIG1lbWJlcjogYmlnaW50IHwgTWVtYmVyLFxuICBwZXJtaXNzaW9uczogUGVybWlzc2lvblN0cmluZ3NbXSxcbikge1xuICAvLyBGaXJzdCB3ZSBuZWVkIHRoZSBvdmVyd3JpdGUgYml0cyB0aGlzIG1lbWJlciBoYXNcbiAgY29uc3QgY2hhbm5lbE92ZXJ3cml0ZXMgPSBjYWxjdWxhdGVDaGFubmVsT3ZlcndyaXRlcyhcbiAgICBib3QsXG4gICAgY2hhbm5lbCxcbiAgICBtZW1iZXIsXG4gICk7XG4gIC8vIFNlY29uZCB1c2UgdGhlIHZhbGlkYXRlUGVybWlzc2lvbnMgZnVuY3Rpb24gdG8gY2hlY2sgaWYgdGhlIG1lbWJlciBoYXMgZXZlcnkgcGVybWlzc2lvblxuICByZXR1cm4gdmFsaWRhdGVQZXJtaXNzaW9ucyhjaGFubmVsT3ZlcndyaXRlcywgcGVybWlzc2lvbnMpO1xufVxuXG4vKiogQ2hlY2tzIGlmIHRoZSBib3QgaGFzIHRoZXNlIHBlcm1pc3Npb25zIGYwciB0aGUgZ2l2ZW4gY2hhbm5lbCAqL1xuZXhwb3J0IGZ1bmN0aW9uIGJvdEhhc0NoYW5uZWxQZXJtaXNzaW9ucyhcbiAgYm90OiBCb3RXaXRoQ2FjaGUsXG4gIGNoYW5uZWw6IGJpZ2ludCB8IENoYW5uZWwsXG4gIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uU3RyaW5nc1tdLFxuKSB7XG4gIC8vIFNpbmNlIEJvdCBpcyBhIG5vcm1hbCBtZW1iZXIgd2UgY2FuIHVzZSB0aGUgaGFzUm9sZVBlcm1pc3Npb25zKCkgZnVuY3Rpb25cbiAgcmV0dXJuIGhhc0NoYW5uZWxQZXJtaXNzaW9ucyhib3QsIGNoYW5uZWwsIGJvdC5pZCwgcGVybWlzc2lvbnMpO1xufVxuXG4vKiogUmV0dXJucyB0aGUgcGVybWlzc2lvbnMgdGhhdCBhcmUgbm90IGluIHRoZSBnaXZlbiBwZXJtaXNzaW9uQml0cyAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1pc3NpbmdQZXJtaXNzaW9ucyhcbiAgcGVybWlzc2lvbkJpdHM6IGJpZ2ludCxcbiAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25TdHJpbmdzW10sXG4pIHtcbiAgaWYgKHBlcm1pc3Npb25CaXRzICYgOG4pIHJldHVybiBbXTtcblxuICByZXR1cm4gcGVybWlzc2lvbnMuZmlsdGVyKChwZXJtaXNzaW9uKSA9PiAhKHBlcm1pc3Npb25CaXRzICYgQmlnSW50KEJpdHdpc2VQZXJtaXNzaW9uRmxhZ3NbcGVybWlzc2lvbl0pKSk7XG59XG5cbi8qKiBHZXQgdGhlIG1pc3NpbmcgR3VpbGQgcGVybWlzc2lvbnMgdGhpcyBtZW1iZXIgaGFzICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0TWlzc2luZ0d1aWxkUGVybWlzc2lvbnMoXG4gIGJvdDogQm90V2l0aENhY2hlLFxuICBndWlsZDogYmlnaW50IHwgR3VpbGQsXG4gIG1lbWJlcjogYmlnaW50IHwgTWVtYmVyLFxuICBwZXJtaXNzaW9uczogUGVybWlzc2lvblN0cmluZ3NbXSxcbikge1xuICAvLyBGaXJzdCB3ZSBuZWVkIHRoZSByb2xlIHBlcm1pc3Npb24gYml0cyB0aGlzIG1lbWJlciBoYXNcbiAgY29uc3QgcGVybWlzc2lvbkJpdHMgPSBjYWxjdWxhdGVCYXNlUGVybWlzc2lvbnMoXG4gICAgYm90LFxuICAgIGd1aWxkLFxuICAgIG1lbWJlcixcbiAgKTtcbiAgLy8gU2Vjb25kIHJldHVybiB0aGUgbWVtYmVycyBtaXNzaW5nIHBlcm1pc3Npb25zXG4gIHJldHVybiBtaXNzaW5nUGVybWlzc2lvbnMocGVybWlzc2lvbkJpdHMsIHBlcm1pc3Npb25zKTtcbn1cblxuLyoqIEdldCB0aGUgbWlzc2luZyBDaGFubmVsIHBlcm1pc3Npb25zIHRoaXMgbWVtYmVyIGhhcyAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldE1pc3NpbmdDaGFubmVsUGVybWlzc2lvbnMoXG4gIGJvdDogQm90V2l0aENhY2hlLFxuICBjaGFubmVsOiBiaWdpbnQgfCBDaGFubmVsLFxuICBtZW1iZXI6IGJpZ2ludCB8IE1lbWJlcixcbiAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25TdHJpbmdzW10sXG4pIHtcbiAgLy8gRmlyc3Qgd2UgbmVlZCB0aGUgcm9sZSBwZXJtaXNzaW9uIGJpdHMgdGhpcyBtZW1iZXIgaGFzXG4gIGNvbnN0IHBlcm1pc3Npb25CaXRzID0gY2FsY3VsYXRlQ2hhbm5lbE92ZXJ3cml0ZXMoXG4gICAgYm90LFxuICAgIGNoYW5uZWwsXG4gICAgbWVtYmVyLFxuICApO1xuICAvLyBTZWNvbmQgcmV0dXJuIHRoZSBtZW1iZXJzIG1pc3NpbmcgcGVybWlzc2lvbnNcbiAgcmV0dXJuIG1pc3NpbmdQZXJtaXNzaW9ucyhwZXJtaXNzaW9uQml0cywgcGVybWlzc2lvbnMpO1xufVxuXG4vKiogVGhyb3dzIGFuIGVycm9yIGlmIHRoaXMgbWVtYmVyIGhhcyBub3QgYWxsIG9mIHRoZSBnaXZlbiBwZXJtaXNzaW9ucyAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVHdWlsZFBlcm1pc3Npb25zKFxuICBib3Q6IEJvdFdpdGhDYWNoZSxcbiAgZ3VpbGQ6IGJpZ2ludCB8IEd1aWxkLFxuICBtZW1iZXI6IGJpZ2ludCB8IE1lbWJlcixcbiAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25TdHJpbmdzW10sXG4pIHtcbiAgY29uc3QgbWlzc2luZyA9IGdldE1pc3NpbmdHdWlsZFBlcm1pc3Npb25zKFxuICAgIGJvdCxcbiAgICBndWlsZCxcbiAgICBtZW1iZXIsXG4gICAgcGVybWlzc2lvbnMsXG4gICk7XG4gIGlmIChtaXNzaW5nLmxlbmd0aCkge1xuICAgIC8vIElmIHRoZSBtZW1iZXIgaXMgbWlzc2luZyBhIHBlcm1pc3Npb24gdGhyb3cgYW4gRXJyb3JcbiAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgUGVybWlzc2lvbnM6ICR7bWlzc2luZy5qb2luKFwiICYgXCIpfWApO1xuICB9XG59XG5cbi8qKiBUaHJvd3MgYW4gZXJyb3IgaWYgdGhlIGJvdCBkb2VzIG5vdCBoYXZlIGFsbCBwZXJtaXNzaW9ucyAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVCb3RHdWlsZFBlcm1pc3Npb25zKFxuICBib3Q6IEJvdFdpdGhDYWNoZSxcbiAgZ3VpbGQ6IGJpZ2ludCB8IEd1aWxkLFxuICBwZXJtaXNzaW9uczogUGVybWlzc2lvblN0cmluZ3NbXSxcbikge1xuICAvLyBTaW5jZSBCb3QgaXMgYSBub3JtYWwgbWVtYmVyIHdlIGNhbiB1c2UgdGhlIHRocm93T25NaXNzaW5nR3VpbGRQZXJtaXNzaW9uKCkgZnVuY3Rpb25cbiAgcmV0dXJuIHJlcXVpcmVHdWlsZFBlcm1pc3Npb25zKGJvdCwgZ3VpbGQsIGJvdC5pZCwgcGVybWlzc2lvbnMpO1xufVxuXG4vKiogVGhyb3dzIGFuIGVycm9yIGlmIHRoaXMgbWVtYmVyIGhhcyBub3QgYWxsIG9mIHRoZSBnaXZlbiBwZXJtaXNzaW9ucyAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVDaGFubmVsUGVybWlzc2lvbnMoXG4gIGJvdDogQm90V2l0aENhY2hlLFxuICBjaGFubmVsOiBiaWdpbnQgfCBDaGFubmVsLFxuICBtZW1iZXI6IGJpZ2ludCB8IE1lbWJlcixcbiAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25TdHJpbmdzW10sXG4pIHtcbiAgY29uc3QgbWlzc2luZyA9IGdldE1pc3NpbmdDaGFubmVsUGVybWlzc2lvbnMoXG4gICAgYm90LFxuICAgIGNoYW5uZWwsXG4gICAgbWVtYmVyLFxuICAgIHBlcm1pc3Npb25zLFxuICApO1xuICBpZiAobWlzc2luZy5sZW5ndGgpIHtcbiAgICAvLyBJZiB0aGUgbWVtYmVyIGlzIG1pc3NpbmcgYSBwZXJtaXNzaW9uIHRocm93IGFuIEVycm9yXG4gICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIFBlcm1pc3Npb25zOiAke21pc3Npbmcuam9pbihcIiAmIFwiKX1gKTtcbiAgfVxufVxuXG4vKiogVGhyb3dzIGFuIGVycm9yIGlmIHRoZSBib3QgaGFzIG5vdCBhbGwgb2YgdGhlIGdpdmVuIGNoYW5uZWwgcGVybWlzc2lvbnMgKi9cbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlQm90Q2hhbm5lbFBlcm1pc3Npb25zKFxuICBib3Q6IEJvdFdpdGhDYWNoZSxcbiAgY2hhbm5lbDogYmlnaW50IHwgQ2hhbm5lbCxcbiAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25TdHJpbmdzW10sXG4pIHtcbiAgLy8gU2luY2UgQm90IGlzIGEgbm9ybWFsIG1lbWJlciB3ZSBjYW4gdXNlIHRoZSB0aHJvd09uTWlzc2luZ0NoYW5uZWxQZXJtaXNzaW9uKCkgZnVuY3Rpb25cbiAgcmV0dXJuIHJlcXVpcmVDaGFubmVsUGVybWlzc2lvbnMoYm90LCBjaGFubmVsLCBib3QuaWQsIHBlcm1pc3Npb25zKTtcbn1cblxuLyoqIFRoaXMgZnVuY3Rpb24gY29udmVydHMgYSBiaXR3aXNlIHN0cmluZyB0byBwZXJtaXNzaW9uIHN0cmluZ3MgKi9cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVQZXJtaXNzaW9ucyhwZXJtaXNzaW9uQml0czogYmlnaW50KSB7XG4gIHJldHVybiBPYmplY3Qua2V5cyhCaXR3aXNlUGVybWlzc2lvbkZsYWdzKS5maWx0ZXIoKHBlcm1pc3Npb24pID0+IHtcbiAgICAvLyBTaW5jZSBPYmplY3Qua2V5cygpIG5vdCBvbmx5IHJldHVybnMgdGhlIHBlcm1pc3Npb24gbmFtZXMgYnV0IGFsc28gdGhlIGJpdCB2YWx1ZXMgd2UgbmVlZCB0byByZXR1cm4gZmFsc2UgaWYgaXQgaXMgYSBOdW1iZXJcbiAgICBpZiAoTnVtYmVyKHBlcm1pc3Npb24pKSByZXR1cm4gZmFsc2U7XG4gICAgLy8gQ2hlY2sgaWYgcGVybWlzc2lvbkJpdHMgaGFzIHRoaXMgcGVybWlzc2lvblxuICAgIHJldHVybiBwZXJtaXNzaW9uQml0cyAmXG4gICAgICBCaWdJbnQoQml0d2lzZVBlcm1pc3Npb25GbGFnc1twZXJtaXNzaW9uIGFzIFBlcm1pc3Npb25TdHJpbmdzXSk7XG4gIH0pIGFzIFBlcm1pc3Npb25TdHJpbmdzW107XG59XG5cbi8qKiBUaGlzIGZ1bmN0aW9uIGNvbnZlcnRzIGFuIGFycmF5IG9mIHBlcm1pc3Npb25zIGludG8gdGhlIGJpdHdpc2Ugc3RyaW5nLiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZUJpdHMocGVybWlzc2lvbnM6IFBlcm1pc3Npb25TdHJpbmdzW10pIHtcbiAgcmV0dXJuIHBlcm1pc3Npb25zXG4gICAgLnJlZHVjZSgoYml0cywgcGVybSkgPT4ge1xuICAgICAgYml0cyB8PSBCaWdJbnQoQml0d2lzZVBlcm1pc3Npb25GbGFnc1twZXJtXSk7XG4gICAgICByZXR1cm4gYml0cztcbiAgICB9LCAwbilcbiAgICAudG9TdHJpbmcoKTtcbn1cblxuLyoqIEludGVybmFsIGZ1bmN0aW9uIHRvIGNoZWNrIGlmIHRoZSBib3QgaGFzIHRoZSBwZXJtaXNzaW9ucyB0byBzZXQgdGhlc2Ugb3ZlcndyaXRlcyAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJlcXVpcmVPdmVyd3JpdGVQZXJtaXNzaW9ucyhcbiAgYm90OiBCb3RXaXRoQ2FjaGUsXG4gIGd1aWxkT3JJZDogYmlnaW50IHwgR3VpbGQsXG4gIG92ZXJ3cml0ZXM6IE92ZXJ3cml0ZVJlYWRhYmxlW10sXG4pIHtcbiAgbGV0IHJlcXVpcmVkUGVybXM6IFNldDxQZXJtaXNzaW9uU3RyaW5ncz4gPSBuZXcgU2V0KFtcIk1BTkFHRV9DSEFOTkVMU1wiXSk7XG5cbiAgb3ZlcndyaXRlcz8uZm9yRWFjaCgob3ZlcndyaXRlKSA9PiB7XG4gICAgaWYgKG92ZXJ3cml0ZS5hbGxvdykge1xuICAgICAgb3ZlcndyaXRlLmFsbG93LmZvckVhY2gocmVxdWlyZWRQZXJtcy5hZGQsIHJlcXVpcmVkUGVybXMpO1xuICAgIH1cbiAgICBpZiAob3ZlcndyaXRlLmRlbnkpIHtcbiAgICAgIG92ZXJ3cml0ZS5kZW55LmZvckVhY2gocmVxdWlyZWRQZXJtcy5hZGQsIHJlcXVpcmVkUGVybXMpO1xuICAgIH1cbiAgfSk7XG5cbiAgLy8gTUFOQUdFX1JPTEVTIHBlcm1pc3Npb24gY2FuIG9ubHkgYmUgc2V0IGJ5IGFkbWluaXN0cmF0b3JzXG4gIGlmIChyZXF1aXJlZFBlcm1zLmhhcyhcIk1BTkFHRV9ST0xFU1wiKSkge1xuICAgIHJlcXVpcmVkUGVybXMgPSBuZXcgU2V0PFBlcm1pc3Npb25TdHJpbmdzPihbXCJBRE1JTklTVFJBVE9SXCJdKTtcbiAgfVxuXG4gIHJlcXVpcmVHdWlsZFBlcm1pc3Npb25zKGJvdCwgZ3VpbGRPcklkLCBib3QuaWQsIFtcbiAgICAuLi5yZXF1aXJlZFBlcm1zLFxuICBdKTtcbn1cblxuLyoqIEdldHMgdGhlIGhpZ2hlc3Qgcm9sZSBmcm9tIHRoZSBtZW1iZXIgaW4gdGhpcyBndWlsZCAqL1xuZXhwb3J0IGZ1bmN0aW9uIGhpZ2hlc3RSb2xlKFxuICBib3Q6IEJvdFdpdGhDYWNoZSxcbiAgZ3VpbGRPcklkOiBiaWdpbnQgfCBHdWlsZCxcbiAgbWVtYmVyT3JJZDogYmlnaW50IHwgTWVtYmVyLFxuKSB7XG4gIGNvbnN0IGd1aWxkID0gdHlwZW9mIGd1aWxkT3JJZCA9PT0gXCJiaWdpbnRcIiA/IGJvdC5ndWlsZHMuZ2V0KGd1aWxkT3JJZCkgOiBndWlsZE9ySWQ7XG4gIGlmICghZ3VpbGQpIHRocm93IG5ldyBFcnJvcihFcnJvcnMuR1VJTERfTk9UX0ZPVU5EKTtcblxuICAvLyBHZXQgdGhlIHJvbGVzIGZyb20gdGhlIG1lbWJlclxuICBjb25zdCBtZW1iZXJSb2xlcyA9ICh0eXBlb2YgbWVtYmVyT3JJZCA9PT0gXCJiaWdpbnRcIiA/IGJvdC5tZW1iZXJzLmdldChtZW1iZXJPcklkKSA6IG1lbWJlck9ySWQpXG4gICAgPy5yb2xlcztcbiAgLy8gVGhpcyBtZW1iZXIgaGFzIG5vIHJvbGVzIHNvIHRoZSBoaWdoZXN0IG9uZSBpcyB0aGUgQGV2ZXJ5b25lIHJvbGVcbiAgaWYgKCFtZW1iZXJSb2xlcykgcmV0dXJuIGd1aWxkLnJvbGVzLmdldChndWlsZC5pZCkhO1xuXG4gIGxldCBtZW1iZXJIaWdoZXN0Um9sZTogUm9sZSB8IHVuZGVmaW5lZDtcblxuICBmb3IgKGNvbnN0IHJvbGVJZCBvZiBtZW1iZXJSb2xlcykge1xuICAgIGNvbnN0IHJvbGUgPSBndWlsZC5yb2xlcy5nZXQocm9sZUlkKTtcbiAgICAvLyBSYXJlIGVkZ2UgY2FzZSBoYW5kbGluZyBpZiB1bmRlZmluZWRcbiAgICBpZiAoIXJvbGUpIGNvbnRpbnVlO1xuXG4gICAgLy8gSWYgbWVtYmVySGlnaGVzdFJvbGUgaXMgc3RpbGwgdW5kZWZpbmVkIHdlIHdhbnQgdG8gYXNzaWduIHRoZSByb2xlLFxuICAgIC8vIGVsc2Ugd2Ugd2FudCB0byBjaGVjayBpZiB0aGUgY3VycmVudCByb2xlIHBvc2l0aW9uIGlzIGhpZ2hlciB0aGFuIHRoZSBjdXJyZW50IG1lbWJlckhpZ2hlc3RSb2xlXG4gICAgaWYgKFxuICAgICAgIW1lbWJlckhpZ2hlc3RSb2xlIHx8XG4gICAgICBtZW1iZXJIaWdoZXN0Um9sZS5wb3NpdGlvbiA8IHJvbGUucG9zaXRpb24gfHxcbiAgICAgIG1lbWJlckhpZ2hlc3RSb2xlLnBvc2l0aW9uID09PSByb2xlLnBvc2l0aW9uXG4gICAgKSB7XG4gICAgICBtZW1iZXJIaWdoZXN0Um9sZSA9IHJvbGU7XG4gICAgfVxuICB9XG5cbiAgLy8gVGhlIG1lbWJlciBoYXMgYXQgbGVhc3Qgb25lIHJvbGUgc28gbWVtYmVySGlnaGVzdFJvbGUgbXVzdCBleGlzdFxuICByZXR1cm4gbWVtYmVySGlnaGVzdFJvbGUhO1xufVxuXG4vKiogQ2hlY2tzIGlmIHRoZSBmaXJzdCByb2xlIGlzIGhpZ2hlciB0aGFuIHRoZSBzZWNvbmQgcm9sZSAqL1xuZXhwb3J0IGZ1bmN0aW9uIGhpZ2hlclJvbGVQb3NpdGlvbihcbiAgYm90OiBCb3RXaXRoQ2FjaGUsXG4gIGd1aWxkT3JJZDogYmlnaW50IHwgR3VpbGQsXG4gIHJvbGVJZDogYmlnaW50LFxuICBvdGhlclJvbGVJZDogYmlnaW50LFxuKSB7XG4gIGNvbnN0IGd1aWxkID0gdHlwZW9mIGd1aWxkT3JJZCA9PT0gXCJiaWdpbnRcIiA/IGJvdC5ndWlsZHMuZ2V0KGd1aWxkT3JJZCkgOiBndWlsZE9ySWQ7XG4gIGlmICghZ3VpbGQpIHJldHVybiB0cnVlO1xuXG4gIGNvbnN0IHJvbGUgPSBndWlsZC5yb2xlcy5nZXQocm9sZUlkKTtcbiAgY29uc3Qgb3RoZXJSb2xlID0gZ3VpbGQucm9sZXMuZ2V0KG90aGVyUm9sZUlkKTtcbiAgaWYgKCFyb2xlIHx8ICFvdGhlclJvbGUpIHRocm93IG5ldyBFcnJvcihFcnJvcnMuUk9MRV9OT1RfRk9VTkQpO1xuXG4gIC8vIFJhcmUgZWRnZSBjYXNlIGhhbmRsaW5nXG4gIGlmIChyb2xlLnBvc2l0aW9uID09PSBvdGhlclJvbGUucG9zaXRpb24pIHtcbiAgICByZXR1cm4gcm9sZS5pZCA8IG90aGVyUm9sZS5pZDtcbiAgfVxuXG4gIHJldHVybiByb2xlLnBvc2l0aW9uID4gb3RoZXJSb2xlLnBvc2l0aW9uO1xufVxuXG4vKiogQ2hlY2tzIGlmIHRoZSBtZW1iZXIgaGFzIGEgaGlnaGVyIHBvc2l0aW9uIHRoYW4gdGhlIGdpdmVuIHJvbGUgKi9cbmV4cG9ydCBmdW5jdGlvbiBpc0hpZ2hlclBvc2l0aW9uKFxuICBib3Q6IEJvdFdpdGhDYWNoZSxcbiAgZ3VpbGRPcklkOiBiaWdpbnQgfCBHdWlsZCxcbiAgbWVtYmVySWQ6IGJpZ2ludCxcbiAgY29tcGFyZVJvbGVJZDogYmlnaW50LFxuKSB7XG4gIGNvbnN0IGd1aWxkID0gdHlwZW9mIGd1aWxkT3JJZCA9PT0gXCJiaWdpbnRcIiA/IGJvdC5ndWlsZHMuZ2V0KGd1aWxkT3JJZCkgOiBndWlsZE9ySWQ7XG5cbiAgaWYgKCFndWlsZCB8fCBndWlsZC5vd25lcklkID09PSBtZW1iZXJJZCkgcmV0dXJuIHRydWU7XG5cbiAgY29uc3QgbWVtYmVySGlnaGVzdFJvbGUgPSBoaWdoZXN0Um9sZShib3QsIGd1aWxkLCBtZW1iZXJJZCk7XG4gIHJldHVybiBoaWdoZXJSb2xlUG9zaXRpb24oXG4gICAgYm90LFxuICAgIGd1aWxkLmlkLFxuICAgIG1lbWJlckhpZ2hlc3RSb2xlLmlkLFxuICAgIGNvbXBhcmVSb2xlSWQsXG4gICk7XG59XG5cbi8qKiBDaGVja3MgaWYgYSBjaGFubmVsIG92ZXJ3cml0ZSBmb3IgYSB1c2VyIGlkIG9yIGEgcm9sZSBpZCBoYXMgcGVybWlzc2lvbiBpbiB0aGlzIGNoYW5uZWwgKi9cbmV4cG9ydCBmdW5jdGlvbiBjaGFubmVsT3ZlcndyaXRlSGFzUGVybWlzc2lvbihcbiAgZ3VpbGRJZDogYmlnaW50LFxuICBpZDogYmlnaW50LFxuICBvdmVyd3JpdGVzOiBiaWdpbnRbXSxcbiAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25TdHJpbmdzW10sXG4pIHtcbiAgY29uc3Qgb3ZlcndyaXRlID0gb3ZlcndyaXRlcy5maW5kKChwZXJtKSA9PiB7XG4gICAgY29uc3QgW18sIGJpdElEXSA9IHNlcGFyYXRlT3ZlcndyaXRlcyhwZXJtKTtcbiAgICByZXR1cm4gaWQgPT09IGJpdElEO1xuICB9KSB8fFxuICAgIG92ZXJ3cml0ZXMuZmluZCgocGVybSkgPT4ge1xuICAgICAgY29uc3QgW18sIGJpdElEXSA9IHNlcGFyYXRlT3ZlcndyaXRlcyhwZXJtKTtcbiAgICAgIHJldHVybiBiaXRJRCA9PT0gZ3VpbGRJZDtcbiAgICB9KTtcblxuICBpZiAoIW92ZXJ3cml0ZSkgcmV0dXJuIGZhbHNlO1xuXG4gIHJldHVybiBwZXJtaXNzaW9ucy5ldmVyeSgocGVybSkgPT4ge1xuICAgIGNvbnN0IFtfdHlwZSwgX2lkLCBhbGxvd0JpdHMsIGRlbnlCaXRzXSA9IHNlcGFyYXRlT3ZlcndyaXRlcyhvdmVyd3JpdGUpO1xuICAgIGlmIChCaWdJbnQoZGVueUJpdHMpICYgQmlnSW50KEJpdHdpc2VQZXJtaXNzaW9uRmxhZ3NbcGVybV0pKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmIChCaWdJbnQoYWxsb3dCaXRzKSAmIEJpZ0ludChCaXR3aXNlUGVybWlzc2lvbkZsYWdzW3Blcm1dKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9KTtcbn1cbiJdfQ==