import { BitwisePermissionFlags, Errors, separateOverwrites } from "../deps.ts";
/** Calculates the permissions this member has in the given guild */ export function calculateBasePermissions(bot, guildOrId, memberOrId) {
    const guild = typeof guildOrId === "bigint" ? bot.guilds.get(guildOrId) : guildOrId;
    const member = typeof memberOrId === "bigint" ? bot.members.get(memberOrId) : memberOrId;
    if (!guild || !member) return 8n;
    let permissions = 0n;
    // Calculate the role permissions bits, @everyone role is not in memberRoleIds so we need to pass guildId manually
    permissions |= [
        ...member.roles,
        guild.id
    ].map((id)=>guild.roles.get(id)?.permissions
    )// Removes any edge case undefined
    .filter((perm)=>perm
    ).reduce((bits, perms)=>{
        bits |= perms;
        return bits;
    }, 0n) || 0n;
    // If the memberId is equal to the guild ownerId he automatically has every permission so we add ADMINISTRATOR permission
    if (guild.ownerId === member.id) permissions |= 8n;
    // Return the members permission bits as a string
    return permissions;
}
/** Calculates the permissions this member has for the given Channel */ export function calculateChannelOverwrites(bot, channelOrId, memberOrId) {
    const channel = typeof channelOrId === "bigint" ? bot.channels.get(channelOrId) : channelOrId;
    // This is a DM channel so return ADMINISTRATOR permission
    if (!channel?.guildId) return 8n;
    const member = typeof memberOrId === "bigint" ? bot.members.get(memberOrId) : memberOrId;
    if (!channel || !member) return 8n;
    // Get all the role permissions this member already has
    let permissions = calculateBasePermissions(bot, channel.guildId, member);
    // First calculate @everyone overwrites since these have the lowest priority
    const overwriteEveryone = channel.permissionOverwrites?.find((overwrite)=>{
        const [_, id] = separateOverwrites(overwrite);
        return id === channel.guildId;
    });
    if (overwriteEveryone) {
        const [_type, _id, allow, deny] = separateOverwrites(overwriteEveryone);
        // First remove denied permissions since denied < allowed
        permissions &= ~deny;
        permissions |= allow;
    }
    const overwrites = channel.permissionOverwrites;
    // In order to calculate the role permissions correctly we need to temporarily save the allowed and denied permissions
    let allow = 0n;
    let deny = 0n;
    const memberRoles = member.roles || [];
    // Second calculate members role overwrites since these have middle priority
    for (const overwrite1 of overwrites || []){
        const [_type, id, allowBits, denyBits] = separateOverwrites(overwrite1);
        if (!memberRoles.includes(id)) continue;
        deny |= denyBits;
        allow |= allowBits;
    }
    // After role overwrite calculate save allowed permissions first we remove denied permissions since "denied < allowed"
    permissions &= ~deny;
    permissions |= allow;
    // Third calculate member specific overwrites since these have the highest priority
    const overwriteMember = overwrites?.find((overwrite)=>{
        const [_, id] = separateOverwrites(overwrite);
        return id === member.id;
    });
    if (overwriteMember) {
        const [_type, _id, allowBits, denyBits] = separateOverwrites(overwriteMember);
        permissions &= ~denyBits;
        permissions |= allowBits;
    }
    return permissions;
}
/** Checks if the given permission bits are matching the given permissions. `ADMINISTRATOR` always returns `true` */ export function validatePermissions(permissionBits, permissions) {
    if (permissionBits & 8n) return true;
    return permissions.every((permission)=>// Check if permission is in permissionBits
        permissionBits & BigInt(BitwisePermissionFlags[permission])
    );
}
/** Checks if the given member has these permissions in the given guild */ export function hasGuildPermissions(bot, guild, member, permissions) {
    // First we need the role permission bits this member has
    const basePermissions = calculateBasePermissions(bot, guild, member);
    // Second use the validatePermissions function to check if the member has every permission
    return validatePermissions(basePermissions, permissions);
}
/** Checks if the bot has these permissions in the given guild */ export function botHasGuildPermissions(bot, guild, permissions) {
    // Since Bot is a normal member we can use the hasRolePermissions() function
    return hasGuildPermissions(bot, guild, bot.id, permissions);
}
/** Checks if the given member has these permissions for the given channel */ export function hasChannelPermissions(bot, channel, member, permissions) {
    // First we need the overwrite bits this member has
    const channelOverwrites = calculateChannelOverwrites(bot, channel, member);
    // Second use the validatePermissions function to check if the member has every permission
    return validatePermissions(channelOverwrites, permissions);
}
/** Checks if the bot has these permissions f0r the given channel */ export function botHasChannelPermissions(bot, channel, permissions) {
    // Since Bot is a normal member we can use the hasRolePermissions() function
    return hasChannelPermissions(bot, channel, bot.id, permissions);
}
/** Returns the permissions that are not in the given permissionBits */ export function missingPermissions(permissionBits, permissions) {
    if (permissionBits & 8n) return [];
    return permissions.filter((permission)=>!(permissionBits & BigInt(BitwisePermissionFlags[permission]))
    );
}
/** Get the missing Guild permissions this member has */ export function getMissingGuildPermissions(bot, guild, member, permissions) {
    // First we need the role permission bits this member has
    const permissionBits = calculateBasePermissions(bot, guild, member);
    // Second return the members missing permissions
    return missingPermissions(permissionBits, permissions);
}
/** Get the missing Channel permissions this member has */ export function getMissingChannelPermissions(bot, channel, member, permissions) {
    // First we need the role permission bits this member has
    const permissionBits = calculateChannelOverwrites(bot, channel, member);
    // Second return the members missing permissions
    return missingPermissions(permissionBits, permissions);
}
/** Throws an error if this member has not all of the given permissions */ export function requireGuildPermissions(bot, guild, member, permissions) {
    const missing = getMissingGuildPermissions(bot, guild, member, permissions);
    if (missing.length) {
        // If the member is missing a permission throw an Error
        throw new Error(`Missing Permissions: ${missing.join(" & ")}`);
    }
}
/** Throws an error if the bot does not have all permissions */ export function requireBotGuildPermissions(bot, guild, permissions) {
    // Since Bot is a normal member we can use the throwOnMissingGuildPermission() function
    return requireGuildPermissions(bot, guild, bot.id, permissions);
}
/** Throws an error if this member has not all of the given permissions */ export function requireChannelPermissions(bot, channel, member, permissions) {
    const missing = getMissingChannelPermissions(bot, channel, member, permissions);
    if (missing.length) {
        // If the member is missing a permission throw an Error
        throw new Error(`Missing Permissions: ${missing.join(" & ")}`);
    }
}
/** Throws an error if the bot has not all of the given channel permissions */ export function requireBotChannelPermissions(bot, channel, permissions) {
    // Since Bot is a normal member we can use the throwOnMissingChannelPermission() function
    return requireChannelPermissions(bot, channel, bot.id, permissions);
}
/** This function converts a bitwise string to permission strings */ export function calculatePermissions(permissionBits) {
    return Object.keys(BitwisePermissionFlags).filter((permission)=>{
        // Since Object.keys() not only returns the permission names but also the bit values we need to return false if it is a Number
        if (Number(permission)) return false;
        // Check if permissionBits has this permission
        return permissionBits & BigInt(BitwisePermissionFlags[permission]);
    });
}
/** This function converts an array of permissions into the bitwise string. */ export function calculateBits(permissions) {
    return permissions.reduce((bits, perm)=>{
        bits |= BigInt(BitwisePermissionFlags[perm]);
        return bits;
    }, 0n).toString();
}
/** Internal function to check if the bot has the permissions to set these overwrites */ export function requireOverwritePermissions(bot, guildOrId, overwrites) {
    let requiredPerms = new Set([
        "MANAGE_CHANNELS"
    ]);
    overwrites?.forEach((overwrite)=>{
        if (overwrite.allow) {
            overwrite.allow.forEach(requiredPerms.add, requiredPerms);
        }
        if (overwrite.deny) {
            overwrite.deny.forEach(requiredPerms.add, requiredPerms);
        }
    });
    // MANAGE_ROLES permission can only be set by administrators
    if (requiredPerms.has("MANAGE_ROLES")) {
        requiredPerms = new Set([
            "ADMINISTRATOR"
        ]);
    }
    requireGuildPermissions(bot, guildOrId, bot.id, [
        ...requiredPerms, 
    ]);
}
/** Gets the highest role from the member in this guild */ export function highestRole(bot, guildOrId, memberOrId) {
    const guild = typeof guildOrId === "bigint" ? bot.guilds.get(guildOrId) : guildOrId;
    if (!guild) throw new Error(Errors.GUILD_NOT_FOUND);
    // Get the roles from the member
    const memberRoles = (typeof memberOrId === "bigint" ? bot.members.get(memberOrId) : memberOrId)?.roles;
    // This member has no roles so the highest one is the @everyone role
    if (!memberRoles) return guild.roles.get(guild.id);
    let memberHighestRole;
    for (const roleId of memberRoles){
        const role = guild.roles.get(roleId);
        // Rare edge case handling if undefined
        if (!role) continue;
        // If memberHighestRole is still undefined we want to assign the role,
        // else we want to check if the current role position is higher than the current memberHighestRole
        if (!memberHighestRole || memberHighestRole.position < role.position || memberHighestRole.position === role.position) {
            memberHighestRole = role;
        }
    }
    // The member has at least one role so memberHighestRole must exist
    return memberHighestRole;
}
/** Checks if the first role is higher than the second role */ export function higherRolePosition(bot, guildOrId, roleId, otherRoleId) {
    const guild = typeof guildOrId === "bigint" ? bot.guilds.get(guildOrId) : guildOrId;
    if (!guild) return true;
    const role = guild.roles.get(roleId);
    const otherRole = guild.roles.get(otherRoleId);
    if (!role || !otherRole) throw new Error(Errors.ROLE_NOT_FOUND);
    // Rare edge case handling
    if (role.position === otherRole.position) {
        return role.id < otherRole.id;
    }
    return role.position > otherRole.position;
}
/** Checks if the member has a higher position than the given role */ export function isHigherPosition(bot, guildOrId, memberId, compareRoleId) {
    const guild = typeof guildOrId === "bigint" ? bot.guilds.get(guildOrId) : guildOrId;
    if (!guild || guild.ownerId === memberId) return true;
    const memberHighestRole = highestRole(bot, guild, memberId);
    return higherRolePosition(bot, guild.id, memberHighestRole.id, compareRoleId);
}
/** Checks if a channel overwrite for a user id or a role id has permission in this channel */ export function channelOverwriteHasPermission(guildId, id, overwrites, permissions) {
    const overwrite = overwrites.find((perm)=>{
        const [_, bitID] = separateOverwrites(perm);
        return id === bitID;
    }) || overwrites.find((perm)=>{
        const [_, bitID] = separateOverwrites(perm);
        return bitID === guildId;
    });
    if (!overwrite) return false;
    return permissions.every((perm)=>{
        const [_type, _id, allowBits, denyBits] = separateOverwrites(overwrite);
        if (BigInt(denyBits) & BigInt(BitwisePermissionFlags[perm])) {
            return false;
        }
        if (BigInt(allowBits) & BigInt(BitwisePermissionFlags[perm])) {
            return true;
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIiJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBCaXR3aXNlUGVybWlzc2lvbkZsYWdzLFxuICBCb3RXaXRoQ2FjaGUsXG4gIENoYW5uZWwsXG4gIEVycm9ycyxcbiAgR3VpbGQsXG4gIE1lbWJlcixcbiAgT3ZlcndyaXRlUmVhZGFibGUsXG4gIFBlcm1pc3Npb25TdHJpbmdzLFxuICBSb2xlLFxuICBzZXBhcmF0ZU92ZXJ3cml0ZXMsXG59IGZyb20gXCIuLi9kZXBzLnRzXCI7XG5cbi8qKiBDYWxjdWxhdGVzIHRoZSBwZXJtaXNzaW9ucyB0aGlzIG1lbWJlciBoYXMgaW4gdGhlIGdpdmVuIGd1aWxkICovXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlQmFzZVBlcm1pc3Npb25zKFxuICBib3Q6IEJvdFdpdGhDYWNoZSxcbiAgZ3VpbGRPcklkOiBiaWdpbnQgfCBHdWlsZCxcbiAgbWVtYmVyT3JJZDogYmlnaW50IHwgTWVtYmVyLFxuKSB7XG4gIGNvbnN0IGd1aWxkID0gdHlwZW9mIGd1aWxkT3JJZCA9PT0gXCJiaWdpbnRcIiA/IGJvdC5ndWlsZHMuZ2V0KGd1aWxkT3JJZCkgOiBndWlsZE9ySWQ7XG4gIGNvbnN0IG1lbWJlciA9IHR5cGVvZiBtZW1iZXJPcklkID09PSBcImJpZ2ludFwiID8gYm90Lm1lbWJlcnMuZ2V0KG1lbWJlck9ySWQpIDogbWVtYmVyT3JJZDtcblxuICBpZiAoIWd1aWxkIHx8ICFtZW1iZXIpIHJldHVybiA4bjtcblxuICBsZXQgcGVybWlzc2lvbnMgPSAwbjtcbiAgLy8gQ2FsY3VsYXRlIHRoZSByb2xlIHBlcm1pc3Npb25zIGJpdHMsIEBldmVyeW9uZSByb2xlIGlzIG5vdCBpbiBtZW1iZXJSb2xlSWRzIHNvIHdlIG5lZWQgdG8gcGFzcyBndWlsZElkIG1hbnVhbGx5XG4gIHBlcm1pc3Npb25zIHw9IFsuLi5tZW1iZXIucm9sZXMsIGd1aWxkLmlkXVxuICAgIC5tYXAoKGlkKSA9PiBndWlsZC5yb2xlcy5nZXQoaWQpPy5wZXJtaXNzaW9ucylcbiAgICAvLyBSZW1vdmVzIGFueSBlZGdlIGNhc2UgdW5kZWZpbmVkXG4gICAgLmZpbHRlcigocGVybSkgPT4gcGVybSlcbiAgICAucmVkdWNlKChiaXRzLCBwZXJtcykgPT4ge1xuICAgICAgYml0cyEgfD0gcGVybXMhO1xuICAgICAgcmV0dXJuIGJpdHM7XG4gICAgfSwgMG4pIHx8IDBuO1xuXG4gIC8vIElmIHRoZSBtZW1iZXJJZCBpcyBlcXVhbCB0byB0aGUgZ3VpbGQgb3duZXJJZCBoZSBhdXRvbWF0aWNhbGx5IGhhcyBldmVyeSBwZXJtaXNzaW9uIHNvIHdlIGFkZCBBRE1JTklTVFJBVE9SIHBlcm1pc3Npb25cbiAgaWYgKGd1aWxkLm93bmVySWQgPT09IG1lbWJlci5pZCkgcGVybWlzc2lvbnMgfD0gOG47XG4gIC8vIFJldHVybiB0aGUgbWVtYmVycyBwZXJtaXNzaW9uIGJpdHMgYXMgYSBzdHJpbmdcbiAgcmV0dXJuIHBlcm1pc3Npb25zO1xufVxuXG4vKiogQ2FsY3VsYXRlcyB0aGUgcGVybWlzc2lvbnMgdGhpcyBtZW1iZXIgaGFzIGZvciB0aGUgZ2l2ZW4gQ2hhbm5lbCAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZUNoYW5uZWxPdmVyd3JpdGVzKFxuICBib3Q6IEJvdFdpdGhDYWNoZSxcbiAgY2hhbm5lbE9ySWQ6IGJpZ2ludCB8IENoYW5uZWwsXG4gIG1lbWJlck9ySWQ6IGJpZ2ludCB8IE1lbWJlcixcbikge1xuICBjb25zdCBjaGFubmVsID0gdHlwZW9mIGNoYW5uZWxPcklkID09PSBcImJpZ2ludFwiID8gYm90LmNoYW5uZWxzLmdldChjaGFubmVsT3JJZCkgOiBjaGFubmVsT3JJZDtcblxuICAvLyBUaGlzIGlzIGEgRE0gY2hhbm5lbCBzbyByZXR1cm4gQURNSU5JU1RSQVRPUiBwZXJtaXNzaW9uXG4gIGlmICghY2hhbm5lbD8uZ3VpbGRJZCkgcmV0dXJuIDhuO1xuXG4gIGNvbnN0IG1lbWJlciA9IHR5cGVvZiBtZW1iZXJPcklkID09PSBcImJpZ2ludFwiID8gYm90Lm1lbWJlcnMuZ2V0KG1lbWJlck9ySWQpIDogbWVtYmVyT3JJZDtcblxuICBpZiAoIWNoYW5uZWwgfHwgIW1lbWJlcikgcmV0dXJuIDhuO1xuXG4gIC8vIEdldCBhbGwgdGhlIHJvbGUgcGVybWlzc2lvbnMgdGhpcyBtZW1iZXIgYWxyZWFkeSBoYXNcbiAgbGV0IHBlcm1pc3Npb25zID0gY2FsY3VsYXRlQmFzZVBlcm1pc3Npb25zKFxuICAgIGJvdCxcbiAgICBjaGFubmVsLmd1aWxkSWQsXG4gICAgbWVtYmVyLFxuICApO1xuXG4gIC8vIEZpcnN0IGNhbGN1bGF0ZSBAZXZlcnlvbmUgb3ZlcndyaXRlcyBzaW5jZSB0aGVzZSBoYXZlIHRoZSBsb3dlc3QgcHJpb3JpdHlcbiAgY29uc3Qgb3ZlcndyaXRlRXZlcnlvbmUgPSBjaGFubmVsLnBlcm1pc3Npb25PdmVyd3JpdGVzPy5maW5kKChvdmVyd3JpdGUpID0+IHtcbiAgICBjb25zdCBbXywgaWRdID0gc2VwYXJhdGVPdmVyd3JpdGVzKG92ZXJ3cml0ZSk7XG4gICAgcmV0dXJuIGlkID09PSBjaGFubmVsLmd1aWxkSWQ7XG4gIH0pO1xuICBpZiAob3ZlcndyaXRlRXZlcnlvbmUpIHtcbiAgICBjb25zdCBbX3R5cGUsIF9pZCwgYWxsb3csIGRlbnldID0gc2VwYXJhdGVPdmVyd3JpdGVzKG92ZXJ3cml0ZUV2ZXJ5b25lKTtcbiAgICAvLyBGaXJzdCByZW1vdmUgZGVuaWVkIHBlcm1pc3Npb25zIHNpbmNlIGRlbmllZCA8IGFsbG93ZWRcbiAgICBwZXJtaXNzaW9ucyAmPSB+ZGVueTtcbiAgICBwZXJtaXNzaW9ucyB8PSBhbGxvdztcbiAgfVxuXG4gIGNvbnN0IG92ZXJ3cml0ZXMgPSBjaGFubmVsLnBlcm1pc3Npb25PdmVyd3JpdGVzO1xuXG4gIC8vIEluIG9yZGVyIHRvIGNhbGN1bGF0ZSB0aGUgcm9sZSBwZXJtaXNzaW9ucyBjb3JyZWN0bHkgd2UgbmVlZCB0byB0ZW1wb3JhcmlseSBzYXZlIHRoZSBhbGxvd2VkIGFuZCBkZW5pZWQgcGVybWlzc2lvbnNcbiAgbGV0IGFsbG93ID0gMG47XG4gIGxldCBkZW55ID0gMG47XG4gIGNvbnN0IG1lbWJlclJvbGVzID0gbWVtYmVyLnJvbGVzIHx8IFtdO1xuICAvLyBTZWNvbmQgY2FsY3VsYXRlIG1lbWJlcnMgcm9sZSBvdmVyd3JpdGVzIHNpbmNlIHRoZXNlIGhhdmUgbWlkZGxlIHByaW9yaXR5XG4gIGZvciAoY29uc3Qgb3ZlcndyaXRlIG9mIG92ZXJ3cml0ZXMgfHwgW10pIHtcbiAgICBjb25zdCBbX3R5cGUsIGlkLCBhbGxvd0JpdHMsIGRlbnlCaXRzXSA9IHNlcGFyYXRlT3ZlcndyaXRlcyhvdmVyd3JpdGUpO1xuXG4gICAgaWYgKCFtZW1iZXJSb2xlcy5pbmNsdWRlcyhpZCkpIGNvbnRpbnVlO1xuXG4gICAgZGVueSB8PSBkZW55Qml0cztcbiAgICBhbGxvdyB8PSBhbGxvd0JpdHM7XG4gIH1cbiAgLy8gQWZ0ZXIgcm9sZSBvdmVyd3JpdGUgY2FsY3VsYXRlIHNhdmUgYWxsb3dlZCBwZXJtaXNzaW9ucyBmaXJzdCB3ZSByZW1vdmUgZGVuaWVkIHBlcm1pc3Npb25zIHNpbmNlIFwiZGVuaWVkIDwgYWxsb3dlZFwiXG4gIHBlcm1pc3Npb25zICY9IH5kZW55O1xuICBwZXJtaXNzaW9ucyB8PSBhbGxvdztcblxuICAvLyBUaGlyZCBjYWxjdWxhdGUgbWVtYmVyIHNwZWNpZmljIG92ZXJ3cml0ZXMgc2luY2UgdGhlc2UgaGF2ZSB0aGUgaGlnaGVzdCBwcmlvcml0eVxuICBjb25zdCBvdmVyd3JpdGVNZW1iZXIgPSBvdmVyd3JpdGVzPy5maW5kKChvdmVyd3JpdGUpID0+IHtcbiAgICBjb25zdCBbXywgaWRdID0gc2VwYXJhdGVPdmVyd3JpdGVzKG92ZXJ3cml0ZSk7XG4gICAgcmV0dXJuIGlkID09PSBtZW1iZXIuaWQ7XG4gIH0pO1xuICBpZiAob3ZlcndyaXRlTWVtYmVyKSB7XG4gICAgY29uc3QgW190eXBlLCBfaWQsIGFsbG93Qml0cywgZGVueUJpdHNdID0gc2VwYXJhdGVPdmVyd3JpdGVzKFxuICAgICAgb3ZlcndyaXRlTWVtYmVyLFxuICAgICk7XG5cbiAgICBwZXJtaXNzaW9ucyAmPSB+ZGVueUJpdHM7XG4gICAgcGVybWlzc2lvbnMgfD0gYWxsb3dCaXRzO1xuICB9XG5cbiAgcmV0dXJuIHBlcm1pc3Npb25zO1xufVxuXG4vKiogQ2hlY2tzIGlmIHRoZSBnaXZlbiBwZXJtaXNzaW9uIGJpdHMgYXJlIG1hdGNoaW5nIHRoZSBnaXZlbiBwZXJtaXNzaW9ucy4gYEFETUlOSVNUUkFUT1JgIGFsd2F5cyByZXR1cm5zIGB0cnVlYCAqL1xuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlUGVybWlzc2lvbnMoXG4gIHBlcm1pc3Npb25CaXRzOiBiaWdpbnQsXG4gIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uU3RyaW5nc1tdLFxuKSB7XG4gIGlmIChwZXJtaXNzaW9uQml0cyAmIDhuKSByZXR1cm4gdHJ1ZTtcblxuICByZXR1cm4gcGVybWlzc2lvbnMuZXZlcnkoXG4gICAgKHBlcm1pc3Npb24pID0+XG4gICAgICAvLyBDaGVjayBpZiBwZXJtaXNzaW9uIGlzIGluIHBlcm1pc3Npb25CaXRzXG4gICAgICBwZXJtaXNzaW9uQml0cyAmIEJpZ0ludChCaXR3aXNlUGVybWlzc2lvbkZsYWdzW3Blcm1pc3Npb25dKSxcbiAgKTtcbn1cblxuLyoqIENoZWNrcyBpZiB0aGUgZ2l2ZW4gbWVtYmVyIGhhcyB0aGVzZSBwZXJtaXNzaW9ucyBpbiB0aGUgZ2l2ZW4gZ3VpbGQgKi9cbmV4cG9ydCBmdW5jdGlvbiBoYXNHdWlsZFBlcm1pc3Npb25zKFxuICBib3Q6IEJvdFdpdGhDYWNoZSxcbiAgZ3VpbGQ6IGJpZ2ludCB8IEd1aWxkLFxuICBtZW1iZXI6IGJpZ2ludCB8IE1lbWJlcixcbiAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25TdHJpbmdzW10sXG4pIHtcbiAgLy8gRmlyc3Qgd2UgbmVlZCB0aGUgcm9sZSBwZXJtaXNzaW9uIGJpdHMgdGhpcyBtZW1iZXIgaGFzXG4gIGNvbnN0IGJhc2VQZXJtaXNzaW9ucyA9IGNhbGN1bGF0ZUJhc2VQZXJtaXNzaW9ucyhcbiAgICBib3QsXG4gICAgZ3VpbGQsXG4gICAgbWVtYmVyLFxuICApO1xuICAvLyBTZWNvbmQgdXNlIHRoZSB2YWxpZGF0ZVBlcm1pc3Npb25zIGZ1bmN0aW9uIHRvIGNoZWNrIGlmIHRoZSBtZW1iZXIgaGFzIGV2ZXJ5IHBlcm1pc3Npb25cbiAgcmV0dXJuIHZhbGlkYXRlUGVybWlzc2lvbnMoYmFzZVBlcm1pc3Npb25zLCBwZXJtaXNzaW9ucyk7XG59XG5cbi8qKiBDaGVja3MgaWYgdGhlIGJvdCBoYXMgdGhlc2UgcGVybWlzc2lvbnMgaW4gdGhlIGdpdmVuIGd1aWxkICovXG5leHBvcnQgZnVuY3Rpb24gYm90SGFzR3VpbGRQZXJtaXNzaW9ucyhcbiAgYm90OiBCb3RXaXRoQ2FjaGUsXG4gIGd1aWxkOiBiaWdpbnQgfCBHdWlsZCxcbiAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25TdHJpbmdzW10sXG4pIHtcbiAgLy8gU2luY2UgQm90IGlzIGEgbm9ybWFsIG1lbWJlciB3ZSBjYW4gdXNlIHRoZSBoYXNSb2xlUGVybWlzc2lvbnMoKSBmdW5jdGlvblxuICByZXR1cm4gaGFzR3VpbGRQZXJtaXNzaW9ucyhib3QsIGd1aWxkLCBib3QuaWQsIHBlcm1pc3Npb25zKTtcbn1cblxuLyoqIENoZWNrcyBpZiB0aGUgZ2l2ZW4gbWVtYmVyIGhhcyB0aGVzZSBwZXJtaXNzaW9ucyBmb3IgdGhlIGdpdmVuIGNoYW5uZWwgKi9cbmV4cG9ydCBmdW5jdGlvbiBoYXNDaGFubmVsUGVybWlzc2lvbnMoXG4gIGJvdDogQm90V2l0aENhY2hlLFxuICBjaGFubmVsOiBiaWdpbnQgfCBDaGFubmVsLFxuICBtZW1iZXI6IGJpZ2ludCB8IE1lbWJlcixcbiAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25TdHJpbmdzW10sXG4pIHtcbiAgLy8gRmlyc3Qgd2UgbmVlZCB0aGUgb3ZlcndyaXRlIGJpdHMgdGhpcyBtZW1iZXIgaGFzXG4gIGNvbnN0IGNoYW5uZWxPdmVyd3JpdGVzID0gY2FsY3VsYXRlQ2hhbm5lbE92ZXJ3cml0ZXMoXG4gICAgYm90LFxuICAgIGNoYW5uZWwsXG4gICAgbWVtYmVyLFxuICApO1xuICAvLyBTZWNvbmQgdXNlIHRoZSB2YWxpZGF0ZVBlcm1pc3Npb25zIGZ1bmN0aW9uIHRvIGNoZWNrIGlmIHRoZSBtZW1iZXIgaGFzIGV2ZXJ5IHBlcm1pc3Npb25cbiAgcmV0dXJuIHZhbGlkYXRlUGVybWlzc2lvbnMoY2hhbm5lbE92ZXJ3cml0ZXMsIHBlcm1pc3Npb25zKTtcbn1cblxuLyoqIENoZWNrcyBpZiB0aGUgYm90IGhhcyB0aGVzZSBwZXJtaXNzaW9ucyBmMHIgdGhlIGdpdmVuIGNoYW5uZWwgKi9cbmV4cG9ydCBmdW5jdGlvbiBib3RIYXNDaGFubmVsUGVybWlzc2lvbnMoXG4gIGJvdDogQm90V2l0aENhY2hlLFxuICBjaGFubmVsOiBiaWdpbnQgfCBDaGFubmVsLFxuICBwZXJtaXNzaW9uczogUGVybWlzc2lvblN0cmluZ3NbXSxcbikge1xuICAvLyBTaW5jZSBCb3QgaXMgYSBub3JtYWwgbWVtYmVyIHdlIGNhbiB1c2UgdGhlIGhhc1JvbGVQZXJtaXNzaW9ucygpIGZ1bmN0aW9uXG4gIHJldHVybiBoYXNDaGFubmVsUGVybWlzc2lvbnMoYm90LCBjaGFubmVsLCBib3QuaWQsIHBlcm1pc3Npb25zKTtcbn1cblxuLyoqIFJldHVybnMgdGhlIHBlcm1pc3Npb25zIHRoYXQgYXJlIG5vdCBpbiB0aGUgZ2l2ZW4gcGVybWlzc2lvbkJpdHMgKi9cbmV4cG9ydCBmdW5jdGlvbiBtaXNzaW5nUGVybWlzc2lvbnMoXG4gIHBlcm1pc3Npb25CaXRzOiBiaWdpbnQsXG4gIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uU3RyaW5nc1tdLFxuKSB7XG4gIGlmIChwZXJtaXNzaW9uQml0cyAmIDhuKSByZXR1cm4gW107XG5cbiAgcmV0dXJuIHBlcm1pc3Npb25zLmZpbHRlcigocGVybWlzc2lvbikgPT4gIShwZXJtaXNzaW9uQml0cyAmIEJpZ0ludChCaXR3aXNlUGVybWlzc2lvbkZsYWdzW3Blcm1pc3Npb25dKSkpO1xufVxuXG4vKiogR2V0IHRoZSBtaXNzaW5nIEd1aWxkIHBlcm1pc3Npb25zIHRoaXMgbWVtYmVyIGhhcyAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldE1pc3NpbmdHdWlsZFBlcm1pc3Npb25zKFxuICBib3Q6IEJvdFdpdGhDYWNoZSxcbiAgZ3VpbGQ6IGJpZ2ludCB8IEd1aWxkLFxuICBtZW1iZXI6IGJpZ2ludCB8IE1lbWJlcixcbiAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25TdHJpbmdzW10sXG4pIHtcbiAgLy8gRmlyc3Qgd2UgbmVlZCB0aGUgcm9sZSBwZXJtaXNzaW9uIGJpdHMgdGhpcyBtZW1iZXIgaGFzXG4gIGNvbnN0IHBlcm1pc3Npb25CaXRzID0gY2FsY3VsYXRlQmFzZVBlcm1pc3Npb25zKFxuICAgIGJvdCxcbiAgICBndWlsZCxcbiAgICBtZW1iZXIsXG4gICk7XG4gIC8vIFNlY29uZCByZXR1cm4gdGhlIG1lbWJlcnMgbWlzc2luZyBwZXJtaXNzaW9uc1xuICByZXR1cm4gbWlzc2luZ1Blcm1pc3Npb25zKHBlcm1pc3Npb25CaXRzLCBwZXJtaXNzaW9ucyk7XG59XG5cbi8qKiBHZXQgdGhlIG1pc3NpbmcgQ2hhbm5lbCBwZXJtaXNzaW9ucyB0aGlzIG1lbWJlciBoYXMgKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRNaXNzaW5nQ2hhbm5lbFBlcm1pc3Npb25zKFxuICBib3Q6IEJvdFdpdGhDYWNoZSxcbiAgY2hhbm5lbDogYmlnaW50IHwgQ2hhbm5lbCxcbiAgbWVtYmVyOiBiaWdpbnQgfCBNZW1iZXIsXG4gIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uU3RyaW5nc1tdLFxuKSB7XG4gIC8vIEZpcnN0IHdlIG5lZWQgdGhlIHJvbGUgcGVybWlzc2lvbiBiaXRzIHRoaXMgbWVtYmVyIGhhc1xuICBjb25zdCBwZXJtaXNzaW9uQml0cyA9IGNhbGN1bGF0ZUNoYW5uZWxPdmVyd3JpdGVzKFxuICAgIGJvdCxcbiAgICBjaGFubmVsLFxuICAgIG1lbWJlcixcbiAgKTtcbiAgLy8gU2Vjb25kIHJldHVybiB0aGUgbWVtYmVycyBtaXNzaW5nIHBlcm1pc3Npb25zXG4gIHJldHVybiBtaXNzaW5nUGVybWlzc2lvbnMocGVybWlzc2lvbkJpdHMsIHBlcm1pc3Npb25zKTtcbn1cblxuLyoqIFRocm93cyBhbiBlcnJvciBpZiB0aGlzIG1lbWJlciBoYXMgbm90IGFsbCBvZiB0aGUgZ2l2ZW4gcGVybWlzc2lvbnMgKi9cbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlR3VpbGRQZXJtaXNzaW9ucyhcbiAgYm90OiBCb3RXaXRoQ2FjaGUsXG4gIGd1aWxkOiBiaWdpbnQgfCBHdWlsZCxcbiAgbWVtYmVyOiBiaWdpbnQgfCBNZW1iZXIsXG4gIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uU3RyaW5nc1tdLFxuKSB7XG4gIGNvbnN0IG1pc3NpbmcgPSBnZXRNaXNzaW5nR3VpbGRQZXJtaXNzaW9ucyhcbiAgICBib3QsXG4gICAgZ3VpbGQsXG4gICAgbWVtYmVyLFxuICAgIHBlcm1pc3Npb25zLFxuICApO1xuICBpZiAobWlzc2luZy5sZW5ndGgpIHtcbiAgICAvLyBJZiB0aGUgbWVtYmVyIGlzIG1pc3NpbmcgYSBwZXJtaXNzaW9uIHRocm93IGFuIEVycm9yXG4gICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIFBlcm1pc3Npb25zOiAke21pc3Npbmcuam9pbihcIiAmIFwiKX1gKTtcbiAgfVxufVxuXG4vKiogVGhyb3dzIGFuIGVycm9yIGlmIHRoZSBib3QgZG9lcyBub3QgaGF2ZSBhbGwgcGVybWlzc2lvbnMgKi9cbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlQm90R3VpbGRQZXJtaXNzaW9ucyhcbiAgYm90OiBCb3RXaXRoQ2FjaGUsXG4gIGd1aWxkOiBiaWdpbnQgfCBHdWlsZCxcbiAgcGVybWlzc2lvbnM6IFBlcm1pc3Npb25TdHJpbmdzW10sXG4pIHtcbiAgLy8gU2luY2UgQm90IGlzIGEgbm9ybWFsIG1lbWJlciB3ZSBjYW4gdXNlIHRoZSB0aHJvd09uTWlzc2luZ0d1aWxkUGVybWlzc2lvbigpIGZ1bmN0aW9uXG4gIHJldHVybiByZXF1aXJlR3VpbGRQZXJtaXNzaW9ucyhib3QsIGd1aWxkLCBib3QuaWQsIHBlcm1pc3Npb25zKTtcbn1cblxuLyoqIFRocm93cyBhbiBlcnJvciBpZiB0aGlzIG1lbWJlciBoYXMgbm90IGFsbCBvZiB0aGUgZ2l2ZW4gcGVybWlzc2lvbnMgKi9cbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlQ2hhbm5lbFBlcm1pc3Npb25zKFxuICBib3Q6IEJvdFdpdGhDYWNoZSxcbiAgY2hhbm5lbDogYmlnaW50IHwgQ2hhbm5lbCxcbiAgbWVtYmVyOiBiaWdpbnQgfCBNZW1iZXIsXG4gIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uU3RyaW5nc1tdLFxuKSB7XG4gIGNvbnN0IG1pc3NpbmcgPSBnZXRNaXNzaW5nQ2hhbm5lbFBlcm1pc3Npb25zKFxuICAgIGJvdCxcbiAgICBjaGFubmVsLFxuICAgIG1lbWJlcixcbiAgICBwZXJtaXNzaW9ucyxcbiAgKTtcbiAgaWYgKG1pc3NpbmcubGVuZ3RoKSB7XG4gICAgLy8gSWYgdGhlIG1lbWJlciBpcyBtaXNzaW5nIGEgcGVybWlzc2lvbiB0aHJvdyBhbiBFcnJvclxuICAgIHRocm93IG5ldyBFcnJvcihgTWlzc2luZyBQZXJtaXNzaW9uczogJHttaXNzaW5nLmpvaW4oXCIgJiBcIil9YCk7XG4gIH1cbn1cblxuLyoqIFRocm93cyBhbiBlcnJvciBpZiB0aGUgYm90IGhhcyBub3QgYWxsIG9mIHRoZSBnaXZlbiBjaGFubmVsIHBlcm1pc3Npb25zICovXG5leHBvcnQgZnVuY3Rpb24gcmVxdWlyZUJvdENoYW5uZWxQZXJtaXNzaW9ucyhcbiAgYm90OiBCb3RXaXRoQ2FjaGUsXG4gIGNoYW5uZWw6IGJpZ2ludCB8IENoYW5uZWwsXG4gIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uU3RyaW5nc1tdLFxuKSB7XG4gIC8vIFNpbmNlIEJvdCBpcyBhIG5vcm1hbCBtZW1iZXIgd2UgY2FuIHVzZSB0aGUgdGhyb3dPbk1pc3NpbmdDaGFubmVsUGVybWlzc2lvbigpIGZ1bmN0aW9uXG4gIHJldHVybiByZXF1aXJlQ2hhbm5lbFBlcm1pc3Npb25zKGJvdCwgY2hhbm5lbCwgYm90LmlkLCBwZXJtaXNzaW9ucyk7XG59XG5cbi8qKiBUaGlzIGZ1bmN0aW9uIGNvbnZlcnRzIGEgYml0d2lzZSBzdHJpbmcgdG8gcGVybWlzc2lvbiBzdHJpbmdzICovXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlUGVybWlzc2lvbnMocGVybWlzc2lvbkJpdHM6IGJpZ2ludCkge1xuICByZXR1cm4gT2JqZWN0LmtleXMoQml0d2lzZVBlcm1pc3Npb25GbGFncykuZmlsdGVyKChwZXJtaXNzaW9uKSA9PiB7XG4gICAgLy8gU2luY2UgT2JqZWN0LmtleXMoKSBub3Qgb25seSByZXR1cm5zIHRoZSBwZXJtaXNzaW9uIG5hbWVzIGJ1dCBhbHNvIHRoZSBiaXQgdmFsdWVzIHdlIG5lZWQgdG8gcmV0dXJuIGZhbHNlIGlmIGl0IGlzIGEgTnVtYmVyXG4gICAgaWYgKE51bWJlcihwZXJtaXNzaW9uKSkgcmV0dXJuIGZhbHNlO1xuICAgIC8vIENoZWNrIGlmIHBlcm1pc3Npb25CaXRzIGhhcyB0aGlzIHBlcm1pc3Npb25cbiAgICByZXR1cm4gcGVybWlzc2lvbkJpdHMgJlxuICAgICAgQmlnSW50KEJpdHdpc2VQZXJtaXNzaW9uRmxhZ3NbcGVybWlzc2lvbiBhcyBQZXJtaXNzaW9uU3RyaW5nc10pO1xuICB9KSBhcyBQZXJtaXNzaW9uU3RyaW5nc1tdO1xufVxuXG4vKiogVGhpcyBmdW5jdGlvbiBjb252ZXJ0cyBhbiBhcnJheSBvZiBwZXJtaXNzaW9ucyBpbnRvIHRoZSBiaXR3aXNlIHN0cmluZy4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjYWxjdWxhdGVCaXRzKHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uU3RyaW5nc1tdKSB7XG4gIHJldHVybiBwZXJtaXNzaW9uc1xuICAgIC5yZWR1Y2UoKGJpdHMsIHBlcm0pID0+IHtcbiAgICAgIGJpdHMgfD0gQmlnSW50KEJpdHdpc2VQZXJtaXNzaW9uRmxhZ3NbcGVybV0pO1xuICAgICAgcmV0dXJuIGJpdHM7XG4gICAgfSwgMG4pXG4gICAgLnRvU3RyaW5nKCk7XG59XG5cbi8qKiBJbnRlcm5hbCBmdW5jdGlvbiB0byBjaGVjayBpZiB0aGUgYm90IGhhcyB0aGUgcGVybWlzc2lvbnMgdG8gc2V0IHRoZXNlIG92ZXJ3cml0ZXMgKi9cbmV4cG9ydCBmdW5jdGlvbiByZXF1aXJlT3ZlcndyaXRlUGVybWlzc2lvbnMoXG4gIGJvdDogQm90V2l0aENhY2hlLFxuICBndWlsZE9ySWQ6IGJpZ2ludCB8IEd1aWxkLFxuICBvdmVyd3JpdGVzOiBPdmVyd3JpdGVSZWFkYWJsZVtdLFxuKSB7XG4gIGxldCByZXF1aXJlZFBlcm1zOiBTZXQ8UGVybWlzc2lvblN0cmluZ3M+ID0gbmV3IFNldChbXCJNQU5BR0VfQ0hBTk5FTFNcIl0pO1xuXG4gIG92ZXJ3cml0ZXM/LmZvckVhY2goKG92ZXJ3cml0ZSkgPT4ge1xuICAgIGlmIChvdmVyd3JpdGUuYWxsb3cpIHtcbiAgICAgIG92ZXJ3cml0ZS5hbGxvdy5mb3JFYWNoKHJlcXVpcmVkUGVybXMuYWRkLCByZXF1aXJlZFBlcm1zKTtcbiAgICB9XG4gICAgaWYgKG92ZXJ3cml0ZS5kZW55KSB7XG4gICAgICBvdmVyd3JpdGUuZGVueS5mb3JFYWNoKHJlcXVpcmVkUGVybXMuYWRkLCByZXF1aXJlZFBlcm1zKTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIE1BTkFHRV9ST0xFUyBwZXJtaXNzaW9uIGNhbiBvbmx5IGJlIHNldCBieSBhZG1pbmlzdHJhdG9yc1xuICBpZiAocmVxdWlyZWRQZXJtcy5oYXMoXCJNQU5BR0VfUk9MRVNcIikpIHtcbiAgICByZXF1aXJlZFBlcm1zID0gbmV3IFNldDxQZXJtaXNzaW9uU3RyaW5ncz4oW1wiQURNSU5JU1RSQVRPUlwiXSk7XG4gIH1cblxuICByZXF1aXJlR3VpbGRQZXJtaXNzaW9ucyhib3QsIGd1aWxkT3JJZCwgYm90LmlkLCBbXG4gICAgLi4ucmVxdWlyZWRQZXJtcyxcbiAgXSk7XG59XG5cbi8qKiBHZXRzIHRoZSBoaWdoZXN0IHJvbGUgZnJvbSB0aGUgbWVtYmVyIGluIHRoaXMgZ3VpbGQgKi9cbmV4cG9ydCBmdW5jdGlvbiBoaWdoZXN0Um9sZShcbiAgYm90OiBCb3RXaXRoQ2FjaGUsXG4gIGd1aWxkT3JJZDogYmlnaW50IHwgR3VpbGQsXG4gIG1lbWJlck9ySWQ6IGJpZ2ludCB8IE1lbWJlcixcbikge1xuICBjb25zdCBndWlsZCA9IHR5cGVvZiBndWlsZE9ySWQgPT09IFwiYmlnaW50XCIgPyBib3QuZ3VpbGRzLmdldChndWlsZE9ySWQpIDogZ3VpbGRPcklkO1xuICBpZiAoIWd1aWxkKSB0aHJvdyBuZXcgRXJyb3IoRXJyb3JzLkdVSUxEX05PVF9GT1VORCk7XG5cbiAgLy8gR2V0IHRoZSByb2xlcyBmcm9tIHRoZSBtZW1iZXJcbiAgY29uc3QgbWVtYmVyUm9sZXMgPSAodHlwZW9mIG1lbWJlck9ySWQgPT09IFwiYmlnaW50XCIgPyBib3QubWVtYmVycy5nZXQobWVtYmVyT3JJZCkgOiBtZW1iZXJPcklkKVxuICAgID8ucm9sZXM7XG4gIC8vIFRoaXMgbWVtYmVyIGhhcyBubyByb2xlcyBzbyB0aGUgaGlnaGVzdCBvbmUgaXMgdGhlIEBldmVyeW9uZSByb2xlXG4gIGlmICghbWVtYmVyUm9sZXMpIHJldHVybiBndWlsZC5yb2xlcy5nZXQoZ3VpbGQuaWQpITtcblxuICBsZXQgbWVtYmVySGlnaGVzdFJvbGU6IFJvbGUgfCB1bmRlZmluZWQ7XG5cbiAgZm9yIChjb25zdCByb2xlSWQgb2YgbWVtYmVyUm9sZXMpIHtcbiAgICBjb25zdCByb2xlID0gZ3VpbGQucm9sZXMuZ2V0KHJvbGVJZCk7XG4gICAgLy8gUmFyZSBlZGdlIGNhc2UgaGFuZGxpbmcgaWYgdW5kZWZpbmVkXG4gICAgaWYgKCFyb2xlKSBjb250aW51ZTtcblxuICAgIC8vIElmIG1lbWJlckhpZ2hlc3RSb2xlIGlzIHN0aWxsIHVuZGVmaW5lZCB3ZSB3YW50IHRvIGFzc2lnbiB0aGUgcm9sZSxcbiAgICAvLyBlbHNlIHdlIHdhbnQgdG8gY2hlY2sgaWYgdGhlIGN1cnJlbnQgcm9sZSBwb3NpdGlvbiBpcyBoaWdoZXIgdGhhbiB0aGUgY3VycmVudCBtZW1iZXJIaWdoZXN0Um9sZVxuICAgIGlmIChcbiAgICAgICFtZW1iZXJIaWdoZXN0Um9sZSB8fFxuICAgICAgbWVtYmVySGlnaGVzdFJvbGUucG9zaXRpb24gPCByb2xlLnBvc2l0aW9uIHx8XG4gICAgICBtZW1iZXJIaWdoZXN0Um9sZS5wb3NpdGlvbiA9PT0gcm9sZS5wb3NpdGlvblxuICAgICkge1xuICAgICAgbWVtYmVySGlnaGVzdFJvbGUgPSByb2xlO1xuICAgIH1cbiAgfVxuXG4gIC8vIFRoZSBtZW1iZXIgaGFzIGF0IGxlYXN0IG9uZSByb2xlIHNvIG1lbWJlckhpZ2hlc3RSb2xlIG11c3QgZXhpc3RcbiAgcmV0dXJuIG1lbWJlckhpZ2hlc3RSb2xlITtcbn1cblxuLyoqIENoZWNrcyBpZiB0aGUgZmlyc3Qgcm9sZSBpcyBoaWdoZXIgdGhhbiB0aGUgc2Vjb25kIHJvbGUgKi9cbmV4cG9ydCBmdW5jdGlvbiBoaWdoZXJSb2xlUG9zaXRpb24oXG4gIGJvdDogQm90V2l0aENhY2hlLFxuICBndWlsZE9ySWQ6IGJpZ2ludCB8IEd1aWxkLFxuICByb2xlSWQ6IGJpZ2ludCxcbiAgb3RoZXJSb2xlSWQ6IGJpZ2ludCxcbikge1xuICBjb25zdCBndWlsZCA9IHR5cGVvZiBndWlsZE9ySWQgPT09IFwiYmlnaW50XCIgPyBib3QuZ3VpbGRzLmdldChndWlsZE9ySWQpIDogZ3VpbGRPcklkO1xuICBpZiAoIWd1aWxkKSByZXR1cm4gdHJ1ZTtcblxuICBjb25zdCByb2xlID0gZ3VpbGQucm9sZXMuZ2V0KHJvbGVJZCk7XG4gIGNvbnN0IG90aGVyUm9sZSA9IGd1aWxkLnJvbGVzLmdldChvdGhlclJvbGVJZCk7XG4gIGlmICghcm9sZSB8fCAhb3RoZXJSb2xlKSB0aHJvdyBuZXcgRXJyb3IoRXJyb3JzLlJPTEVfTk9UX0ZPVU5EKTtcblxuICAvLyBSYXJlIGVkZ2UgY2FzZSBoYW5kbGluZ1xuICBpZiAocm9sZS5wb3NpdGlvbiA9PT0gb3RoZXJSb2xlLnBvc2l0aW9uKSB7XG4gICAgcmV0dXJuIHJvbGUuaWQgPCBvdGhlclJvbGUuaWQ7XG4gIH1cblxuICByZXR1cm4gcm9sZS5wb3NpdGlvbiA+IG90aGVyUm9sZS5wb3NpdGlvbjtcbn1cblxuLyoqIENoZWNrcyBpZiB0aGUgbWVtYmVyIGhhcyBhIGhpZ2hlciBwb3NpdGlvbiB0aGFuIHRoZSBnaXZlbiByb2xlICovXG5leHBvcnQgZnVuY3Rpb24gaXNIaWdoZXJQb3NpdGlvbihcbiAgYm90OiBCb3RXaXRoQ2FjaGUsXG4gIGd1aWxkT3JJZDogYmlnaW50IHwgR3VpbGQsXG4gIG1lbWJlcklkOiBiaWdpbnQsXG4gIGNvbXBhcmVSb2xlSWQ6IGJpZ2ludCxcbikge1xuICBjb25zdCBndWlsZCA9IHR5cGVvZiBndWlsZE9ySWQgPT09IFwiYmlnaW50XCIgPyBib3QuZ3VpbGRzLmdldChndWlsZE9ySWQpIDogZ3VpbGRPcklkO1xuXG4gIGlmICghZ3VpbGQgfHwgZ3VpbGQub3duZXJJZCA9PT0gbWVtYmVySWQpIHJldHVybiB0cnVlO1xuXG4gIGNvbnN0IG1lbWJlckhpZ2hlc3RSb2xlID0gaGlnaGVzdFJvbGUoYm90LCBndWlsZCwgbWVtYmVySWQpO1xuICByZXR1cm4gaGlnaGVyUm9sZVBvc2l0aW9uKFxuICAgIGJvdCxcbiAgICBndWlsZC5pZCxcbiAgICBtZW1iZXJIaWdoZXN0Um9sZS5pZCxcbiAgICBjb21wYXJlUm9sZUlkLFxuICApO1xufVxuXG4vKiogQ2hlY2tzIGlmIGEgY2hhbm5lbCBvdmVyd3JpdGUgZm9yIGEgdXNlciBpZCBvciBhIHJvbGUgaWQgaGFzIHBlcm1pc3Npb24gaW4gdGhpcyBjaGFubmVsICovXG5leHBvcnQgZnVuY3Rpb24gY2hhbm5lbE92ZXJ3cml0ZUhhc1Blcm1pc3Npb24oXG4gIGd1aWxkSWQ6IGJpZ2ludCxcbiAgaWQ6IGJpZ2ludCxcbiAgb3ZlcndyaXRlczogYmlnaW50W10sXG4gIHBlcm1pc3Npb25zOiBQZXJtaXNzaW9uU3RyaW5nc1tdLFxuKSB7XG4gIGNvbnN0IG92ZXJ3cml0ZSA9IG92ZXJ3cml0ZXMuZmluZCgocGVybSkgPT4ge1xuICAgIGNvbnN0IFtfLCBiaXRJRF0gPSBzZXBhcmF0ZU92ZXJ3cml0ZXMocGVybSk7XG4gICAgcmV0dXJuIGlkID09PSBiaXRJRDtcbiAgfSkgfHxcbiAgICBvdmVyd3JpdGVzLmZpbmQoKHBlcm0pID0+IHtcbiAgICAgIGNvbnN0IFtfLCBiaXRJRF0gPSBzZXBhcmF0ZU92ZXJ3cml0ZXMocGVybSk7XG4gICAgICByZXR1cm4gYml0SUQgPT09IGd1aWxkSWQ7XG4gICAgfSk7XG5cbiAgaWYgKCFvdmVyd3JpdGUpIHJldHVybiBmYWxzZTtcblxuICByZXR1cm4gcGVybWlzc2lvbnMuZXZlcnkoKHBlcm0pID0+IHtcbiAgICBjb25zdCBbX3R5cGUsIF9pZCwgYWxsb3dCaXRzLCBkZW55Qml0c10gPSBzZXBhcmF0ZU92ZXJ3cml0ZXMob3ZlcndyaXRlKTtcbiAgICBpZiAoQmlnSW50KGRlbnlCaXRzKSAmIEJpZ0ludChCaXR3aXNlUGVybWlzc2lvbkZsYWdzW3Blcm1dKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBpZiAoQmlnSW50KGFsbG93Qml0cykgJiBCaWdJbnQoQml0d2lzZVBlcm1pc3Npb25GbGFnc1twZXJtXSkpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfSk7XG59XG4iXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IlNBQ0Usc0JBQXNCLEVBR3RCLE1BQU0sRUFNTixrQkFBa0IsUUFDYixZQUFZLENBQUM7QUFFcEIsb0VBQW9FLENBQ3BFLE9BQU8sU0FBUyx3QkFBd0IsQ0FDdEMsR0FBaUIsRUFDakIsU0FBeUIsRUFDekIsVUFBMkIsRUFDM0I7SUFDQSxNQUFNLEtBQUssR0FBRyxPQUFPLFNBQVMsS0FBSyxRQUFRLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsU0FBUyxBQUFDO0lBQ3BGLE1BQU0sTUFBTSxHQUFHLE9BQU8sVUFBVSxLQUFLLFFBQVEsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsR0FBRyxVQUFVLEFBQUM7SUFFekYsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsQ0FBQztJQUVqQyxJQUFJLFdBQVcsR0FBRyxFQUFFLEFBQUM7SUFDckIsa0hBQWtIO0lBQ2xILFdBQVcsSUFBSTtXQUFJLE1BQU0sQ0FBQyxLQUFLO1FBQUUsS0FBSyxDQUFDLEVBQUU7S0FBQyxDQUN2QyxHQUFHLENBQUMsQ0FBQyxFQUFFLEdBQUssS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsV0FBVztJQUFBLENBQUMsQUFDOUMsa0NBQWtDO0tBQ2pDLE1BQU0sQ0FBQyxDQUFDLElBQUksR0FBSyxJQUFJO0lBQUEsQ0FBQyxDQUN0QixNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxHQUFLO1FBQ3ZCLElBQUksSUFBSyxLQUFLLEFBQUMsQ0FBQztRQUNoQixPQUFPLElBQUksQ0FBQztLQUNiLEVBQUUsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDO0lBRWYseUhBQXlIO0lBQ3pILElBQUksS0FBSyxDQUFDLE9BQU8sS0FBSyxNQUFNLENBQUMsRUFBRSxFQUFFLFdBQVcsSUFBSSxFQUFFLENBQUM7SUFDbkQsaURBQWlEO0lBQ2pELE9BQU8sV0FBVyxDQUFDO0NBQ3BCO0FBRUQsdUVBQXVFLENBQ3ZFLE9BQU8sU0FBUywwQkFBMEIsQ0FDeEMsR0FBaUIsRUFDakIsV0FBNkIsRUFDN0IsVUFBMkIsRUFDM0I7SUFDQSxNQUFNLE9BQU8sR0FBRyxPQUFPLFdBQVcsS0FBSyxRQUFRLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEdBQUcsV0FBVyxBQUFDO0lBRTlGLDBEQUEwRDtJQUMxRCxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsQ0FBQztJQUVqQyxNQUFNLE1BQU0sR0FBRyxPQUFPLFVBQVUsS0FBSyxRQUFRLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEdBQUcsVUFBVSxBQUFDO0lBRXpGLElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLENBQUM7SUFFbkMsdURBQXVEO0lBQ3ZELElBQUksV0FBVyxHQUFHLHdCQUF3QixDQUN4QyxHQUFHLEVBQ0gsT0FBTyxDQUFDLE9BQU8sRUFDZixNQUFNLENBQ1AsQUFBQztJQUVGLDRFQUE0RTtJQUM1RSxNQUFNLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxvQkFBb0IsRUFBRSxJQUFJLENBQUMsQ0FBQyxTQUFTLEdBQUs7UUFDMUUsTUFBTSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsQUFBQztRQUM5QyxPQUFPLEVBQUUsS0FBSyxPQUFPLENBQUMsT0FBTyxDQUFDO0tBQy9CLENBQUMsQUFBQztJQUNILElBQUksaUJBQWlCLEVBQUU7UUFDckIsTUFBTSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLGtCQUFrQixDQUFDLGlCQUFpQixDQUFDLEFBQUM7UUFDeEUseURBQXlEO1FBQ3pELFdBQVcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNyQixXQUFXLElBQUksS0FBSyxDQUFDO0tBQ3RCO0lBRUQsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLG9CQUFvQixBQUFDO0lBRWhELHNIQUFzSDtJQUN0SCxJQUFJLEtBQUssR0FBRyxFQUFFLEFBQUM7SUFDZixJQUFJLElBQUksR0FBRyxFQUFFLEFBQUM7SUFDZCxNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsS0FBSyxJQUFJLEVBQUUsQUFBQztJQUN2Qyw0RUFBNEU7SUFDNUUsS0FBSyxNQUFNLFVBQVMsSUFBSSxVQUFVLElBQUksRUFBRSxDQUFFO1FBQ3hDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxRQUFRLENBQUMsR0FBRyxrQkFBa0IsQ0FBQyxVQUFTLENBQUMsQUFBQztRQUV2RSxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRSxTQUFTO1FBRXhDLElBQUksSUFBSSxRQUFRLENBQUM7UUFDakIsS0FBSyxJQUFJLFNBQVMsQ0FBQztLQUNwQjtJQUNELHNIQUFzSDtJQUN0SCxXQUFXLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDckIsV0FBVyxJQUFJLEtBQUssQ0FBQztJQUVyQixtRkFBbUY7SUFDbkYsTUFBTSxlQUFlLEdBQUcsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDLFNBQVMsR0FBSztRQUN0RCxNQUFNLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxHQUFHLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxBQUFDO1FBQzlDLE9BQU8sRUFBRSxLQUFLLE1BQU0sQ0FBQyxFQUFFLENBQUM7S0FDekIsQ0FBQyxBQUFDO0lBQ0gsSUFBSSxlQUFlLEVBQUU7UUFDbkIsTUFBTSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFFBQVEsQ0FBQyxHQUFHLGtCQUFrQixDQUMxRCxlQUFlLENBQ2hCLEFBQUM7UUFFRixXQUFXLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDekIsV0FBVyxJQUFJLFNBQVMsQ0FBQztLQUMxQjtJQUVELE9BQU8sV0FBVyxDQUFDO0NBQ3BCO0FBRUQsb0hBQW9ILENBQ3BILE9BQU8sU0FBUyxtQkFBbUIsQ0FDakMsY0FBc0IsRUFDdEIsV0FBZ0MsRUFDaEM7SUFDQSxJQUFJLGNBQWMsR0FBRyxFQUFFLEVBQUUsT0FBTyxJQUFJLENBQUM7SUFFckMsT0FBTyxXQUFXLENBQUMsS0FBSyxDQUN0QixDQUFDLFVBQVUsR0FDVCwyQ0FBMkM7UUFDM0MsY0FBYyxHQUFHLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUFBLENBQzlELENBQUM7Q0FDSDtBQUVELDBFQUEwRSxDQUMxRSxPQUFPLFNBQVMsbUJBQW1CLENBQ2pDLEdBQWlCLEVBQ2pCLEtBQXFCLEVBQ3JCLE1BQXVCLEVBQ3ZCLFdBQWdDLEVBQ2hDO0lBQ0EseURBQXlEO0lBQ3pELE1BQU0sZUFBZSxHQUFHLHdCQUF3QixDQUM5QyxHQUFHLEVBQ0gsS0FBSyxFQUNMLE1BQU0sQ0FDUCxBQUFDO0lBQ0YsMEZBQTBGO0lBQzFGLE9BQU8sbUJBQW1CLENBQUMsZUFBZSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0NBQzFEO0FBRUQsaUVBQWlFLENBQ2pFLE9BQU8sU0FBUyxzQkFBc0IsQ0FDcEMsR0FBaUIsRUFDakIsS0FBcUIsRUFDckIsV0FBZ0MsRUFDaEM7SUFDQSw0RUFBNEU7SUFDNUUsT0FBTyxtQkFBbUIsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEVBQUUsV0FBVyxDQUFDLENBQUM7Q0FDN0Q7QUFFRCw2RUFBNkUsQ0FDN0UsT0FBTyxTQUFTLHFCQUFxQixDQUNuQyxHQUFpQixFQUNqQixPQUF5QixFQUN6QixNQUF1QixFQUN2QixXQUFnQyxFQUNoQztJQUNBLG1EQUFtRDtJQUNuRCxNQUFNLGlCQUFpQixHQUFHLDBCQUEwQixDQUNsRCxHQUFHLEVBQ0gsT0FBTyxFQUNQLE1BQU0sQ0FDUCxBQUFDO0lBQ0YsMEZBQTBGO0lBQzFGLE9BQU8sbUJBQW1CLENBQUMsaUJBQWlCLEVBQUUsV0FBVyxDQUFDLENBQUM7Q0FDNUQ7QUFFRCxvRUFBb0UsQ0FDcEUsT0FBTyxTQUFTLHdCQUF3QixDQUN0QyxHQUFpQixFQUNqQixPQUF5QixFQUN6QixXQUFnQyxFQUNoQztJQUNBLDRFQUE0RTtJQUM1RSxPQUFPLHFCQUFxQixDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsR0FBRyxDQUFDLEVBQUUsRUFBRSxXQUFXLENBQUMsQ0FBQztDQUNqRTtBQUVELHVFQUF1RSxDQUN2RSxPQUFPLFNBQVMsa0JBQWtCLENBQ2hDLGNBQXNCLEVBQ3RCLFdBQWdDLEVBQ2hDO0lBQ0EsSUFBSSxjQUFjLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSxDQUFDO0lBRW5DLE9BQU8sV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFVBQVUsR0FBSyxDQUFDLENBQUMsY0FBYyxHQUFHLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQUEsQ0FBQyxDQUFDO0NBQzNHO0FBRUQsd0RBQXdELENBQ3hELE9BQU8sU0FBUywwQkFBMEIsQ0FDeEMsR0FBaUIsRUFDakIsS0FBcUIsRUFDckIsTUFBdUIsRUFDdkIsV0FBZ0MsRUFDaEM7SUFDQSx5REFBeUQ7SUFDekQsTUFBTSxjQUFjLEdBQUcsd0JBQXdCLENBQzdDLEdBQUcsRUFDSCxLQUFLLEVBQ0wsTUFBTSxDQUNQLEFBQUM7SUFDRixnREFBZ0Q7SUFDaEQsT0FBTyxrQkFBa0IsQ0FBQyxjQUFjLEVBQUUsV0FBVyxDQUFDLENBQUM7Q0FDeEQ7QUFFRCwwREFBMEQsQ0FDMUQsT0FBTyxTQUFTLDRCQUE0QixDQUMxQyxHQUFpQixFQUNqQixPQUF5QixFQUN6QixNQUF1QixFQUN2QixXQUFnQyxFQUNoQztJQUNBLHlEQUF5RDtJQUN6RCxNQUFNLGNBQWMsR0FBRywwQkFBMEIsQ0FDL0MsR0FBRyxFQUNILE9BQU8sRUFDUCxNQUFNLENBQ1AsQUFBQztJQUNGLGdEQUFnRDtJQUNoRCxPQUFPLGtCQUFrQixDQUFDLGNBQWMsRUFBRSxXQUFXLENBQUMsQ0FBQztDQUN4RDtBQUVELDBFQUEwRSxDQUMxRSxPQUFPLFNBQVMsdUJBQXVCLENBQ3JDLEdBQWlCLEVBQ2pCLEtBQXFCLEVBQ3JCLE1BQXVCLEVBQ3ZCLFdBQWdDLEVBQ2hDO0lBQ0EsTUFBTSxPQUFPLEdBQUcsMEJBQTBCLENBQ3hDLEdBQUcsRUFDSCxLQUFLLEVBQ0wsTUFBTSxFQUNOLFdBQVcsQ0FDWixBQUFDO0lBQ0YsSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFO1FBQ2xCLHVEQUF1RDtRQUN2RCxNQUFNLElBQUksS0FBSyxDQUFDLENBQUMscUJBQXFCLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNoRTtDQUNGO0FBRUQsK0RBQStELENBQy9ELE9BQU8sU0FBUywwQkFBMEIsQ0FDeEMsR0FBaUIsRUFDakIsS0FBcUIsRUFDckIsV0FBZ0MsRUFDaEM7SUFDQSx1RkFBdUY7SUFDdkYsT0FBTyx1QkFBdUIsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEVBQUUsV0FBVyxDQUFDLENBQUM7Q0FDakU7QUFFRCwwRUFBMEUsQ0FDMUUsT0FBTyxTQUFTLHlCQUF5QixDQUN2QyxHQUFpQixFQUNqQixPQUF5QixFQUN6QixNQUF1QixFQUN2QixXQUFnQyxFQUNoQztJQUNBLE1BQU0sT0FBTyxHQUFHLDRCQUE0QixDQUMxQyxHQUFHLEVBQ0gsT0FBTyxFQUNQLE1BQU0sRUFDTixXQUFXLENBQ1osQUFBQztJQUNGLElBQUksT0FBTyxDQUFDLE1BQU0sRUFBRTtRQUNsQix1REFBdUQ7UUFDdkQsTUFBTSxJQUFJLEtBQUssQ0FBQyxDQUFDLHFCQUFxQixFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDaEU7Q0FDRjtBQUVELDhFQUE4RSxDQUM5RSxPQUFPLFNBQVMsNEJBQTRCLENBQzFDLEdBQWlCLEVBQ2pCLE9BQXlCLEVBQ3pCLFdBQWdDLEVBQ2hDO0lBQ0EseUZBQXlGO0lBQ3pGLE9BQU8seUJBQXlCLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxHQUFHLENBQUMsRUFBRSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0NBQ3JFO0FBRUQsb0VBQW9FLENBQ3BFLE9BQU8sU0FBUyxvQkFBb0IsQ0FBQyxjQUFzQixFQUFFO0lBQzNELE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLFVBQVUsR0FBSztRQUNoRSw4SEFBOEg7UUFDOUgsSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQUUsT0FBTyxLQUFLLENBQUM7UUFDckMsOENBQThDO1FBQzlDLE9BQU8sY0FBYyxHQUNuQixNQUFNLENBQUMsc0JBQXNCLENBQUMsVUFBVSxDQUFzQixDQUFDLENBQUM7S0FDbkUsQ0FBQyxDQUF3QjtDQUMzQjtBQUVELDhFQUE4RSxDQUM5RSxPQUFPLFNBQVMsYUFBYSxDQUFDLFdBQWdDLEVBQUU7SUFDOUQsT0FBTyxXQUFXLENBQ2YsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksR0FBSztRQUN0QixJQUFJLElBQUksTUFBTSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDN0MsT0FBTyxJQUFJLENBQUM7S0FDYixFQUFFLEVBQUUsQ0FBQyxDQUNMLFFBQVEsRUFBRSxDQUFDO0NBQ2Y7QUFFRCx3RkFBd0YsQ0FDeEYsT0FBTyxTQUFTLDJCQUEyQixDQUN6QyxHQUFpQixFQUNqQixTQUF5QixFQUN6QixVQUErQixFQUMvQjtJQUNBLElBQUksYUFBYSxHQUEyQixJQUFJLEdBQUcsQ0FBQztRQUFDLGlCQUFpQjtLQUFDLENBQUMsQUFBQztJQUV6RSxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUMsU0FBUyxHQUFLO1FBQ2pDLElBQUksU0FBUyxDQUFDLEtBQUssRUFBRTtZQUNuQixTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1NBQzNEO1FBQ0QsSUFBSSxTQUFTLENBQUMsSUFBSSxFQUFFO1lBQ2xCLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsYUFBYSxDQUFDLENBQUM7U0FDMUQ7S0FDRixDQUFDLENBQUM7SUFFSCw0REFBNEQ7SUFDNUQsSUFBSSxhQUFhLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxFQUFFO1FBQ3JDLGFBQWEsR0FBRyxJQUFJLEdBQUcsQ0FBb0I7WUFBQyxlQUFlO1NBQUMsQ0FBQyxDQUFDO0tBQy9EO0lBRUQsdUJBQXVCLENBQUMsR0FBRyxFQUFFLFNBQVMsRUFBRSxHQUFHLENBQUMsRUFBRSxFQUFFO1dBQzNDLGFBQWE7S0FDakIsQ0FBQyxDQUFDO0NBQ0o7QUFFRCwwREFBMEQsQ0FDMUQsT0FBTyxTQUFTLFdBQVcsQ0FDekIsR0FBaUIsRUFDakIsU0FBeUIsRUFDekIsVUFBMkIsRUFDM0I7SUFDQSxNQUFNLEtBQUssR0FBRyxPQUFPLFNBQVMsS0FBSyxRQUFRLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEdBQUcsU0FBUyxBQUFDO0lBQ3BGLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7SUFFcEQsZ0NBQWdDO0lBQ2hDLE1BQU0sV0FBVyxHQUFHLENBQUMsT0FBTyxVQUFVLEtBQUssUUFBUSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxFQUMzRixLQUFLLEFBQUM7SUFDVixvRUFBb0U7SUFDcEUsSUFBSSxDQUFDLFdBQVcsRUFBRSxPQUFPLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBRTtJQUVwRCxJQUFJLGlCQUFpQixBQUFrQixBQUFDO0lBRXhDLEtBQUssTUFBTSxNQUFNLElBQUksV0FBVyxDQUFFO1FBQ2hDLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxBQUFDO1FBQ3JDLHVDQUF1QztRQUN2QyxJQUFJLENBQUMsSUFBSSxFQUFFLFNBQVM7UUFFcEIsc0VBQXNFO1FBQ3RFLGtHQUFrRztRQUNsRyxJQUNFLENBQUMsaUJBQWlCLElBQ2xCLGlCQUFpQixDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxJQUMxQyxpQkFBaUIsQ0FBQyxRQUFRLEtBQUssSUFBSSxDQUFDLFFBQVEsRUFDNUM7WUFDQSxpQkFBaUIsR0FBRyxJQUFJLENBQUM7U0FDMUI7S0FDRjtJQUVELG1FQUFtRTtJQUNuRSxPQUFPLGlCQUFpQixDQUFFO0NBQzNCO0FBRUQsOERBQThELENBQzlELE9BQU8sU0FBUyxrQkFBa0IsQ0FDaEMsR0FBaUIsRUFDakIsU0FBeUIsRUFDekIsTUFBYyxFQUNkLFdBQW1CLEVBQ25CO0lBQ0EsTUFBTSxLQUFLLEdBQUcsT0FBTyxTQUFTLEtBQUssUUFBUSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLFNBQVMsQUFBQztJQUNwRixJQUFJLENBQUMsS0FBSyxFQUFFLE9BQU8sSUFBSSxDQUFDO0lBRXhCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxBQUFDO0lBQ3JDLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxBQUFDO0lBQy9DLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUM7SUFFaEUsMEJBQTBCO0lBQzFCLElBQUksSUFBSSxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUMsUUFBUSxFQUFFO1FBQ3hDLE9BQU8sSUFBSSxDQUFDLEVBQUUsR0FBRyxTQUFTLENBQUMsRUFBRSxDQUFDO0tBQy9CO0lBRUQsT0FBTyxJQUFJLENBQUMsUUFBUSxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUM7Q0FDM0M7QUFFRCxxRUFBcUUsQ0FDckUsT0FBTyxTQUFTLGdCQUFnQixDQUM5QixHQUFpQixFQUNqQixTQUF5QixFQUN6QixRQUFnQixFQUNoQixhQUFxQixFQUNyQjtJQUNBLE1BQU0sS0FBSyxHQUFHLE9BQU8sU0FBUyxLQUFLLFFBQVEsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxTQUFTLEFBQUM7SUFFcEYsSUFBSSxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsT0FBTyxLQUFLLFFBQVEsRUFBRSxPQUFPLElBQUksQ0FBQztJQUV0RCxNQUFNLGlCQUFpQixHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLFFBQVEsQ0FBQyxBQUFDO0lBQzVELE9BQU8sa0JBQWtCLENBQ3ZCLEdBQUcsRUFDSCxLQUFLLENBQUMsRUFBRSxFQUNSLGlCQUFpQixDQUFDLEVBQUUsRUFDcEIsYUFBYSxDQUNkLENBQUM7Q0FDSDtBQUVELDhGQUE4RixDQUM5RixPQUFPLFNBQVMsNkJBQTZCLENBQzNDLE9BQWUsRUFDZixFQUFVLEVBQ1YsVUFBb0IsRUFDcEIsV0FBZ0MsRUFDaEM7SUFDQSxNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxHQUFLO1FBQzFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLEdBQUcsa0JBQWtCLENBQUMsSUFBSSxDQUFDLEFBQUM7UUFDNUMsT0FBTyxFQUFFLEtBQUssS0FBSyxDQUFDO0tBQ3JCLENBQUMsSUFDQSxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxHQUFLO1FBQ3hCLE1BQU0sQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLEdBQUcsa0JBQWtCLENBQUMsSUFBSSxDQUFDLEFBQUM7UUFDNUMsT0FBTyxLQUFLLEtBQUssT0FBTyxDQUFDO0tBQzFCLENBQUMsQUFBQztJQUVMLElBQUksQ0FBQyxTQUFTLEVBQUUsT0FBTyxLQUFLLENBQUM7SUFFN0IsT0FBTyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxHQUFLO1FBQ2pDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxRQUFRLENBQUMsR0FBRyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsQUFBQztRQUN4RSxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxNQUFNLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRTtZQUMzRCxPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsTUFBTSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUU7WUFDNUQsT0FBTyxJQUFJLENBQUM7U0FDYjtLQUNGLENBQUMsQ0FBQztDQUNKIn0=